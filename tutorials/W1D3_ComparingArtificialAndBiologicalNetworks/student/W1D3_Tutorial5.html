
<!DOCTYPE html>

<html lang="en">
<head>
<meta charset="utf-8"/>
<meta content="width=device-width, initial-scale=1.0" name="viewport"/><meta content="Docutils 0.18.1: http://docutils.sourceforge.net/" name="generator"/>
<title>Tutorial 5: Dynamical Similarity Analysis (DSA) â€” Neuromatch Academy: NeuroAI</title>
<script data-cfasync="false">
    document.documentElement.dataset.mode = localStorage.getItem("mode") || "";
    document.documentElement.dataset.theme = localStorage.getItem("theme") || "light";
  </script>
<!-- Loaded before other Sphinx assets -->
<link href="../../../_static/styles/theme.css?digest=796348d33e8b1d947c94" rel="stylesheet"/>
<link href="../../../_static/styles/bootstrap.css?digest=796348d33e8b1d947c94" rel="stylesheet"/>
<link href="../../../_static/styles/pydata-sphinx-theme.css?digest=796348d33e8b1d947c94" rel="stylesheet"/>
<link href="../../../_static/vendor/fontawesome/6.1.2/css/all.min.css?digest=796348d33e8b1d947c94" rel="stylesheet"/>
<link as="font" crossorigin="" href="../../../_static/vendor/fontawesome/6.1.2/webfonts/fa-solid-900.woff2" rel="preload" type="font/woff2"/>
<link as="font" crossorigin="" href="../../../_static/vendor/fontawesome/6.1.2/webfonts/fa-brands-400.woff2" rel="preload" type="font/woff2"/>
<link as="font" crossorigin="" href="../../../_static/vendor/fontawesome/6.1.2/webfonts/fa-regular-400.woff2" rel="preload" type="font/woff2"/>
<link href="../../../_static/pygments.css" rel="stylesheet" type="text/css">
<link href="../../../_static/styles/sphinx-book-theme.css?digest=4ec06e9971c5264fbd345897d5258098f11cc577" rel="stylesheet" type="text/css">
<link href="../../../_static/togglebutton.css" rel="stylesheet" type="text/css">
<link href="../../../_static/copybutton.css" rel="stylesheet" type="text/css">
<link href="../../../_static/mystnb.4510f1fc1dee50b3e5859aac5469c37c29e427902b24a333a5f9fcb2f0b3ac41.css" rel="stylesheet" type="text/css">
<link href="../../../_static/sphinx-thebe.css" rel="stylesheet" type="text/css">
<link href="../../../_static/custom.css" rel="stylesheet" type="text/css">
<link href="../../../_static/design-style.4045f2051d55cab465a707391d5b2007.min.css" rel="stylesheet" type="text/css"/>
<!-- Pre-loaded scripts that we'll load fully later -->
<link as="script" href="../../../_static/scripts/bootstrap.js?digest=796348d33e8b1d947c94" rel="preload"/>
<link as="script" href="../../../_static/scripts/pydata-sphinx-theme.js?digest=796348d33e8b1d947c94" rel="preload"/>
<script data-url_root="../../../" id="documentation_options" src="../../../_static/documentation_options.js"></script>
<script src="../../../_static/jquery.js"></script>
<script src="../../../_static/underscore.js"></script>
<script src="../../../_static/_sphinx_javascript_frameworks_compat.js"></script>
<script src="../../../_static/doctools.js"></script>
<script src="../../../_static/clipboard.min.js"></script>
<script src="../../../_static/copybutton.js"></script>
<script src="../../../_static/scripts/sphinx-book-theme.js?digest=8bf782fb4ee92b3d3646425e50f299c4e1fd152d"></script>
<script>let toggleHintShow = 'Click to show';</script>
<script>let toggleHintHide = 'Click to hide';</script>
<script>let toggleOpenOnPrint = 'true';</script>
<script src="../../../_static/togglebutton.js"></script>
<script>var togglebuttonSelector = '.toggle, .admonition.dropdown';</script>
<script src="../../../_static/design-tabs.js"></script>
<script>const THEBE_JS_URL = "https://unpkg.com/thebe@0.8.2/lib/index.js"
const thebe_selector = ".thebe,.cell"
const thebe_selector_input = "pre"
const thebe_selector_output = ".output, .cell_output"
</script>
<script async="async" src="../../../_static/sphinx-thebe.js"></script>
<script type="application/vnd.jupyter.widget-state+json">{"state": {"50db26c471f345fd9995329dfbd6ee71": {"model_name": "LayoutModel", "model_module": "@jupyter-widgets/base", "model_module_version": "2.0.0", "state": {"_model_module": "@jupyter-widgets/base", "_model_module_version": "2.0.0", "_model_name": "LayoutModel", "_view_count": null, "_view_module": "@jupyter-widgets/base", "_view_module_version": "2.0.0", "_view_name": "LayoutView", "align_content": null, "align_items": null, "align_self": null, "border_bottom": null, "border_left": null, "border_right": null, "border_top": null, "bottom": null, "display": null, "flex": null, "flex_flow": null, "grid_area": null, "grid_auto_columns": null, "grid_auto_flow": null, "grid_auto_rows": null, "grid_column": null, "grid_gap": null, "grid_row": null, "grid_template_areas": null, "grid_template_columns": null, "grid_template_rows": null, "height": null, "justify_content": null, "justify_items": null, "left": null, "margin": null, "max_height": null, "max_width": null, "min_height": null, "min_width": null, "object_fit": null, "object_position": null, "order": null, "overflow": null, "padding": null, "right": null, "top": null, "visibility": null, "width": null}}, "a0c3ed71d94e4ed4848fa9179cebd00d": {"model_name": "OutputModel", "model_module": "@jupyter-widgets/output", "model_module_version": "1.0.0", "state": {"_dom_classes": [], "_model_module": "@jupyter-widgets/output", "_model_module_version": "1.0.0", "_model_name": "OutputModel", "_view_count": null, "_view_module": "@jupyter-widgets/output", "_view_module_version": "1.0.0", "_view_name": "OutputView", "layout": "IPY_MODEL_50db26c471f345fd9995329dfbd6ee71", "msg_id": "", "outputs": [{"output_type": "stream", "name": "stdout", "text": "If you want to download the slides: https://osf.io/download/8fx23/\n"}, {"output_type": "display_data", "metadata": {}, "data": {"text/plain": "<IPython.lib.display.IFrame at 0x7fa07e9791f0>", "text/html": "\n        <iframe\n            width=\"730\"\n            height=\"410\"\n            src=\"https://mfr.ca-1.osf.io/render?url=https://osf.io/8fx23/?direct%26mode=render%26action=download%26mode=render\"\n            frameborder=\"0\"\n            allowfullscreen\n            \n        ></iframe>\n        "}}], "tabbable": null, "tooltip": null}}, "59b1e2c4d2904aa0975bb992a4411767": {"model_name": "LayoutModel", "model_module": "@jupyter-widgets/base", "model_module_version": "2.0.0", "state": {"_model_module": "@jupyter-widgets/base", "_model_module_version": "2.0.0", "_model_name": "LayoutModel", "_view_count": null, "_view_module": "@jupyter-widgets/base", "_view_module_version": "2.0.0", "_view_name": "LayoutView", "align_content": null, "align_items": null, "align_self": null, "border_bottom": null, "border_left": null, "border_right": null, "border_top": null, "bottom": null, "display": null, "flex": null, "flex_flow": null, "grid_area": null, "grid_auto_columns": null, "grid_auto_flow": null, "grid_auto_rows": null, "grid_column": null, "grid_gap": null, "grid_row": null, "grid_template_areas": null, "grid_template_columns": null, "grid_template_rows": null, "height": null, "justify_content": null, "justify_items": null, "left": null, "margin": null, "max_height": null, "max_width": null, "min_height": null, "min_width": null, "object_fit": null, "object_position": null, "order": null, "overflow": null, "padding": null, "right": null, "top": null, "visibility": null, "width": null}}, "234221900b7748d6b2337ddc27b0d259": {"model_name": "OutputModel", "model_module": "@jupyter-widgets/output", "model_module_version": "1.0.0", "state": {"_dom_classes": [], "_model_module": "@jupyter-widgets/output", "_model_module_version": "1.0.0", "_model_name": "OutputModel", "_view_count": null, "_view_module": "@jupyter-widgets/output", "_view_module_version": "1.0.0", "_view_name": "OutputView", "layout": "IPY_MODEL_59b1e2c4d2904aa0975bb992a4411767", "msg_id": "", "outputs": [{"output_type": "stream", "name": "stdout", "text": "Video available at https://youtube.com/watch?v=FHikIsQFQvM\n"}, {"output_type": "display_data", "metadata": {}, "data": {"text/plain": "<IPython.lib.display.YouTubeVideo at 0x7fa17855b070>", "text/html": "\n        <iframe\n            width=\"730\"\n            height=\"410\"\n            src=\"https://www.youtube.com/embed/FHikIsQFQvM?fs=1&rel=0\"\n            frameborder=\"0\"\n            allowfullscreen\n            \n        ></iframe>\n        ", "image/jpeg": "/9j/4AAQSkZJRgABAQAAAQABAAD/2wCEABALDBoYFhwaGRoeHRsfIislIyIiIzEtMSctNzo3MDgyQTA3P1BCNT9LOTIvRWJFS1NWW11bNUFlbWRYbFBZW1cBERISGRYZMBsbL1c9NzdXV1dXV1dXV1dXV1dXV1dXV1dXV1dXV1dXV1dXV1dXV1dXV1dXV1dXXVdXV1ddXVdXV//AABEIAWgB4AMBIgACEQEDEQH/xAAbAAEAAgMBAQAAAAAAAAAAAAAABQYCAwQBB//EAEIQAAIBAgMDCgUCBAUEAQUAAAECAAMRBBIhBTFRExUWIkFSYZGS0gZTcYGhFDIjQrHBM2LR4fAkcoLxQwc0NXSz/8QAGQEBAQEBAQEAAAAAAAAAAAAAAAIBAwQF/8QAIBEBAQEBAAICAwEBAAAAAAAAABEBAhIhAzEEQVGBIv/aAAwDAQACEQMRAD8A+fxEQEREBERAREQEREBERAREQEREBERAREQEREBERAREQEREBERAREQEREBERAREQEREBERAREQEREBERAREQEREBERAREQEREBERAREQEREBERAREQEREBERAREQEREBERAREQEREBERAREQEREBERAREQEREBERAREQEREBERAREQEREBERAREQEREBERAREQEREBERARLF0MxPfo+pvbHQzE9+j6m9sMquxLF0MxPfo+pvbHQzE9+j6m9sFV2JYuhmJ79H1N7Y6GYnv0fU3tgquxLF0MxPfo+pvbHQzE9+j6m9sFV2JYuhmJ79H1N7Y6GYnv0fU3tgquxLF0MxPfo+pvbHQzE9+j6m9sFV2JYuhmJ79H1N7Y6GYnv0fU3tgquxLF0MxPfo+pvbHQzE9+j6m9sFV2JYuhmJ79H1N7Y6GYnv0fU3tgquxLF0MxPfo+pvbHQzE9+j6m9sFV2JYuhmJ79H1N7Y6GYnv0fU3tgquxLF0MxPfo+pvbHQzE9+j6m9sFV2JYuhmJ79H1N7Y6GYnv0fU3tgquxLF0MxPfo+pvbHQzE9+j6m9sFV2JYuhmJ79H1N7Y6GYnv0fU3tgquxLF0MxPfo+pvbHQzE9+j6m9sFV2JYuhmJ79H1N7Y6GYnv0fU3tgquxLF0MxPfo+pvbHQzE9+j6m9sFV2JYuhmJ79H1N7Y6GYnv0fU3tgquxLF0MxPfo+pvbHQzE9+j6m9sFV2JYuhmJ79H1N7Y6GYnv0fU3tgquxLF0MxPfo+pvbHQzE9+j6m9sFV2JYuhmJ79H1N7Y6GYnv0fU3tgquxLF0MxPfo+pvbHQzE9+j6m9sFV2JYW+DsSP56Pqb2zWfhTEd+l5t7Yagok+PhHEH+el5t7Z70PxPfo+pvbMuCvxLAfg/Ej+ej6m9s58R8N1qalmelYeJ/wBIuCHiSVDYdep+xQfP/SdyfB+KJAJpLfddjr4aCK2ar8Seq/CWITe9L7FvbGH+EsRUJAekLC+pb2zWIGJOUfhau9bkc9INYm5LW0JHd8J30v8A6f4tr2qYfT/M/thlXGR+I2ulPFJhirF3AIItbW/j4SQlP+IaLVNqUURzTZkUBxvGrcJqcWBNrocW2FytnUXvpbcDxv2zvuL2uL8JStnUKlHadRDUNWqtNrOb3JyXG/7SKBp/ps+Zv1nLcTmy23+f3itj6VeLjjKVtkVaGI6o62LoqjD/ADGwb/njPNlUalTGUMLUGmELk+Otx+csUi7E23zgw+10qYqphgrBkFy2lju/1kN8Zt18MHJFEsc9vqL/AHteRmziq4nF/pSxUUH5M63/AJd3b9IIveYXtcXgsBvNp84VkWjh3oM36s1GzWJvv0nXti743EisUFlOTlGYBRpYrbefD6xSL6TbfAMo+MQvhMIKmIQkFiofOFcXFtbDdu1tod8lvhDEKyVUWmUysNzllN77r7v/AFDI2Yn4qo06r0zSqk0yQSALadu+Sez9o0sTT5Sm2l7EHQg8DKvg9o0sNtHFtVJAJcCwJuc26adkbMavgMScp1YNT8SoN7fY2hsXm88zDiJUNhu+NxK1qg6uHpBR4tbf/U/YSIw2DRtn1qxvnSooXXQXtfT/AJuikfRibb9IuN99JSsdi0qLhKdVQzciGz1ajBO3eBqTpvnDRqE7Mrre6rWTKOF73t5RSPoeYcRpOXaOLelSz06RrG4GVTbTj2yoJs2n+tw9K75K1FWqdY3a6knXhcCcoc82OpJIXEC3h1TFI+gq/VBbq3A0PZ4TOUfHlGxiLi2YUBRXJa/cG63+a82V8VRXAoi8vUpNVIU1GyAWHEb113fXhBFuxOIFOk9Q6hFLG3gLzVs3aC4igKygqpv+7stKZs98tTGIhXIcPU0pklLgDdfU9ussPwvbm0XUsOvdRvOp0hkYN8XYfNolUpe2cLp/WSLbRY1aK06RqUqihuVB0UG/Zb/l5Sv1SUUZsLiaqdb/AAaib/G+q+fCSZqu+O2e9RcrmmpItbtbs7IbFwzDiIv2ds+cjCq2GxVU3zJVULrpqTfSSOAp8lj8GVZr1aKu5LE5iwa/9BFInX28adBq1bDvTs4QLe5Nxe/ZJWnVDIr7gwB18dZ8+T/8bW//AGF/oZ37XxFN6iU2RbpQXrVXYL+0Hqqu86/ciCLrecm08Y9GmGp0TWbNbKDa2/XcZRqlVm2WgYkhcQQL9gy3t+TJH4g2UmGwYKM7GpVQsWN9Qrf6mCLHidrpTr0aDK2aqBY6WX6yQuJStvYOjTxWHeoGFOqoNQ6/f8WnRtTLhXw2NwwvSyZLa6i2l7+HHgIIt15FbX2/SwjqjqzMwvZbaDd2n6zT8KYM08Pyr/4lc52J4dn9z95XMTXfE4nE1EoPXUqaalQSE4NoDwvbxhkXunVVlVweqwBB8DrMrjjKDiMZymyUQ/upVgv2sxH9x9p1UqAw20cJyZb+JTVnublib3/pFbF0zC9ri84Km1kXFrhSrZ2F82ltxP8AaUjaGIp1Q9VFCOan81RmqfXgBJemeU2nhS/Wz4cZr9t6bXikW+8FhxEob0qqu2zBfK1cEH/Lv/pY/abNu0KaYl7PTdUQLyLllKgAaLuB46HtOkUi2Y3GVKdSkiUWqK5szA2yagX3eP4nZcXtfWUnE1xUbZjBWUZ7WZix0cDed4nNtHImIrVGdK/8TcWdHU3Og3bt3buG6KR9AiaMFUz0abWYZkBs2pGnae2b5qSIiBrrbpzETprbpokdK5ZoJstMFmanWRFs6iaSvbca1SmpFxYtbx0A/vLMRpK9t1LVkbipA8//AFNbn28wGMCgKwK33XOhk1g8SlVSraDsvbfxBlbwbU1xSqbAAG9hxEsODwaZHWwym99+szHbbHmK6yBuIvNey/8AEPipmeJrAkKtiOM6Nn4Vb5rm4EvPt5t+kTVOTaCf5iw8wP8AWTtOvUX+XyMg9tjJXovwcfn/ANSyU+3xF5aHDMGooWDFVLDcxAuPvM5WtrocVtCnhGYiiqZ2Cm1zv/0/MNWIUUzZ8q5u9YX85j+mp5s/Jpn72UX85WdqPXfaS4aliHpKyi1ibCyk7r+EbP2pikbFYdm5apSRmRrXNwQPvvvMItL0lYgsoJG4kA2+nCeCkoYsFAY7zbU/eUXBbTrMVY48pVzapVDZPMXH4EnPiTGVi9DDYdytWocxKm2m4a8N/lBE9VpK4s6qw4MAR+Z4lBFN1RQbWuFANpBbHYY/ANRrsxYNlY310Nwf+cJs+E8S7UqlKoxY0Xygnh/wGCJhcNTVswpoG7wUX857Vw9N7F0ViN2ZQbechX+KEWlVdqZD06gplMwuTr228D5Tf0gpmrkCkqKXKs9/2i193bvHnBEpUoo65WVWXgQCPKe06aoLKoUcALCQFP4rW6M9ColF2KrUJHZv0/3meL+JhTr1KIoVHZN2U3v9uyCJhsJSJuaaEneSomVamTTZUbISpANv2+NpVTts0cfXeqz8mKYK0iT+4hDa24Hf+ZJ4upi8TQptRthg1y5ZusF7Du07T5QR2bH2YuEo8mDmJJLNa1z9PpOoYamFKimmU7xlFj9pW/hnE12xNVOWavh1B67cey19eMtM01qbDUyFBpoQv7bqNPpwj9NTsRyaWJuRlGpm2IYw5FLhsi5gLA2FwOF5j+lp2y8mlib2yi1+NptiBrq4dHADorAbgVBtPXooy5GRSvdIBHlM4gahhqYvammoseqN3D6TOnTVRZVCjgBYTKIGk4WkWzmmhbvZRfzmbUlLBiqlhuJAuPvM4gav01OxHJpY6kZRYz3kEuDkW6iwOUXA8OE2RA1fpadsvJpYm5GUWvxtPWw6EglFJXcSo0+nCbIgav0tK2Xk0y3vbKLX42mVSkrizKrDgQDM4gYPSVhZlVhwIBE4Nr7IGJSnTz8nTVrlQu/w36dskogeBQBYDQaAeExp0lQWRVUf5QB/SZxA0nC0tf4aam56o1MyNFLhsi5huNhcfQ9k2RA0nCUiSTTS7b+qNfrxmQoJcNkXMBYGwuBwvNkQI3D7Jy4upinfOzCyi1sg89dB/WdtXDU3IL00YjdmUH+s2xDWDUUJBKKSv7bgafThMXwtNmzNTQtxKgnzm2IYREQEREDXW3TUFm2rumeSZrWtRM6a6zNVm2imsiKrILIP4ko3phtxUgjx7LSSxm2aNIMFOdxuUA7/AKyobS2rWrkZ7AA3so0+sqGa2YKmHqAgkAnw/vLRgqLkZR+wE68fCV/BYemLVHta+okuNpZkqVEOVadgoHAanz1k883Xbv5Jy1PSemf231nRgNosHCmmNTYnNu/E0Yfa96YFRc7cb2vqZmACQ43GxE3edxw8s158Sp/DDcGB/wCecmcLUzJSa+9f7SO+Il/gn/nYTPdlVb0qX0lJ/TfK5tfPhsfTxeRnpFMj5Rcj/mkvfN1PgfOe83U+B84VFD2lsjEvjBisO1NbKLZr33WOljxmeztgVafLVKlf/qKosHQft1vfsvqBLxzdT4Hzjm6nwPnBNfO8R8P42vlStVolQb8pbr+dgT9LzfU+GXq4kvUqlaaqFp5G61gABe400ufvL7zdT4Hzjm6nwPnB7ULCYF9mPXrE8pQIFgNXJuLaWtvJnT8K4SolKpUqqVas+ax3gf8ACZdebqfA+cc3U+B84JqiYj4a5THGsxU0G1Ze3Na27dv1nmyPhpqVPEJVdSaq5AV1sPv9tPCXvm6nwPnHN1PgfOD2+dL8NYl0pUKj0uQpsTdb5jff2f8ALyUwWyalPaFbEkrybqQACb/y+HhLjzdT4Hzjm6nwPnB7UDaPww+IxNeqWUK69TU3DADeLbtD5yUw2GxH6NqNUo1XIyK18wOlhe4/1lr5up8D5xzdT4HzgmqvsTBvQoBKmTPmJPJgAHyAkhJjm6nwPnHN1PgfOKRDxJjm6nwPnHN1PgfOKyIeJMc3U+B845up8D5xSIeJMc3U+B845up8D5xSIeJMc3U+B845up8D5xSIeJMc3U+B845up8D5xSIeJMc3U+B845up8D5xSIeJMc3U+B845up8D5xSIeJMc3U+B845up8D5xSIeJMc3U+B845up8D5xSIeJMc3U+B845up8D5xSIeJMc3U+B845up8D5xSIeJMc3U+B845up8D5xSIeJMc3U+B845up8D5xSIeJMc3U+B845up8D5xSIeJMc3U+B845up8D5xSIeJMc3U+B845up8D5xSIOrum1nAkq+zKZG4+c4sTsJKgszPbwa0EcHOVAGxqpf6zTjNtIi2osrOe0G4E6D8HYc/M9X+02J8KUF3Z/VMbFZwyhgSd4NvPWaBhM31FwfPfLivw3SF7Z9SD+7hPejlK9+ve998u4nx1U8NhyAFZsyqCd2t+wX4b5ppoFLMCQW/dbtHAy59HqV79bzmpvhaie/6o8sPHVRpPonAG585MYLE5xl7LaSVHwpQC5f4lv+6bqPw7ST9ufzm+WM8NadqrmoX8FMj9kt/CA4G0sNXZ+dMhJta014XYyU7gXseJnPVZmpeIiFkREBERAREQEREBERAREQEREBERATyezg2ljDTFlbKTvNr2voIVzzvWzHRWxlOmbMwB4TBcfTP827wkFiagtlaoBca6axUHVNrBBY6D9w+sjyerPx+Z71PjG0yQMw13X0m8GVypY2JbQWsBvnVhsWaZVbkg9hm50jr4PX/KaieKbi47Z7KeYiIgIiICIiAiIgIiICeT2RW3se1FAqEh2vqN4Am5l2Dfjdq0qJsxLN3VFz/tOGn8TU2P7GtxFpWmqg9rMTqban7mE1FgSAND2ETvnx4vxWhfiOjvKuBxsD/eSeGxVOqLowb+32lEDDKC2gtu4zdQrtSIZCVa/YY34s/R4r3E5dnYrlqKvuO4/UTqnn3IgiIgIiIHkT2IHkT2IHkT2IHkT2IHkT2IHkT2ICIiAiIgIiICIiAiIgIiICIiAiIgIiIHkr9fEZqj3GYE9mthusfKWAyAr0irEMcoH2v4yeno/Hl1hRRV6oHZec4wrdYcpbW4UagCZ0lDXblCbaBlI3TFc6LnPWva4OluEh7cFrqwJcWKn9wFxp4zaWOjLaz2GvZPaeYGzABbaAbpt2bgKjKDcCnclb/utCeus5y6l8Eb0l8BbynRMUUKABuEynV83du0iIhhERAREQEREBERASn7crl8U1tQvVt9P9yZb5VdvYFkqNVP+ETcn69h+86fHKrlF3tbS2Y6zB6KltSbkbhMEemzWB+xv+JmKVrsLg9nbpPQp4hIJWxZR2/28Z7nuuYXBW4tMkzGxJ+26Sey9htWLVHZqaG1gALt467pm7mZdLEp8Mk8iwOoDaf3kzNWHoLTQIgsom2ebrbtRpERJYREQEREBERAREQEREBERAREQETnxmOpUADVcLmIUcSTwA1M6ICJ4TYXOgE5cLtGlWJCE6DN1lZbqf5hmAuPEQOuJjmGmo13RnFr3FuN4GUTUMQhZlvqgBbwvu/pFfEJTALmwZgo+p0EDbE1pVB4jUjUW1Bt2zLMLXuLcYGURMc4te4txvAyia6lULvvvA0BO8gdn1mWYa6jTf4QMongM9gIiICcW1NnriKeUmzDVTwM7YhububcVOl8P4lW0Kr/AJgx/wDZk5g9mBFtUblSd+YafYTm23tl8M6qqK2Zb6kyUwtXPSRyLFlDW+ovHhMrp1+R136efpafcXym2exDnu7pERDCIiAiIgIiICIiAiIgJrr0VqIyOLqwsRNkQKpV+DOscleyX3FLkfnWS+ythUcN1hd6nfbs+g7JKTh2ltRMNlzq5zXtlA7PqRxlXrfRuu2w4RNODxK1qa1FBAbcDv4TfJCIiAiIgIiICIiAiIgIiICIiAiIgIiIHJtLDGrRZFtmNrE/UE/0nRSLEHOADc2sb6X0O4a2tpM4gYuCVIFrkdouPKQI2XiOTZFWmiWUclyhdbhgSVzqQlgNBYjwFpO1agRWY7lBJ+0hU2vWzsXRFBpUnRA5a5dmG8Le9huAO7SBz9HajUHVxTL8nXWmSb5Gdy62OUWtpqAN2kzxOyitZclClUpmsXCHRVHJBO6QDmB7O3jNtHbNR3V8iJR5Gqz5nIIZGyneu647baHUC1p3bM2ga/KBkyNTYAjrWNwD/Mqnt4QIttg1glMZlOTk7i+jZVdSOsrDQsCLg7uw6zsrbKJwlGllR2pFGyubjqkEjNl4XG77SXiBXcVsB6iVQRTLMlcIT/K1R8yndpbiJnithtmPJBAnKZxTGUD/AAwh0KMAbjhuMn4gRq7MIoCmXdrUeTylzY9XL+4C/wB98jH2HWKAEUyAz2TqC4ZVW5PJlSRYj9t8p38bLECCTYRHKGyF2rUGDnVslMUrgta9702PlOehsCoqOrAMbAXzgZyHz5janv0v1s2pIOhubLEDk2ZQenQVHy5hf9gAFrkjcAL2tewAvfSdcRAROPauJajh3qIBmFgL7hcgXI7QL3t4TCvtOnQIp1WYuVuLU265FtBYatr+0awO+eQDcXnHjNp0qDBahYFgSvUYgnuggasexRrAhfiDZdd6odC1VW0A0ul+z6ePZJzZmGejRVHcuwG/sHgPATpRswBsRcX1Fj5TKXve7znP8TnOZtIiJCiJw4jEumJopoUq5gRbVSozXvw7LW7RO6AiIgIiICIiAiIgIic+OrmlQq1AASiMwB3EgXgdESOo48JyKVS7PVXMGygKTYsV8NAdOA1M68JiBWpJVUEK6hgGFjY6jSBulY+K1q3RiF5IXswBuCbaHyk9iMatOpTRg38RsqsBpexNifGxnuExC16S1ApytuDDgf8AaVx147WdZcji+Hkqrh1FUBR/ILHNbfc+e6Ss8iZu3aZkx7ETg2liHpNRZW6rVVpspGhDdt94I/2mNd8REBERAREQEREBERAREQEREBERAREQPJxpsnDqCFooAbbhbdqPpbs4TtiByc2UMqryNPKoYAZRYBv3D6HtE2YfCU6V+TQLmNzbtO6546TfEBERAREQEREBERAREQODbeHaph2CLmdSrKNL3VgdL9tgbTViMA9arTrisVyNmpqaf7QVKsCCdSb7+zTTfeUnkCIpJiSa5VnDNXW3KAZVpggHLprdQfu3G83Y7Zr1qiVBWy8mwamMlwDYhr69a4Jtut4yRnsCKwy18+JOZ7l+oKg6gUADSwv2E/fjOesMR+io585rBqJIp5r2BUtmtv0zXnfitrUKL5KlTK2htlY7/oJ2zZpWiiKvKVCxHJnLyYtqNOsT9SRp4eM1DDV8oH6jXKovyY/cDctbxGluzfO2JgjcbSNTFYayErSLOxI6o6pC2Pa1z2btZJTyewEREBERAREQEREBOXaWH5bD1aYCkujKA265Gl/vOqIEJVwr4paFN6VSmtMhndmW56pUoLE3vcgngdDMzha3K4spmRmVUouWugGUWOW51DFju7PGTEQIvamGqV8lAKwUFXauCBax1AF75j9LAHfpaeUcI64mqVVkXk0Skb3QAX0yBhrc8OzfJWIEDWwWJOAxFNyalRhVFMJ1Tclspvn3ag27BxkpSWqaoYnLS5MDIbXzX3nhYC2h7TwnVEDjbC1Tf/qHH+J/Kumb9vZ/L2ce2807Tw71OQphS4FRGdjbLZdTcdpJ3ADfbhJKICIiAiIgIiICIiAiIgIiICIiAiIgRe1MRWR0FN1uxUJTy3Lm/Wv3VC21/wBgZSclfZ1GpU5VlOcDLmDMDa97aHjOilSVAQosCSfuTc/kwPXNlJ4CV3B/ELlaXKqM4oNUqIv837MjLfsOYj6gjslia1jfdbWcq4Cgyr/DUqKfJrp/8Zt1fpoIHNzrUz8kKA5XOUI5Tq/tD3zWvaxtu3+Gs5122WdGswRwhC6XF6dVyCf/AA7JJYTCUAA1MA2YnNcklv2k3OpNhbXhA2bRFrU16treFgyj8Mw+8Dh59IXr0SrMtNkGa9w5IFyBoRY3sD4Xnr7dsqsaRG/OCTcDNkuBa5BsSCbAjynZWwlAlUZVuyhVF7GydYW+m+8wOzcMxy5ASoFxc6i5YX162tzrfUkwOVtrVGKFKXVNWrTtmF35MVPT1kE6aO1qb06tVbmlTUNmHb1c5AHgCPubdk3pRohwgC5kJqAdoLlrt9yW/M8wWCSjRFIAEa5rgdYsSWNvEkwOFdtM2VRQOd3CqMxC6qz/ALivZkIIANriaqu3KhpKy0sjPyTICwN1aoqMD2A9bx3/AGknS2fSTLlTVWzAkkkGxXefAkW8Z4+zaDKEampUAKBwAIYfkA/aBw1du5TkNImqpfMoa46uU6G2pIdbaDxtMn2q7VaYSnamawpsxOv7Sx6vZ2C+/wAO2dZ2XQKhcmgJN7m5vvub3N9L332nvNtHlOV5MZwc19d9st7br20vwgdcREBERATyexAo23apfEuWQoQAMp8O3TsMumGql0DMhQnXKd4+s8q4Sm7o7ICyftJ7JtnTrvyzM/ic5m7qsbUxVYYpA71qYFZhTFNLhk5IkHcc5z9nZbd2yb2fi2ZUSsMuI5JXqKAbAnfY7jrwJnWUBIJAJG7wmr9MOW5XM18uXLpa2/hf8zmpviIgIiICIiAiIgIiICIiAiIgJX/ibG1KZpClUK3zZsp+ksEh9s7DXEHPTslXQEncw8fEf7fS/j3M6yp6s9OrY9c1MNTZmzMV1PbI/E7bqiremiGkhrB8zWZjTAvbSy9u/f4ST2ds9MPTyIN+rN2seJmNfZNCpVWq9NS637Brew1HbuG+T1L6bn030MSlQAqdSobKd4B11HZN04Uwj/qjVYJlylVte4va9+JJUa8APG/dMaREQEREBERAREQEREBERAREQEREBERAwrAlGA3kG0g6OzK4Gds3KipQsc/8gWmtTttr1/r5ScqOFUsdygk/QSITa9RqgDUzTUrRYA2J/iOV7DwA+njA5Rs2qiKgoMyKawKrUAzMxBSoDmGgFxxBOgO+de08NXajRQLyhCkOwNjny2BsSBa99dSNLDtBNvXUOaDhOTFW+Zf2bid+/ttw8oq/ENNeVORmWmKmoIuTTuGFuzcbE77fSBsrYBqv6XlRmyA8p1u0pbsOusjatGrRSk2IJNMckrqag69lqAjMTbeUOpF7cZJVts5MweiysrBTdhlAKlgxbcBoRr2+cLtW7sioajFgFW6gAZFc9a9j+4fc8NYEThtnVauHeoobOaDCiTUNw+eoy6310K2J7J0YnZ+KZq9s+Zlq5XDABgykIt81xa47BYi99de2nt1Wsy0n5P8AhXe405S2XS99CRf+8loGrD0RTQKosB4k/kzbEQEREBERA5tpYvkMPVrZc3JoWte17ePZOTGbUNHKrCkz5S7jlMllHaLjX72mXxDRapgq6qCzZCQFuSSNbW/m/wC3t3TTi8JUxNSjWRqRSk4emCD1rqVJPAi+gHDXwCVpPmVW01AOms4tpbTFBlUBCSCxDVAhCjtFxr277bjOdMRiM2JyXdhVVURlsqr1QTfS/wDOdDwme1dn1a702Bp5aLrURWBOZtQb8LAm1u36QJGhUzoradYA6G418ZskXhq1c1cT/MVcBEYFFtlXXNY9ubj2TlOJxBwFKpULU6v8InJ1iwJXNcZOr23A3W3wJ6JzUalRqtS6gUQqZD2sTct9v2/ma7YrLvoZsvBrZr/Xdl/MD3EYxqdejTIBWsSoI3hgpb7iyn8TskXtEZ8VhFFzkqM72v1VyMASRuBYgW7b/WSkBERAREQEREBERATVWxCJlzsFzHKtzvPAcZtkZi7/AK/DaaZKtjft6uluz6/btgd36hMxTOuYWutxcX3aTbK3TVhi3Vjc0KnKmqaa5uSZP23C7y992tlkxhNopVWloyNVQuqMLGwtfyzDzgbziEDZM65hbq5hfXdpNsrmR/1rUiczI6V+UNNbrTKkFb5e1ltxtfhJFdt0eQp1mJRahXKHspIYgA2PZ1gfpAkonIccvLU6YUkVFZlcEZdLeN+0TL9fS5Plc45Mtlza782S3q0gdM1Ua6PfIwbKbGx3HgeE108dSZgivdiXAFjvQ2byJnJg/wD77FcMtK5v22Olu36/bsgSkREBERAREQEREBERAREQEREBERAREQPCLix1E4aGx6FM3VDfq73ZrZTmUC5NgCdBunfEDk5to5MmTq8nydrn9nDfMX2VQblLqSKgYMudspzfust7AntInbEDlrYCm5JIYFrXKuynQEDVSOwmazsihlyhCoBBGRmUiyhNCpBHVAFp3RA5V2dRClRTAU5NBe3Utl8rDynVEQEREBERAREQE8nsQExZgASTYDUk9kynDtivyeGqEqzAqR1RuuLXPhA30MXSqEinURyNSFYH+k3ynfDFfJiCMrMXWwyjdqNTwEuMv5OPDqJ568spERIUREQEREBERAREQEREBOfEYRajI92V0vlZTrY7xrpY2HlOiIHJT2fTWk9LrEVAQ7MxLNcWuW37tJso4REykAllXKGbU23kX8vIcJviBy0MCiIy9Zs/7mZiWbS2/wCk8GzqfJJSN2VCpFzc9Uhhr9QJtxVdaaFnYKN1ybaypfDmLy4gcrVIBQjrMbE3Fhr2y+eN6zd/id6mxaqmDVqqVLsCgIUA6WNr6fYeU3UaSooRAFVRYAdkynshTyaMPhFps73LPUILM3hoBpoAJ0RAREQEREBERAREQEREBERAREQERECK2tjK1GpSyMgpswDFqTMFHaS4ay6WAuN/bbdKzjxOzaVVszhtQAwDsAwBuLqDYzppUwgIBJuSdSTvN+3s8OyB65sCeAkHs3a1WpSp1HdWz8n1Vw7pYt2ZmezfUSdIuLTQuCpinTpgdSllyC50y7te2BzYLaLNhTXqUypAYkXXW3jmsPuRMTtUPhqlamNUJWxIIuCO1TYix4zo5tpck1KzZGbNbM2hvm0N+rY6i26eUsDR5N6a3ZXYl7uWJbt1vfsgcZ22FDXpvUycqzFQoyqjlDoW13dm/gN02DblE1jSFyQSLgrvAzHS9xoDqRa4+k3ts6gq1LiysrhyWO5yWbW+mpP0njbKotnuGKuCGXO2U3GUnLe2o/13wOant5HyhKbuzVOTCqyHXKXvmDZbWB7d8347aoouVNKo+VVdiuXQMSo3kX1Ezo7LpI4cBi4bPmZ2JvlKdp7pItNlbA06hYsty6hTqdwJI/JMDkO2hfIKNQ1RnvTGW4CBSTfNbc6W1/m+tsH21mKckjMhqU0NQ2yjMA3G/wC1hra1zOmtsqi5LEMGYklldlOoCkXB3EKungDvmups/DI4ZuoQVcLyhVbrZAct7Gwyjy8IHPS+IUrBTRG9qW8g3R2C36p0PgbHUTZi9pvTxLKUPJJTViRlJZmJUAXbTUW3b+Am9dmUKSfzBFykBqjZUCHMLAmwA/5umyrhaNVqgazMVCOAxuALsNx0OpN98DQm1wagpCjU5TMVZer1bBWuTmsRZ1Ol5JTkobOpU2DqDnuxzFiSS1gSSTroqjwtOuB4SBv0i8hPimuqUVuabEMGNJ1DB1BAYkG9gFJJPZp9+nZ1anS5PDK2c5C+ZEsliT2roO3y1N94Sc8IvoZytj0FJ6ozMqFgQoueqSDp9RNwqZqedb6rcaeF90DVg9n0qGbk0C5jc/6fTwnVISlisWWW+a1xf/prafXldJ17WxZRVpU/8ascqAEAgb2bXgtz9bDti0d4IO43gkecgfh/FUqGEyuwRVr1kFze38RrAny1/wBZp27iKVStQUvSKt1W5SmDyIYZw5uLqTlsAbX8bQLIDPZyYPFIzPSXMTRsjHLYXsDobW3Ebp1wEREBERAREQEREBPLz2VzadMnGZCtNqtRUNBigutm64PFQtj9ftAscTjpbSpPSeqCciFgSVI/aSD9d02V8YqVKdNg2aoSq2U2uAW1O4aAwNtWmrqVYAqRYg9sjNn7Bp0KrVLlzfqA/wAg/ufGde0qtREBpfuzW/wmqaa9ikH7zRs3E1nciqdLaf8ATvT1+rMb/SbnW56xm5mpEmeytfE+KLpUVQTToZXqMpFg4IZQbkGwHWIF96ycOOpBymcZgVBHAtovnaY10RIX4hIVqDVVR6GfKylLkEqxVgeOYKBbjOnZVfKq4d7ctTpoXCrZRe+gO7sgSUREBERAREQEREBERAREQEREBERAREQMK18jW32NvrK+cJikpKFasxanRNTM5Y5g3Xt1gQbbwpG7TWWOIFdWjiwKVjWKgnlbkAlM91AuzHMBvN7ldD1iLdeBwdWmKy0yabGszZqmaoGUkkW64tv1kvECv4zCV6jYhLVGWpTcAlioXQZQLNYgnwBGt7zwUcRytPLyyUxyWW92sAeuGu9t3aQdCLaiWGIEBsI1WdH/AI2Uo/KGo91ZswyZRc20zbrab9ZyL+pqU6xo8uXvilzF+qbFwgUE2BBtbQbjfslpAtAECCrYXELiFCNV5MGnlNy2mYlwbuBu4g6EZdROVMJieUR8lblBSZajM9wXNSkTl10BVWOlha3bLPPYFcxGCrVaWIpsuINRkqg/xLIxv1ABfTS26wtfNNtSlVzDq1+QzLdQ5z5chG/Nm/fa9jf7Xk7PYFep4XFFc7mryirRyjlNL3Oe4BysbaG/2lhnk9gYlAd4B0tu7OE5jgF5Zqtz1qYpsmmUgZiNLX/mPbadcQOCnsmklKpTpjk+UzXZQoPWJNt1rC5A0nVh6XJoqZi2UAXNrm30AE2xA8nhQEgkC43G0ynkCBxeIw9euMNnqU7NvSyjlAQV3jUgjTsPA6ScFIdoB3XJG8jtkF8SbKzg16Y66jrgdoHb9R/T6TdsDa7V/wCG63ZFuXvv1AGnH/Ty6bzm8+Wf6jy9zUjhsIKbVGDseUbNY2sDu0sL9nbedMROayIiAiIgIiICIiAnLh8EEqNUZ2qObgFrdRSb5RYDTd4mwudBOqIEadi0mw/6epeoovlLqpK34ab/AB36zbV2cpNHIeTWixZVRVAuQV3W4Md07YgIice0torhkDOCb3AsO21wPDdNzKNGOxuFoOKdRVHKat1QR4FvvM0wJbE8s+UBVyoqnQjWzHTeLkAbtT9oPYuDbF12xFbVQ1/Bm7B9Bp+PGWuV3znPr9p52+3NUwYeqtRnYqtitPTKG16265OvabeF57SwmStUqB2PKWuptYEADhfs49pnTEhRERAREQEREBERAREQEREBERAREQPCwG827J7IHbuExFSojJTSolOpSZBnIIbOCzEZSN2l76DNvvJulUzC9iNSLEW3G1/pAzmCVVYkKwJGhsb2ispKMFNmIIB8ZX6VJlooKOGenVp0QjPYKRqmZR2OSAxBFxcb9YFjiV4UsQ5IDV1pfxTTJJDftp5b31/dylr9m+YV2r0zTV3r5HalmIN2JKVC4Ftf5VNhu7IFkiVp3xdkAWtmBBU6m68odGA0BFPLfMe3QXvNlSniQgYmtZq1XOAWJChm5OwXUC1t3hfSBYZ4rAi4NxxEicTywpYbOap3csaQsxOU20W5AzWvbw7LziwK4hP0tC7rylNWa9s1PkzdvVdV08YFkiV4LikVG/jPnpVOUF9zZky20NrKX3DW3abTGnTxTggtWVQKxUi6kn+Gad73J1L2vw14QLCzgWuQLmw8TMpAGnilZQpdtVa769Y06l/oM2TTsvMbVeS0bFixTPnUm5s2YDL1xrluVuN1tLwLDE0YJmNGmXUq5UZlYgkG2oJGhM3wEREBODF7TFKryfJVKhFPlCUy6Le3awN/ATvkJXw2JNfEulMA1USlTdmFlUZrtYa3u507bDUQOqptdLJySPWL0uVApgXyaa9YjffQb5sx206dAUs4a9V1RQBqCxAueAFxc+IkbU2ZUHI06VLIcOaa0q+cf4Yy5wRvNwCLWtuMx2js7EVi9WzBhVpinTuluTR1ckk6gkg7iNyjsgST1OWrvRsOSRRylxfMWvZfCw1P1HjNGDOGpYxsPSQrVNPOxF8oAIFtTv6wNh2EeEYctTxGNCrmdslVFva4yBLXPih85yYbAVaFalXdiRyVU1WdkCq7lW3gXy3W2t7C02iwzj2ptFMLQatUuVUblFyfAD/m6cmD2u9WmrikGJqinlVjcakMx06osCwB7LdpmjbWz6+J5cDMqrRZKIBSzs4IYm97DcOw2LcZgnQbzko4hhiHovY9XlEbddb2IPiDbXgwnKcfVSpToGmuZ0Ur1j2ECpewsLA3HH7zNlzbRUj/AOLDsG/82W3/APNoEnEidobFWvVNQjDkkAdegHOn+bMJ27Pwgo0hTAQAX/YmQam/7bmBveoq2zEC+65mIrodzqdM28buP0kftaiK4pooWpkrU2dbroAbm4MjcNs40alJzSRLYjEMTmQXV82Ub9d66eECeo4xGRWJCZlDZWIuL8bG06JU02RUNOlSekjOmAelYsps5KgH6aHXxlkwrWSmjECpkF1JF9ND9dYGnBYy+HNWqRZTUufBWYf0E24DGLiKKVVDKHFwGFiPAjjInDYepWpUqYzLSFSq7upW+ZajFVs19L6nTsHjNeHxdTBUKFJwmdncHO4FgWYqxsLAagHdqbDsgWOJpr0OUUAsynfdGI/PCYYfBim1+UqtpazuSIGnFbUFNnRKVWs1NQzimAcoO4akXJ4DX8TTt96HJ01r57PVRVCb7k5b/TXWeYSjWo1q1qQYVa+c1MwsFyqN2+4y2ta3jOPamzsRX5WpZgyvTFKmGSxRWVySTqCSDuI3LGbBM4LBJQTJTvlvfVif67vtNJ2oDUKpSq1FVxTZ1Ayqx37yCbX1IBt9jMP19T9V+n5MfyuDc/4ZzAn6gqB/5Ca9j0a1FVotTFg1RmqZgc12LAgb9b63tbxjdo7Exqs2RVqZtf3U3VdP8xFpxc5VDheVsquMRyRtqLCtyR38RJYiRe1MNTpYa1NFQGtRJCi2vKprAlYnLzhT5U0rtnDBTZGsCRmtmtbd4zqgIiICIiAiIgIiICIiAiIgIiICJH86r3W/Ec6r3W/EMrudgASdwF5HU9u0WI0qC4Q3NNhZXNkY+BOn21mT7SRgQVaxFuycIWha2Wp+ykm8bqZLL+SbwV14zbSU1q2Ry6KWClSMwBykjwuR53mVXalO5XK2ZHpg5kNlLlQBfjZx/eRqYWgM/wDinOjpvUWDkE6gAk3A1NzN4NKzBuVYu9OozErcsmWx0AH8gvpxgrt54o5S3XC6ZWKGz3YKMp7bsQPvfdC7XpEqozlmzdUKbjKQpuPAkbr8d0jGoUShpk1jT0yIStqdmDCwtrYgfuvw3XipRosioTVyqbnSmMxve/7eqfFbGCrHMcovewvuvOHnVe634jnVe634grvnsj+dV7rfiOdV7rfiCu+Jwc6r3W/Ec6r3W/EFSESP51Xut+I51Xut+IKkIkfzqvdb8Rzqvdb8QVIRI/nVe634jnVe634gqQiR/Oq91vxHOq91vxBXY9FWZXI6y3se0X3j6btPAcJmRfQzg51Xut+I51Xut+IK7wLT2R/Oq91vxHOq91vxBXVTwyK7VADnbeSSbeAv+0abhMqVFUzZRYsczHtJ4k9vYPtOPnVe634jnVe634gqQmvEKzU3CHK5UhTwNtDOPnVe634jnVe634grjqbMdsOtNaSoUKAi6k1FUagkgj9xJF738LzXiNk1XVkCLZ6BorfKOSzE52sosbqV0A3rrxkhzqvdb8Rzqvdb8QVyVsHUZq9MFlZqlJlcMy/wwEVrMO0WfTiQe2e4fD1FOHpsCXStUcnMWtTOe3WP/cAB4eGnVzqvdb8Rzqvdb8QV2UaKouVBYXJt4k3P5JmRUHeBOHnVe634jnVe634gqQiR/Oq91vxHOq91vxBUhPJwc6r3W/Ec6r3W/EFdVHDJTLMoOZzdiSSe02udwFzYDQXm6R/Oq91vxHOq91vxBUhNdaitRcri4uDbxBBH5AnHzqvdb8Rzqvdb8QVlg9nCnVq1mIapUYm4BFlIUAWub6Ius7pH86r3W/Ec6r3W/EFSESP51Xut+I51Xut+IKkIkfzqvdb8Rzqvdb8QVIRI/nVe634jnVe634gqQiR/Oq91vxHOq91vxBUhEj+dV7rfiOdV7rfiCpCJH86r3W/Ec6r3W/EFSESP51Xut+I51Xut+IKi4iJSCIiAiIgIiICIiAiIgIiICIiAiIgIiICIiAiIgIiICIiAiIgIiICIiAiIgIiICIiAiIgIiICIiAiIgIiICIiAiIgIiICIiAiIgIlG6Z4n5dH0t7o6Z4n5dH0t7plbF5iUbpnifl0fS3ujpnifl0fS3uikXmJRumeJ+XR9Le6OmeJ+XR9Le6KReYlG6Z4n5dH0t7o6Z4n5dH0t7opF5iUbpnifl0fS3ujpnifl0fS3uikXmJRumeJ+XR9Le6OmeJ+XR9Le6KReYlG6Z4n5dH0t7o6Z4n5dH0t7opF5iUbpnifl0fS3ujpnifl0fS3uikXmJRumeJ+XR9Le6OmeJ+XR9Le6KReYlG6Z4n5dH0t7o6Z4n5dH0t7opF5iUbpnifl0fS3ujpnifl0fS3uikXmJRumeJ+XR9Le6OmeJ+XR9Le6KReYlG6Z4n5dH0t7o6Z4n5dH0t7opF5iUbpnifl0fS3ujpnifl0fS3uikXmJRumeJ+XR9Le6OmeJ+XR9Le6KReYlG6Z4n5dH0t7o6Z4n5dH0t7opF5iUbpnifl0fS3ujpnifl0fS3uikXmJRumeJ+XR9Le6OmeJ+XR9Le6KReYlG6Z4n5dH0t7o6Z4n5dH0t7opF5iUbpnifl0fS3ujpnifl0fS3uikXmJRumeJ+XR9Le6OmeJ+XR9Le6KReYlG6Z4n5dH0t7o6Z4n5dH0t7opF5iUbpnifl0fS3ujpnifl0fS3uikXmJRumeJ+XR9Le6OmeJ+XR9Le6KReYlG6Z4n5dH0t7o6Z4n5dH0t7opF5iUbpnifl0fS3ujpnifl0fS3uikXmJRumeJ+XR9Le6OmeJ+XR9Le6KReYlG6Z4n5dH0t7o6Z4n5dH0t7opF5iUbpnifl0fS3ujpnifl0fS3uikXhjobC54TVhmYr19999rX+3Z2j7SmdM8T8uj6W90dM8T8uj6W90UiuRETFkREBERAREQEREBERAREQEREBERAREQEREBERAREQEREBERAREQEREBERAREQEREBERAREQEREBERAREQEREBERAREQEREBERAREQEREBERAREQEREBERAREQEREBERAREQEREBERAREQEREBERAREQEREBERAREQEREBERAREQEREBERAREQEREBERAREQEREBERAREQEREBERAREQEREBERAREQEREBERAREQEREBERAREQEREBERAREQEREBERAREQEREBERAREQEREBERAREQEREBERAREQEREBERA//2Q==\n"}}], "tabbable": null, "tooltip": null}}, "27b95247dd7449e9bb76ca7e6bb326a2": {"model_name": "LayoutModel", "model_module": "@jupyter-widgets/base", "model_module_version": "2.0.0", "state": {"_model_module": "@jupyter-widgets/base", "_model_module_version": "2.0.0", "_model_name": "LayoutModel", "_view_count": null, "_view_module": "@jupyter-widgets/base", "_view_module_version": "2.0.0", "_view_name": "LayoutView", "align_content": null, "align_items": null, "align_self": null, "border_bottom": null, "border_left": null, "border_right": null, "border_top": null, "bottom": null, "display": null, "flex": null, "flex_flow": null, "grid_area": null, "grid_auto_columns": null, "grid_auto_flow": null, "grid_auto_rows": null, "grid_column": null, "grid_gap": null, "grid_row": null, "grid_template_areas": null, "grid_template_columns": null, "grid_template_rows": null, "height": null, "justify_content": null, "justify_items": null, "left": null, "margin": null, "max_height": null, "max_width": null, "min_height": null, "min_width": null, "object_fit": null, "object_position": null, "order": null, "overflow": null, "padding": null, "right": null, "top": null, "visibility": null, "width": null}}, "4ce28dbfb8a443c58ae5e8c3db1a2efa": {"model_name": "OutputModel", "model_module": "@jupyter-widgets/output", "model_module_version": "1.0.0", "state": {"_dom_classes": [], "_model_module": "@jupyter-widgets/output", "_model_module_version": "1.0.0", "_model_name": "OutputModel", "_view_count": null, "_view_module": "@jupyter-widgets/output", "_view_module_version": "1.0.0", "_view_name": "OutputView", "layout": "IPY_MODEL_27b95247dd7449e9bb76ca7e6bb326a2", "msg_id": "", "outputs": [{"output_type": "stream", "name": "stdout", "text": "Video available at https://www.bilibili.com/video/BV1qm421g7hV\n"}, {"output_type": "display_data", "metadata": {}, "data": {"text/plain": "<__main__.PlayVideo at 0x7fa1784504f0>", "text/html": "\n        <iframe\n            width=\"730\"\n            height=\"410\"\n            src=\"https://player.bilibili.com/player.html?bvid=BV1qm421g7hV&page=1?fs=1&autoplay=False\"\n            frameborder=\"0\"\n            allowfullscreen\n            \n        ></iframe>\n        "}}], "tabbable": null, "tooltip": null}}, "7eb517879c9f4ac3b44482bb1634e9fb": {"model_name": "LayoutModel", "model_module": "@jupyter-widgets/base", "model_module_version": "2.0.0", "state": {"_model_module": "@jupyter-widgets/base", "_model_module_version": "2.0.0", "_model_name": "LayoutModel", "_view_count": null, "_view_module": "@jupyter-widgets/base", "_view_module_version": "2.0.0", "_view_name": "LayoutView", "align_content": null, "align_items": null, "align_self": null, "border_bottom": null, "border_left": null, "border_right": null, "border_top": null, "bottom": null, "display": null, "flex": null, "flex_flow": null, "grid_area": null, "grid_auto_columns": null, "grid_auto_flow": null, "grid_auto_rows": null, "grid_column": null, "grid_gap": null, "grid_row": null, "grid_template_areas": null, "grid_template_columns": null, "grid_template_rows": null, "height": null, "justify_content": null, "justify_items": null, "left": null, "margin": null, "max_height": null, "max_width": null, "min_height": null, "min_width": null, "object_fit": null, "object_position": null, "order": null, "overflow": null, "padding": null, "right": null, "top": null, "visibility": null, "width": null}}, "975374bddb7f4a19a862437f1aa5afda": {"model_name": "TabModel", "model_module": "@jupyter-widgets/controls", "model_module_version": "2.0.0", "state": {"_dom_classes": [], "_model_module": "@jupyter-widgets/controls", "_model_module_version": "2.0.0", "_model_name": "TabModel", "_view_count": null, "_view_module": "@jupyter-widgets/controls", "_view_module_version": "2.0.0", "_view_name": "TabView", "box_style": "", "children": ["IPY_MODEL_234221900b7748d6b2337ddc27b0d259", "IPY_MODEL_4ce28dbfb8a443c58ae5e8c3db1a2efa"], "layout": "IPY_MODEL_7eb517879c9f4ac3b44482bb1634e9fb", "selected_index": 0, "tabbable": null, "titles": ["Youtube", "Bilibili"], "tooltip": null}}, "118612b386d844baa8c38cbab3653afc": {"model_name": "LayoutModel", "model_module": "@jupyter-widgets/base", "model_module_version": "2.0.0", "state": {"_model_module": "@jupyter-widgets/base", "_model_module_version": "2.0.0", "_model_name": "LayoutModel", "_view_count": null, "_view_module": "@jupyter-widgets/base", "_view_module_version": "2.0.0", "_view_name": "LayoutView", "align_content": null, "align_items": null, "align_self": null, "border_bottom": null, "border_left": null, "border_right": null, "border_top": null, "bottom": null, "display": null, "flex": null, "flex_flow": null, "grid_area": null, "grid_auto_columns": null, "grid_auto_flow": null, "grid_auto_rows": null, "grid_column": null, "grid_gap": null, "grid_row": null, "grid_template_areas": null, "grid_template_columns": null, "grid_template_rows": null, "height": "auto", "justify_content": null, "justify_items": null, "left": null, "margin": null, "max_height": null, "max_width": null, "min_height": null, "min_width": null, "object_fit": null, "object_position": null, "order": null, "overflow": null, "padding": "0.5em", "right": null, "top": null, "visibility": null, "width": "auto"}}, "6bbe19718f974f1480136313e1181c88": {"model_name": "ButtonStyleModel", "model_module": "@jupyter-widgets/controls", "model_module_version": "2.0.0", "state": {"_model_module": "@jupyter-widgets/controls", "_model_module_version": "2.0.0", "_model_name": "ButtonStyleModel", "_view_count": null, "_view_module": "@jupyter-widgets/base", "_view_module_version": "2.0.0", "_view_name": "StyleView", "button_color": "#aaffaa", "font_family": null, "font_size": "2em", "font_style": null, "font_variant": null, "font_weight": null, "text_color": null, "text_decoration": null}}, "64779943e15b45869b6cf19a8c235457": {"model_name": "ButtonModel", "model_module": "@jupyter-widgets/controls", "model_module_version": "2.0.0", "state": {"_dom_classes": ["happy"], "_model_module": "@jupyter-widgets/controls", "_model_module_version": "2.0.0", "_model_name": "ButtonModel", "_view_count": null, "_view_module": "@jupyter-widgets/controls", "_view_module_version": "2.0.0", "_view_name": "ButtonView", "button_style": "", "description": "\ud83d\ude42", "disabled": false, "icon": "", "layout": "IPY_MODEL_118612b386d844baa8c38cbab3653afc", "style": "IPY_MODEL_6bbe19718f974f1480136313e1181c88", "tabbable": null, "tooltip": "happy"}}, "af801f371d9a47aaa0c8cb5b7d6cd987": {"model_name": "LayoutModel", "model_module": "@jupyter-widgets/base", "model_module_version": "2.0.0", "state": {"_model_module": "@jupyter-widgets/base", "_model_module_version": "2.0.0", "_model_name": "LayoutModel", "_view_count": null, "_view_module": "@jupyter-widgets/base", "_view_module_version": "2.0.0", "_view_name": "LayoutView", "align_content": null, "align_items": null, "align_self": null, "border_bottom": null, "border_left": null, "border_right": null, "border_top": null, "bottom": null, "display": null, "flex": null, "flex_flow": null, "grid_area": null, "grid_auto_columns": null, "grid_auto_flow": null, "grid_auto_rows": null, "grid_column": null, "grid_gap": null, "grid_row": null, "grid_template_areas": null, "grid_template_columns": null, "grid_template_rows": null, "height": "auto", "justify_content": null, "justify_items": null, "left": null, "margin": null, "max_height": null, "max_width": null, "min_height": null, "min_width": null, "object_fit": null, "object_position": null, "order": null, "overflow": null, "padding": "0.5em", "right": null, "top": null, "visibility": null, "width": "auto"}}, "647629c11e044c14a4406a7bbad38950": {"model_name": "ButtonStyleModel", "model_module": "@jupyter-widgets/controls", "model_module_version": "2.0.0", "state": {"_model_module": "@jupyter-widgets/controls", "_model_module_version": "2.0.0", "_model_name": "ButtonStyleModel", "_view_count": null, "_view_module": "@jupyter-widgets/base", "_view_module_version": "2.0.0", "_view_name": "StyleView", "button_color": "#dddd77", "font_family": null, "font_size": "2em", "font_style": null, "font_variant": null, "font_weight": null, "text_color": null, "text_decoration": null}}, "0d3a0348d19e45a0b5ed1f1827e24e2a": {"model_name": "ButtonModel", "model_module": "@jupyter-widgets/controls", "model_module_version": "2.0.0", "state": {"_dom_classes": ["medium"], "_model_module": "@jupyter-widgets/controls", "_model_module_version": "2.0.0", "_model_name": "ButtonModel", "_view_count": null, "_view_module": "@jupyter-widgets/controls", "_view_module_version": "2.0.0", "_view_name": "ButtonView", "button_style": "", "description": "\ud83d\ude10", "disabled": false, "icon": "", "layout": "IPY_MODEL_af801f371d9a47aaa0c8cb5b7d6cd987", "style": "IPY_MODEL_647629c11e044c14a4406a7bbad38950", "tabbable": null, "tooltip": "medium"}}, "855cf4d8c70f4699a5797741b5ae29e9": {"model_name": "LayoutModel", "model_module": "@jupyter-widgets/base", "model_module_version": "2.0.0", "state": {"_model_module": "@jupyter-widgets/base", "_model_module_version": "2.0.0", "_model_name": "LayoutModel", "_view_count": null, "_view_module": "@jupyter-widgets/base", "_view_module_version": "2.0.0", "_view_name": "LayoutView", "align_content": null, "align_items": null, "align_self": null, "border_bottom": null, "border_left": null, "border_right": null, "border_top": null, "bottom": null, "display": null, "flex": null, "flex_flow": null, "grid_area": null, "grid_auto_columns": null, "grid_auto_flow": null, "grid_auto_rows": null, "grid_column": null, "grid_gap": null, "grid_row": null, "grid_template_areas": null, "grid_template_columns": null, "grid_template_rows": null, "height": "auto", "justify_content": null, "justify_items": null, "left": null, "margin": null, "max_height": null, "max_width": null, "min_height": null, "min_width": null, "object_fit": null, "object_position": null, "order": null, "overflow": null, "padding": "0.5em", "right": null, "top": null, "visibility": null, "width": "auto"}}, "e5c830feefe5414ba3ee5626bfe2b095": {"model_name": "ButtonStyleModel", "model_module": "@jupyter-widgets/controls", "model_module_version": "2.0.0", "state": {"_model_module": "@jupyter-widgets/controls", "_model_module_version": "2.0.0", "_model_name": "ButtonStyleModel", "_view_count": null, "_view_module": "@jupyter-widgets/base", "_view_module_version": "2.0.0", "_view_name": "StyleView", "button_color": "#ffaaaa", "font_family": null, "font_size": "2em", "font_style": null, "font_variant": null, "font_weight": null, "text_color": null, "text_decoration": null}}, "96b044f891e0456cade000cb754e83bc": {"model_name": "ButtonModel", "model_module": "@jupyter-widgets/controls", "model_module_version": "2.0.0", "state": {"_dom_classes": ["sad"], "_model_module": "@jupyter-widgets/controls", "_model_module_version": "2.0.0", "_model_name": "ButtonModel", "_view_count": null, "_view_module": "@jupyter-widgets/controls", "_view_module_version": "2.0.0", "_view_name": "ButtonView", "button_style": "", "description": "\ud83d\ude41", "disabled": false, "icon": "", "layout": "IPY_MODEL_855cf4d8c70f4699a5797741b5ae29e9", "style": "IPY_MODEL_e5c830feefe5414ba3ee5626bfe2b095", "tabbable": null, "tooltip": "sad"}}, "ca1c0a6dacbe4d54967dfaf79920ec05": {"model_name": "LayoutModel", "model_module": "@jupyter-widgets/base", "model_module_version": "2.0.0", "state": {"_model_module": "@jupyter-widgets/base", "_model_module_version": "2.0.0", "_model_name": "LayoutModel", "_view_count": null, "_view_module": "@jupyter-widgets/base", "_view_module_version": "2.0.0", "_view_name": "LayoutView", "align_content": null, "align_items": null, "align_self": null, "border_bottom": null, "border_left": null, "border_right": null, "border_top": null, "bottom": null, "display": null, "flex": null, "flex_flow": null, "grid_area": null, "grid_auto_columns": null, "grid_auto_flow": null, "grid_auto_rows": null, "grid_column": null, "grid_gap": null, "grid_row": null, "grid_template_areas": null, "grid_template_columns": null, "grid_template_rows": null, "height": "auto", "justify_content": null, "justify_items": null, "left": null, "margin": null, "max_height": null, "max_width": null, "min_height": null, "min_width": null, "object_fit": null, "object_position": null, "order": null, "overflow": null, "padding": null, "right": null, "top": null, "visibility": null, "width": "auto"}}, "f2d9ec2000484239bb95f7b4caee5213": {"model_name": "TextStyleModel", "model_module": "@jupyter-widgets/controls", "model_module_version": "2.0.0", "state": {"_model_module": "@jupyter-widgets/controls", "_model_module_version": "2.0.0", "_model_name": "TextStyleModel", "_view_count": null, "_view_module": "@jupyter-widgets/base", "_view_module_version": "2.0.0", "_view_name": "StyleView", "background": null, "description_width": "", "font_size": null, "text_color": null}}, "604fdeb0d5734edc8d63f9481a270470": {"model_name": "TextareaModel", "model_module": "@jupyter-widgets/controls", "model_module_version": "2.0.0", "state": {"_dom_classes": [], "_model_module": "@jupyter-widgets/controls", "_model_module_version": "2.0.0", "_model_name": "TextareaModel", "_view_count": null, "_view_module": "@jupyter-widgets/controls", "_view_module_version": "2.0.0", "_view_name": "TextareaView", "continuous_update": true, "description": "", "description_allow_html": false, "disabled": false, "layout": "IPY_MODEL_ca1c0a6dacbe4d54967dfaf79920ec05", "placeholder": "We want your feedback!", "rows": null, "style": "IPY_MODEL_f2d9ec2000484239bb95f7b4caee5213", "tabbable": null, "tooltip": null, "value": ""}}, "7fbfeac314ec40cb8accf25ba99e4344": {"model_name": "LayoutModel", "model_module": "@jupyter-widgets/base", "model_module_version": "2.0.0", "state": {"_model_module": "@jupyter-widgets/base", "_model_module_version": "2.0.0", "_model_name": "LayoutModel", "_view_count": null, "_view_module": "@jupyter-widgets/base", "_view_module_version": "2.0.0", "_view_name": "LayoutView", "align_content": null, "align_items": null, "align_self": null, "border_bottom": null, "border_left": null, "border_right": null, "border_top": null, "bottom": null, "display": null, "flex": null, "flex_flow": null, "grid_area": null, "grid_auto_columns": null, "grid_auto_flow": null, "grid_auto_rows": null, "grid_column": null, "grid_gap": null, "grid_row": null, "grid_template_areas": null, "grid_template_columns": null, "grid_template_rows": null, "height": "auto", "justify_content": null, "justify_items": null, "left": null, "margin": null, "max_height": null, "max_width": null, "min_height": null, "min_width": null, "object_fit": null, "object_position": null, "order": null, "overflow": null, "padding": null, "right": null, "top": null, "visibility": null, "width": "auto"}}, "42000155949844e7a1a6e0cacfb0ab7d": {"model_name": "ButtonStyleModel", "model_module": "@jupyter-widgets/controls", "model_module_version": "2.0.0", "state": {"_model_module": "@jupyter-widgets/controls", "_model_module_version": "2.0.0", "_model_name": "ButtonStyleModel", "_view_count": null, "_view_module": "@jupyter-widgets/base", "_view_module_version": "2.0.0", "_view_name": "StyleView", "button_color": null, "font_family": null, "font_size": null, "font_style": null, "font_variant": null, "font_weight": null, "text_color": null, "text_decoration": null}}, "22f1fed3b4964d66b3b97b586686e45d": {"model_name": "ButtonModel", "model_module": "@jupyter-widgets/controls", "model_module_version": "2.0.0", "state": {"_dom_classes": [], "_model_module": "@jupyter-widgets/controls", "_model_module_version": "2.0.0", "_model_name": "ButtonModel", "_view_count": null, "_view_module": "@jupyter-widgets/controls", "_view_module_version": "2.0.0", "_view_name": "ButtonView", "button_style": "", "description": "Submit", "disabled": false, "icon": "", "layout": "IPY_MODEL_7fbfeac314ec40cb8accf25ba99e4344", "style": "IPY_MODEL_42000155949844e7a1a6e0cacfb0ab7d", "tabbable": null, "tooltip": null}}, "034302e4b04d4a97b80e57c6a1996ba0": {"model_name": "LayoutModel", "model_module": "@jupyter-widgets/base", "model_module_version": "2.0.0", "state": {"_model_module": "@jupyter-widgets/base", "_model_module_version": "2.0.0", "_model_name": "LayoutModel", "_view_count": null, "_view_module": "@jupyter-widgets/base", "_view_module_version": "2.0.0", "_view_name": "LayoutView", "align_content": null, "align_items": null, "align_self": null, "border_bottom": null, "border_left": null, "border_right": null, "border_top": null, "bottom": null, "display": "none", "flex": null, "flex_flow": null, "grid_area": null, "grid_auto_columns": null, "grid_auto_flow": null, "grid_auto_rows": null, "grid_column": null, "grid_gap": null, "grid_row": null, "grid_template_areas": null, "grid_template_columns": null, "grid_template_rows": null, "height": null, "justify_content": null, "justify_items": null, "left": null, "margin": null, "max_height": null, "max_width": null, "min_height": null, "min_width": null, "object_fit": null, "object_position": null, "order": null, "overflow": null, "padding": null, "right": null, "top": null, "visibility": null, "width": null}}, "22495cf527c2437c8e91f19ba3e26893": {"model_name": "HBoxModel", "model_module": "@jupyter-widgets/controls", "model_module_version": "2.0.0", "state": {"_dom_classes": [], "_model_module": "@jupyter-widgets/controls", "_model_module_version": "2.0.0", "_model_name": "HBoxModel", "_view_count": null, "_view_module": "@jupyter-widgets/controls", "_view_module_version": "2.0.0", "_view_name": "HBoxView", "box_style": "", "children": ["IPY_MODEL_604fdeb0d5734edc8d63f9481a270470", "IPY_MODEL_22f1fed3b4964d66b3b97b586686e45d"], "layout": "IPY_MODEL_034302e4b04d4a97b80e57c6a1996ba0", "tabbable": null, "tooltip": null}}, "e062bc0a5c43423890c1c40178439037": {"model_name": "LayoutModel", "model_module": "@jupyter-widgets/base", "model_module_version": "2.0.0", "state": {"_model_module": "@jupyter-widgets/base", "_model_module_version": "2.0.0", "_model_name": "LayoutModel", "_view_count": null, "_view_module": "@jupyter-widgets/base", "_view_module_version": "2.0.0", "_view_name": "LayoutView", "align_content": null, "align_items": null, "align_self": null, "border_bottom": null, "border_left": null, "border_right": null, "border_top": null, "bottom": null, "display": "none", "flex": null, "flex_flow": null, "grid_area": null, "grid_auto_columns": null, "grid_auto_flow": null, "grid_auto_rows": null, "grid_column": null, "grid_gap": null, "grid_row": null, "grid_template_areas": null, "grid_template_columns": null, "grid_template_rows": null, "height": null, "justify_content": null, "justify_items": null, "left": null, "margin": null, "max_height": null, "max_width": null, "min_height": null, "min_width": null, "object_fit": null, "object_position": null, "order": null, "overflow": null, "padding": null, "right": null, "top": null, "visibility": null, "width": null}}, "5f371ef03afc4addb8060394e783b556": {"model_name": "LabelStyleModel", "model_module": "@jupyter-widgets/controls", "model_module_version": "2.0.0", "state": {"_model_module": "@jupyter-widgets/controls", "_model_module_version": "2.0.0", "_model_name": "LabelStyleModel", "_view_count": null, "_view_module": "@jupyter-widgets/base", "_view_module_version": "2.0.0", "_view_name": "StyleView", "background": null, "description_width": "", "font_family": null, "font_size": null, "font_style": null, "font_variant": null, "font_weight": null, "text_color": null, "text_decoration": null}}, "67f2ab5a1d3c46a48c52ee7dc495b276": {"model_name": "LabelModel", "model_module": "@jupyter-widgets/controls", "model_module_version": "2.0.0", "state": {"_dom_classes": [], "_model_module": "@jupyter-widgets/controls", "_model_module_version": "2.0.0", "_model_name": "LabelModel", "_view_count": null, "_view_module": "@jupyter-widgets/controls", "_view_module_version": "2.0.0", "_view_name": "LabelView", "description": "", "description_allow_html": false, "layout": "IPY_MODEL_e062bc0a5c43423890c1c40178439037", "placeholder": "\u200b", "style": "IPY_MODEL_5f371ef03afc4addb8060394e783b556", "tabbable": null, "tooltip": null, "value": "Thanks for your feedback!"}}, "fb8f215d113b499785d8f91bb845cae8": {"model_name": "LayoutModel", "model_module": "@jupyter-widgets/base", "model_module_version": "2.0.0", "state": {"_model_module": "@jupyter-widgets/base", "_model_module_version": "2.0.0", "_model_name": "LayoutModel", "_view_count": null, "_view_module": "@jupyter-widgets/base", "_view_module_version": "2.0.0", "_view_name": "LayoutView", "align_content": null, "align_items": null, "align_self": null, "border_bottom": null, "border_left": null, "border_right": null, "border_top": null, "bottom": null, "display": null, "flex": null, "flex_flow": null, "grid_area": null, "grid_auto_columns": null, "grid_auto_flow": null, "grid_auto_rows": null, "grid_column": null, "grid_gap": null, "grid_row": null, "grid_template_areas": null, "grid_template_columns": null, "grid_template_rows": null, "height": null, "justify_content": null, "justify_items": null, "left": null, "margin": null, "max_height": null, "max_width": null, "min_height": null, "min_width": null, "object_fit": null, "object_position": null, "order": null, "overflow": null, "padding": null, "right": null, "top": null, "visibility": null, "width": null}}, "34a5a53a6e5e4b33b0a141c667633bcd": {"model_name": "HBoxModel", "model_module": "@jupyter-widgets/controls", "model_module_version": "2.0.0", "state": {"_dom_classes": [], "_model_module": "@jupyter-widgets/controls", "_model_module_version": "2.0.0", "_model_name": "HBoxModel", "_view_count": null, "_view_module": "@jupyter-widgets/controls", "_view_module_version": "2.0.0", "_view_name": "HBoxView", "box_style": "", "children": ["IPY_MODEL_64779943e15b45869b6cf19a8c235457", "IPY_MODEL_0d3a0348d19e45a0b5ed1f1827e24e2a", "IPY_MODEL_96b044f891e0456cade000cb754e83bc"], "layout": "IPY_MODEL_fb8f215d113b499785d8f91bb845cae8", "tabbable": null, "tooltip": null}}, "ce19a3a2515b433eb4d0323d2b2f77c5": {"model_name": "LayoutModel", "model_module": "@jupyter-widgets/base", "model_module_version": "2.0.0", "state": {"_model_module": "@jupyter-widgets/base", "_model_module_version": "2.0.0", "_model_name": "LayoutModel", "_view_count": null, "_view_module": "@jupyter-widgets/base", "_view_module_version": "2.0.0", "_view_name": "LayoutView", "align_content": null, "align_items": null, "align_self": null, "border_bottom": null, "border_left": null, "border_right": null, "border_top": null, "bottom": null, "display": null, "flex": null, "flex_flow": null, "grid_area": null, "grid_auto_columns": null, "grid_auto_flow": null, "grid_auto_rows": null, "grid_column": null, "grid_gap": null, "grid_row": null, "grid_template_areas": null, "grid_template_columns": null, "grid_template_rows": null, "height": null, "justify_content": null, "justify_items": null, "left": null, "margin": null, "max_height": null, "max_width": null, "min_height": null, "min_width": null, "object_fit": null, "object_position": null, "order": null, "overflow": null, "padding": null, "right": null, "top": null, "visibility": null, "width": null}}, "f42eceb730cb4fb6abdc12dc7ed35afe": {"model_name": "VBoxModel", "model_module": "@jupyter-widgets/controls", "model_module_version": "2.0.0", "state": {"_dom_classes": [], "_model_module": "@jupyter-widgets/controls", "_model_module_version": "2.0.0", "_model_name": "VBoxModel", "_view_count": null, "_view_module": "@jupyter-widgets/controls", "_view_module_version": "2.0.0", "_view_name": "VBoxView", "box_style": "", "children": ["IPY_MODEL_34a5a53a6e5e4b33b0a141c667633bcd", "IPY_MODEL_22495cf527c2437c8e91f19ba3e26893", "IPY_MODEL_67f2ab5a1d3c46a48c52ee7dc495b276"], "layout": "IPY_MODEL_ce19a3a2515b433eb4d0323d2b2f77c5", "tabbable": null, "tooltip": null}}, "8b85211e2a6c477ba91131676da08882": {"model_name": "LayoutModel", "model_module": "@jupyter-widgets/base", "model_module_version": "2.0.0", "state": {"_model_module": "@jupyter-widgets/base", "_model_module_version": "2.0.0", "_model_name": "LayoutModel", "_view_count": null, "_view_module": "@jupyter-widgets/base", "_view_module_version": "2.0.0", "_view_name": "LayoutView", "align_content": null, "align_items": null, "align_self": null, "border_bottom": null, "border_left": null, "border_right": null, "border_top": null, "bottom": null, "display": null, "flex": null, "flex_flow": null, "grid_area": null, "grid_auto_columns": null, "grid_auto_flow": null, "grid_auto_rows": null, "grid_column": null, "grid_gap": null, "grid_row": null, "grid_template_areas": null, "grid_template_columns": null, "grid_template_rows": null, "height": null, "justify_content": null, "justify_items": null, "left": null, "margin": null, "max_height": null, "max_width": null, "min_height": null, "min_width": null, "object_fit": null, "object_position": null, "order": null, "overflow": null, "padding": null, "right": null, "top": null, "visibility": null, "width": null}}, "57d3755db9df407b968acdcae7fdd67d": {"model_name": "VBoxModel", "model_module": "@jupyter-widgets/controls", "model_module_version": "2.0.0", "state": {"_dom_classes": [], "_model_module": "@jupyter-widgets/controls", "_model_module_version": "2.0.0", "_model_name": "VBoxModel", "_view_count": null, "_view_module": "@jupyter-widgets/controls", "_view_module_version": "2.0.0", "_view_name": "VBoxView", "box_style": "", "children": ["IPY_MODEL_f42eceb730cb4fb6abdc12dc7ed35afe"], "layout": "IPY_MODEL_8b85211e2a6c477ba91131676da08882", "tabbable": null, "tooltip": null}}, "27c6c14963b940e1b507cf65a93fae22": {"model_name": "LayoutModel", "model_module": "@jupyter-widgets/base", "model_module_version": "2.0.0", "state": {"_model_module": "@jupyter-widgets/base", "_model_module_version": "2.0.0", "_model_name": "LayoutModel", "_view_count": null, "_view_module": "@jupyter-widgets/base", "_view_module_version": "2.0.0", "_view_name": "LayoutView", "align_content": null, "align_items": null, "align_self": null, "border_bottom": null, "border_left": null, "border_right": null, "border_top": null, "bottom": null, "display": null, "flex": null, "flex_flow": null, "grid_area": null, "grid_auto_columns": null, "grid_auto_flow": null, "grid_auto_rows": null, "grid_column": null, "grid_gap": null, "grid_row": null, "grid_template_areas": null, "grid_template_columns": null, "grid_template_rows": null, "height": "auto", "justify_content": null, "justify_items": null, "left": null, "margin": null, "max_height": null, "max_width": null, "min_height": null, "min_width": null, "object_fit": null, "object_position": null, "order": null, "overflow": null, "padding": "0.5em", "right": null, "top": null, "visibility": null, "width": "auto"}}, "3353fdaf8da44e1c86818823d4e45a42": {"model_name": "ButtonStyleModel", "model_module": "@jupyter-widgets/controls", "model_module_version": "2.0.0", "state": {"_model_module": "@jupyter-widgets/controls", "_model_module_version": "2.0.0", "_model_name": "ButtonStyleModel", "_view_count": null, "_view_module": "@jupyter-widgets/base", "_view_module_version": "2.0.0", "_view_name": "StyleView", "button_color": "#aaffaa", "font_family": null, "font_size": "2em", "font_style": null, "font_variant": null, "font_weight": null, "text_color": null, "text_decoration": null}}, "f961df5ad1424f3cba956fddf067cc83": {"model_name": "ButtonModel", "model_module": "@jupyter-widgets/controls", "model_module_version": "2.0.0", "state": {"_dom_classes": ["happy"], "_model_module": "@jupyter-widgets/controls", "_model_module_version": "2.0.0", "_model_name": "ButtonModel", "_view_count": null, "_view_module": "@jupyter-widgets/controls", "_view_module_version": "2.0.0", "_view_name": "ButtonView", "button_style": "", "description": "\ud83d\ude42", "disabled": false, "icon": "", "layout": "IPY_MODEL_27c6c14963b940e1b507cf65a93fae22", "style": "IPY_MODEL_3353fdaf8da44e1c86818823d4e45a42", "tabbable": null, "tooltip": "happy"}}, "e9308e9367b04cf0bccb4e8f85f20375": {"model_name": "LayoutModel", "model_module": "@jupyter-widgets/base", "model_module_version": "2.0.0", "state": {"_model_module": "@jupyter-widgets/base", "_model_module_version": "2.0.0", "_model_name": "LayoutModel", "_view_count": null, "_view_module": "@jupyter-widgets/base", "_view_module_version": "2.0.0", "_view_name": "LayoutView", "align_content": null, "align_items": null, "align_self": null, "border_bottom": null, "border_left": null, "border_right": null, "border_top": null, "bottom": null, "display": null, "flex": null, "flex_flow": null, "grid_area": null, "grid_auto_columns": null, "grid_auto_flow": null, "grid_auto_rows": null, "grid_column": null, "grid_gap": null, "grid_row": null, "grid_template_areas": null, "grid_template_columns": null, "grid_template_rows": null, "height": "auto", "justify_content": null, "justify_items": null, "left": null, "margin": null, "max_height": null, "max_width": null, "min_height": null, "min_width": null, "object_fit": null, "object_position": null, "order": null, "overflow": null, "padding": "0.5em", "right": null, "top": null, "visibility": null, "width": "auto"}}, "248d4f16e3874918a70c91607e360e10": {"model_name": "ButtonStyleModel", "model_module": "@jupyter-widgets/controls", "model_module_version": "2.0.0", "state": {"_model_module": "@jupyter-widgets/controls", "_model_module_version": "2.0.0", "_model_name": "ButtonStyleModel", "_view_count": null, "_view_module": "@jupyter-widgets/base", "_view_module_version": "2.0.0", "_view_name": "StyleView", "button_color": "#dddd77", "font_family": null, "font_size": "2em", "font_style": null, "font_variant": null, "font_weight": null, "text_color": null, "text_decoration": null}}, "c025b676d7da442ca75b964da38a7e41": {"model_name": "ButtonModel", "model_module": "@jupyter-widgets/controls", "model_module_version": "2.0.0", "state": {"_dom_classes": ["medium"], "_model_module": "@jupyter-widgets/controls", "_model_module_version": "2.0.0", "_model_name": "ButtonModel", "_view_count": null, "_view_module": "@jupyter-widgets/controls", "_view_module_version": "2.0.0", "_view_name": "ButtonView", "button_style": "", "description": "\ud83d\ude10", "disabled": false, "icon": "", "layout": "IPY_MODEL_e9308e9367b04cf0bccb4e8f85f20375", "style": "IPY_MODEL_248d4f16e3874918a70c91607e360e10", "tabbable": null, "tooltip": "medium"}}, "00999fbe9e884e409054e06713c30050": {"model_name": "LayoutModel", "model_module": "@jupyter-widgets/base", "model_module_version": "2.0.0", "state": {"_model_module": "@jupyter-widgets/base", "_model_module_version": "2.0.0", "_model_name": "LayoutModel", "_view_count": null, "_view_module": "@jupyter-widgets/base", "_view_module_version": "2.0.0", "_view_name": "LayoutView", "align_content": null, "align_items": null, "align_self": null, "border_bottom": null, "border_left": null, "border_right": null, "border_top": null, "bottom": null, "display": null, "flex": null, "flex_flow": null, "grid_area": null, "grid_auto_columns": null, "grid_auto_flow": null, "grid_auto_rows": null, "grid_column": null, "grid_gap": null, "grid_row": null, "grid_template_areas": null, "grid_template_columns": null, "grid_template_rows": null, "height": "auto", "justify_content": null, "justify_items": null, "left": null, "margin": null, "max_height": null, "max_width": null, "min_height": null, "min_width": null, "object_fit": null, "object_position": null, "order": null, "overflow": null, "padding": "0.5em", "right": null, "top": null, "visibility": null, "width": "auto"}}, "41d99aea439945208907f183d7129979": {"model_name": "ButtonStyleModel", "model_module": "@jupyter-widgets/controls", "model_module_version": "2.0.0", "state": {"_model_module": "@jupyter-widgets/controls", "_model_module_version": "2.0.0", "_model_name": "ButtonStyleModel", "_view_count": null, "_view_module": "@jupyter-widgets/base", "_view_module_version": "2.0.0", "_view_name": "StyleView", "button_color": "#ffaaaa", "font_family": null, "font_size": "2em", "font_style": null, "font_variant": null, "font_weight": null, "text_color": null, "text_decoration": null}}, "f61e458b65dc46b5a1c9d44d3757ca85": {"model_name": "ButtonModel", "model_module": "@jupyter-widgets/controls", "model_module_version": "2.0.0", "state": {"_dom_classes": ["sad"], "_model_module": "@jupyter-widgets/controls", "_model_module_version": "2.0.0", "_model_name": "ButtonModel", "_view_count": null, "_view_module": "@jupyter-widgets/controls", "_view_module_version": "2.0.0", "_view_name": "ButtonView", "button_style": "", "description": "\ud83d\ude41", "disabled": false, "icon": "", "layout": "IPY_MODEL_00999fbe9e884e409054e06713c30050", "style": "IPY_MODEL_41d99aea439945208907f183d7129979", "tabbable": null, "tooltip": "sad"}}, "d16ca368e6474fa1bb8287f0fe81585b": {"model_name": "LayoutModel", "model_module": "@jupyter-widgets/base", "model_module_version": "2.0.0", "state": {"_model_module": "@jupyter-widgets/base", "_model_module_version": "2.0.0", "_model_name": "LayoutModel", "_view_count": null, "_view_module": "@jupyter-widgets/base", "_view_module_version": "2.0.0", "_view_name": "LayoutView", "align_content": null, "align_items": null, "align_self": null, "border_bottom": null, "border_left": null, "border_right": null, "border_top": null, "bottom": null, "display": null, "flex": null, "flex_flow": null, "grid_area": null, "grid_auto_columns": null, "grid_auto_flow": null, "grid_auto_rows": null, "grid_column": null, "grid_gap": null, "grid_row": null, "grid_template_areas": null, "grid_template_columns": null, "grid_template_rows": null, "height": "auto", "justify_content": null, "justify_items": null, "left": null, "margin": null, "max_height": null, "max_width": null, "min_height": null, "min_width": null, "object_fit": null, "object_position": null, "order": null, "overflow": null, "padding": null, "right": null, "top": null, "visibility": null, "width": "auto"}}, "c5fef86f283048be838525dda09cb3f2": {"model_name": "TextStyleModel", "model_module": "@jupyter-widgets/controls", "model_module_version": "2.0.0", "state": {"_model_module": "@jupyter-widgets/controls", "_model_module_version": "2.0.0", "_model_name": "TextStyleModel", "_view_count": null, "_view_module": "@jupyter-widgets/base", "_view_module_version": "2.0.0", "_view_name": "StyleView", "background": null, "description_width": "", "font_size": null, "text_color": null}}, "2e3e478089804f45858a312e408fa90f": {"model_name": "TextareaModel", "model_module": "@jupyter-widgets/controls", "model_module_version": "2.0.0", "state": {"_dom_classes": [], "_model_module": "@jupyter-widgets/controls", "_model_module_version": "2.0.0", "_model_name": "TextareaModel", "_view_count": null, "_view_module": "@jupyter-widgets/controls", "_view_module_version": "2.0.0", "_view_name": "TextareaView", "continuous_update": true, "description": "", "description_allow_html": false, "disabled": false, "layout": "IPY_MODEL_d16ca368e6474fa1bb8287f0fe81585b", "placeholder": "We want your feedback!", "rows": null, "style": "IPY_MODEL_c5fef86f283048be838525dda09cb3f2", "tabbable": null, "tooltip": null, "value": ""}}, "5f4120472dc5494681f62c8d68dc8375": {"model_name": "LayoutModel", "model_module": "@jupyter-widgets/base", "model_module_version": "2.0.0", "state": {"_model_module": "@jupyter-widgets/base", "_model_module_version": "2.0.0", "_model_name": "LayoutModel", "_view_count": null, "_view_module": "@jupyter-widgets/base", "_view_module_version": "2.0.0", "_view_name": "LayoutView", "align_content": null, "align_items": null, "align_self": null, "border_bottom": null, "border_left": null, "border_right": null, "border_top": null, "bottom": null, "display": null, "flex": null, "flex_flow": null, "grid_area": null, "grid_auto_columns": null, "grid_auto_flow": null, "grid_auto_rows": null, "grid_column": null, "grid_gap": null, "grid_row": null, "grid_template_areas": null, "grid_template_columns": null, "grid_template_rows": null, "height": "auto", "justify_content": null, "justify_items": null, "left": null, "margin": null, "max_height": null, "max_width": null, "min_height": null, "min_width": null, "object_fit": null, "object_position": null, "order": null, "overflow": null, "padding": null, "right": null, "top": null, "visibility": null, "width": "auto"}}, "5d149edd3b1b4efebad63e3fbc39b733": {"model_name": "ButtonStyleModel", "model_module": "@jupyter-widgets/controls", "model_module_version": "2.0.0", "state": {"_model_module": "@jupyter-widgets/controls", "_model_module_version": "2.0.0", "_model_name": "ButtonStyleModel", "_view_count": null, "_view_module": "@jupyter-widgets/base", "_view_module_version": "2.0.0", "_view_name": "StyleView", "button_color": null, "font_family": null, "font_size": null, "font_style": null, "font_variant": null, "font_weight": null, "text_color": null, "text_decoration": null}}, "8460a019f9ac43db89c3b6cb9efc95bf": {"model_name": "ButtonModel", "model_module": "@jupyter-widgets/controls", "model_module_version": "2.0.0", "state": {"_dom_classes": [], "_model_module": "@jupyter-widgets/controls", "_model_module_version": "2.0.0", "_model_name": "ButtonModel", "_view_count": null, "_view_module": "@jupyter-widgets/controls", "_view_module_version": "2.0.0", "_view_name": "ButtonView", "button_style": "", "description": "Submit", "disabled": false, "icon": "", "layout": "IPY_MODEL_5f4120472dc5494681f62c8d68dc8375", "style": "IPY_MODEL_5d149edd3b1b4efebad63e3fbc39b733", "tabbable": null, "tooltip": null}}, "2c3da7dfa89c4528bd92c8faa5bda3d1": {"model_name": "LayoutModel", "model_module": "@jupyter-widgets/base", "model_module_version": "2.0.0", "state": {"_model_module": "@jupyter-widgets/base", "_model_module_version": "2.0.0", "_model_name": "LayoutModel", "_view_count": null, "_view_module": "@jupyter-widgets/base", "_view_module_version": "2.0.0", "_view_name": "LayoutView", "align_content": null, "align_items": null, "align_self": null, "border_bottom": null, "border_left": null, "border_right": null, "border_top": null, "bottom": null, "display": "none", "flex": null, "flex_flow": null, "grid_area": null, "grid_auto_columns": null, "grid_auto_flow": null, "grid_auto_rows": null, "grid_column": null, "grid_gap": null, "grid_row": null, "grid_template_areas": null, "grid_template_columns": null, "grid_template_rows": null, "height": null, "justify_content": null, "justify_items": null, "left": null, "margin": null, "max_height": null, "max_width": null, "min_height": null, "min_width": null, "object_fit": null, "object_position": null, "order": null, "overflow": null, "padding": null, "right": null, "top": null, "visibility": null, "width": null}}, "59e5a4a89d0642fa9b53845321593897": {"model_name": "HBoxModel", "model_module": "@jupyter-widgets/controls", "model_module_version": "2.0.0", "state": {"_dom_classes": [], "_model_module": "@jupyter-widgets/controls", "_model_module_version": "2.0.0", "_model_name": "HBoxModel", "_view_count": null, "_view_module": "@jupyter-widgets/controls", "_view_module_version": "2.0.0", "_view_name": "HBoxView", "box_style": "", "children": ["IPY_MODEL_2e3e478089804f45858a312e408fa90f", "IPY_MODEL_8460a019f9ac43db89c3b6cb9efc95bf"], "layout": "IPY_MODEL_2c3da7dfa89c4528bd92c8faa5bda3d1", "tabbable": null, "tooltip": null}}, "343a4afd37d54ef8a910c4fe3fc48931": {"model_name": "LayoutModel", "model_module": "@jupyter-widgets/base", "model_module_version": "2.0.0", "state": {"_model_module": "@jupyter-widgets/base", "_model_module_version": "2.0.0", "_model_name": "LayoutModel", "_view_count": null, "_view_module": "@jupyter-widgets/base", "_view_module_version": "2.0.0", "_view_name": "LayoutView", "align_content": null, "align_items": null, "align_self": null, "border_bottom": null, "border_left": null, "border_right": null, "border_top": null, "bottom": null, "display": "none", "flex": null, "flex_flow": null, "grid_area": null, "grid_auto_columns": null, "grid_auto_flow": null, "grid_auto_rows": null, "grid_column": null, "grid_gap": null, "grid_row": null, "grid_template_areas": null, "grid_template_columns": null, "grid_template_rows": null, "height": null, "justify_content": null, "justify_items": null, "left": null, "margin": null, "max_height": null, "max_width": null, "min_height": null, "min_width": null, "object_fit": null, "object_position": null, "order": null, "overflow": null, "padding": null, "right": null, "top": null, "visibility": null, "width": null}}, "0478fb5a7adb47a0b47964cff5b14504": {"model_name": "LabelStyleModel", "model_module": "@jupyter-widgets/controls", "model_module_version": "2.0.0", "state": {"_model_module": "@jupyter-widgets/controls", "_model_module_version": "2.0.0", "_model_name": "LabelStyleModel", "_view_count": null, "_view_module": "@jupyter-widgets/base", "_view_module_version": "2.0.0", "_view_name": "StyleView", "background": null, "description_width": "", "font_family": null, "font_size": null, "font_style": null, "font_variant": null, "font_weight": null, "text_color": null, "text_decoration": null}}, "75c7a4c7c68b4475b53f91ef49806a16": {"model_name": "LabelModel", "model_module": "@jupyter-widgets/controls", "model_module_version": "2.0.0", "state": {"_dom_classes": [], "_model_module": "@jupyter-widgets/controls", "_model_module_version": "2.0.0", "_model_name": "LabelModel", "_view_count": null, "_view_module": "@jupyter-widgets/controls", "_view_module_version": "2.0.0", "_view_name": "LabelView", "description": "", "description_allow_html": false, "layout": "IPY_MODEL_343a4afd37d54ef8a910c4fe3fc48931", "placeholder": "\u200b", "style": "IPY_MODEL_0478fb5a7adb47a0b47964cff5b14504", "tabbable": null, "tooltip": null, "value": "Thanks for your feedback!"}}, "4683c2997ce542cbba52f2080d62f59d": {"model_name": "LayoutModel", "model_module": "@jupyter-widgets/base", "model_module_version": "2.0.0", "state": {"_model_module": "@jupyter-widgets/base", "_model_module_version": "2.0.0", "_model_name": "LayoutModel", "_view_count": null, "_view_module": "@jupyter-widgets/base", "_view_module_version": "2.0.0", "_view_name": "LayoutView", "align_content": null, "align_items": null, "align_self": null, "border_bottom": null, "border_left": null, "border_right": null, "border_top": null, "bottom": null, "display": null, "flex": null, "flex_flow": null, "grid_area": null, "grid_auto_columns": null, "grid_auto_flow": null, "grid_auto_rows": null, "grid_column": null, "grid_gap": null, "grid_row": null, "grid_template_areas": null, "grid_template_columns": null, "grid_template_rows": null, "height": null, "justify_content": null, "justify_items": null, "left": null, "margin": null, "max_height": null, "max_width": null, "min_height": null, "min_width": null, "object_fit": null, "object_position": null, "order": null, "overflow": null, "padding": null, "right": null, "top": null, "visibility": null, "width": null}}, "0095e0e262764bf39cbae68dd3c46b34": {"model_name": "HBoxModel", "model_module": "@jupyter-widgets/controls", "model_module_version": "2.0.0", "state": {"_dom_classes": [], "_model_module": "@jupyter-widgets/controls", "_model_module_version": "2.0.0", "_model_name": "HBoxModel", "_view_count": null, "_view_module": "@jupyter-widgets/controls", "_view_module_version": "2.0.0", "_view_name": "HBoxView", "box_style": "", "children": ["IPY_MODEL_f961df5ad1424f3cba956fddf067cc83", "IPY_MODEL_c025b676d7da442ca75b964da38a7e41", "IPY_MODEL_f61e458b65dc46b5a1c9d44d3757ca85"], "layout": "IPY_MODEL_4683c2997ce542cbba52f2080d62f59d", "tabbable": null, "tooltip": null}}, "c664e8701fab4d8da43ac2eb9775b407": {"model_name": "LayoutModel", "model_module": "@jupyter-widgets/base", "model_module_version": "2.0.0", "state": {"_model_module": "@jupyter-widgets/base", "_model_module_version": "2.0.0", "_model_name": "LayoutModel", "_view_count": null, "_view_module": "@jupyter-widgets/base", "_view_module_version": "2.0.0", "_view_name": "LayoutView", "align_content": null, "align_items": null, "align_self": null, "border_bottom": null, "border_left": null, "border_right": null, "border_top": null, "bottom": null, "display": null, "flex": null, "flex_flow": null, "grid_area": null, "grid_auto_columns": null, "grid_auto_flow": null, "grid_auto_rows": null, "grid_column": null, "grid_gap": null, "grid_row": null, "grid_template_areas": null, "grid_template_columns": null, "grid_template_rows": null, "height": null, "justify_content": null, "justify_items": null, "left": null, "margin": null, "max_height": null, "max_width": null, "min_height": null, "min_width": null, "object_fit": null, "object_position": null, "order": null, "overflow": null, "padding": null, "right": null, "top": null, "visibility": null, "width": null}}, "7a7d13764a594d61ba059fd0bf1b0029": {"model_name": "VBoxModel", "model_module": "@jupyter-widgets/controls", "model_module_version": "2.0.0", "state": {"_dom_classes": [], "_model_module": "@jupyter-widgets/controls", "_model_module_version": "2.0.0", "_model_name": "VBoxModel", "_view_count": null, "_view_module": "@jupyter-widgets/controls", "_view_module_version": "2.0.0", "_view_name": "VBoxView", "box_style": "", "children": ["IPY_MODEL_0095e0e262764bf39cbae68dd3c46b34", "IPY_MODEL_59e5a4a89d0642fa9b53845321593897", "IPY_MODEL_75c7a4c7c68b4475b53f91ef49806a16"], "layout": "IPY_MODEL_c664e8701fab4d8da43ac2eb9775b407", "tabbable": null, "tooltip": null}}, "085d27b59b444ea1ab2b6292c6f29fef": {"model_name": "LayoutModel", "model_module": "@jupyter-widgets/base", "model_module_version": "2.0.0", "state": {"_model_module": "@jupyter-widgets/base", "_model_module_version": "2.0.0", "_model_name": "LayoutModel", "_view_count": null, "_view_module": "@jupyter-widgets/base", "_view_module_version": "2.0.0", "_view_name": "LayoutView", "align_content": null, "align_items": null, "align_self": null, "border_bottom": null, "border_left": null, "border_right": null, "border_top": null, "bottom": null, "display": null, "flex": null, "flex_flow": null, "grid_area": null, "grid_auto_columns": null, "grid_auto_flow": null, "grid_auto_rows": null, "grid_column": null, "grid_gap": null, "grid_row": null, "grid_template_areas": null, "grid_template_columns": null, "grid_template_rows": null, "height": null, "justify_content": null, "justify_items": null, "left": null, "margin": null, "max_height": null, "max_width": null, "min_height": null, "min_width": null, "object_fit": null, "object_position": null, "order": null, "overflow": null, "padding": null, "right": null, "top": null, "visibility": null, "width": null}}, "58d4f9d50c1f4fd89e731bc95fe9c5bc": {"model_name": "VBoxModel", "model_module": "@jupyter-widgets/controls", "model_module_version": "2.0.0", "state": {"_dom_classes": [], "_model_module": "@jupyter-widgets/controls", "_model_module_version": "2.0.0", "_model_name": "VBoxModel", "_view_count": null, "_view_module": "@jupyter-widgets/controls", "_view_module_version": "2.0.0", "_view_name": "VBoxView", "box_style": "", "children": ["IPY_MODEL_7a7d13764a594d61ba059fd0bf1b0029"], "layout": "IPY_MODEL_085d27b59b444ea1ab2b6292c6f29fef", "tabbable": null, "tooltip": null}}}, "version_major": 2, "version_minor": 0}</script>
<script crossorigin="anonymous" integrity="sha256-Ae2Vz/4ePdIu6ZyI/5ZGsYnb+m0JlOmKPjt6XZ9JJkA=" src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.4/require.min.js"></script>
<script crossorigin="anonymous" data-jupyter-widgets-cdn="https://cdn.jsdelivr.net/npm/" src="https://cdn.jsdelivr.net/npm/@jupyter-widgets/html-manager@1.0.6/dist/embed-amd.js"></script>
<script>DOCUMENTATION_OPTIONS.pagename = 'tutorials/W1D3_ComparingArtificialAndBiologicalNetworks/student/W1D3_Tutorial5';</script>
<link href="../../../_static/ai-logo.png" rel="shortcut icon">
<link href="../../../genindex.html" rel="index" title="Index">
<link href="../../../search.html" rel="search" title="Search"/>
<link href="W1D3_Outro.html" rel="next" title="Daily survey"/>
<link href="W1D3_Tutorial4.html" rel="prev" title="(Bonus) Tutorial 4: Representational geometry &amp; noise"/>
<meta content="width=device-width, initial-scale=1" name="viewport"/>
<meta content="en" name="docsearch:language"/>
</link></link></link></link></link></link></link></link></link></head>
<body data-default-mode="" data-offset="180" data-spy="scroll" data-target="#bd-toc-nav">
<a class="skip-link" href="#main-content">Skip to main content</a>
<input class="sidebar-toggle" id="__primary" name="__primary" type="checkbox"/>
<label class="overlay overlay-primary" for="__primary"></label>
<input class="sidebar-toggle" id="__secondary" name="__secondary" type="checkbox"/>
<label class="overlay overlay-secondary" for="__secondary"></label>
<div class="search-button__wrapper">
<div class="search-button__overlay"></div>
<div class="search-button__search-container">
<form action="../../../search.html" class="bd-search d-flex align-items-center" method="get">
<i class="fa-solid fa-magnifying-glass"></i>
<input aria-label="Search this book..." autocapitalize="off" autocomplete="off" autocorrect="off" class="form-control" id="search-input" name="q" placeholder="Search this book..." spellcheck="false" type="search"/>
<span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd>K</kbd></span>
</form>
</div>
</div>
<nav class="bd-header navbar navbar-expand-lg bd-navbar" id="navbar-main"><div class="bd-header__inner bd-page-width">
<label class="sidebar-toggle primary-toggle" for="__primary">
<span class="fa-solid fa-bars"></span>
</label>
<div id="navbar-start">
<a class="navbar-brand logo" href="../../intro.html">
<img alt="Logo image" class="logo__image only-light" src="../../../_static/ai-logo.png"/>
<img alt="Logo image" class="logo__image only-dark" src="../../../_static/ai-logo.png"/>
</a>
</div>
<div class="col-lg-9 navbar-header-items">
<div class="mr-auto" id="navbar-center">
<div class="navbar-center-item">
<nav class="navbar-nav">
<p aria-label="Site Navigation" aria-level="1" class="sidebar-header-items__title" role="heading">
        Site Navigation
    </p>
<ul class="navbar-nav" id="navbar-main-elements">
<li class="nav-item">
<a class="nav-link nav-internal" href="../../Schedule/schedule_intro.html">
                        Schedule
                      </a>
</li>
<li class="nav-item">
<a class="nav-link nav-internal" href="../../TechnicalHelp/tech_intro.html">
                        Technical Help
                      </a>
</li>
<li class="nav-item">
<a class="nav-link nav-internal" href="../../TechnicalHelp/Links_Policy.html">
                        Quick links and policies
                      </a>
</li>
<li class="nav-item">
<a class="nav-link nav-internal" href="../../../prereqs/NeuroAI.html">
                        Prerequisites and preparatory materials for NeuroAI course
                      </a>
</li>
<li class="nav-item">
<a class="nav-link nav-internal" href="../../W1D1_Generalization/chapter_title.html">
                        Generalization (W1D1)
                      </a>
</li>
<div class="nav-item dropdown">
<button aria-expanded="false" aria-haspopup="true" class="btn dropdown-toggle nav-item" data-toggle="dropdown" type="button">
                    More
                </button>
<div class="dropdown-menu">
<li class="nav-item">
<a class="nav-link nav-internal" href="../../W1D2_ComparingTasks/chapter_title.html">
                        Comparing Tasks (W1D2)
                      </a>
</li>
<li class="nav-item current active">
<a class="nav-link nav-internal" href="../chapter_title.html">
                        Comparing Artificial And Biological Networks (W1D3)
                      </a>
</li>
<li class="nav-item">
<a class="nav-link nav-internal" href="../../W1D5_Microcircuits/chapter_title.html">
                        Microcircuits (W1D5)
                      </a>
</li>
<li class="nav-item">
<a class="nav-link nav-internal" href="../../W2D1_Macrocircuits/chapter_title.html">
                        Macrocircuits (W2D1)
                      </a>
</li>
<li class="nav-item">
<a class="nav-link nav-internal" href="../../W2D2_NeuroSymbolicMethods/chapter_title.html">
                        Neuro Symbolic Methods (W2D2)
                      </a>
</li>
<li class="nav-item">
<a class="nav-link nav-internal" href="../../W2D3_Microlearning/chapter_title.html">
                        Microlearning (W2D3)
                      </a>
</li>
<li class="nav-item">
<a class="nav-link nav-internal" href="../../W2D4_Macrolearning/chapter_title.html">
                        Macrolearning (W2D4)
                      </a>
</li>
<li class="nav-item">
<a class="nav-link nav-internal" href="../../W2D5_Mysteries/chapter_title.html">
                        Mysteries (W2D5)
                      </a>
</li>
<li class="nav-item">
<a class="nav-link nav-internal" href="../../../projects/README.html">
                        Introduction
                      </a>
</li>
<li class="nav-item">
<a class="nav-link nav-internal" href="../../../projects/docs/project_guidance.html">
                        Daily guide for projects
                      </a>
</li>
<li class="nav-item">
<a class="nav-link nav-internal" href="../../../projects/docs/continuing_your_project_after_the_course.html">
                        Continuing your project after the course
                      </a>
</li>
<li class="nav-item">
<a class="nav-link nav-internal" href="../../../projects/docs/datasets_overview.html">
                        Project materials
                      </a>
</li>
<li class="nav-item">
<a class="nav-link nav-internal" href="../../../projects/professional_development/README.html">
                        Introduction
                      </a>
</li>
<li class="nav-item">
<a class="nav-link nav-internal" href="../../../projects/professional_development/mentorship_program.html">
                        Mentorship Program
                      </a>
</li>
</div>
</div>
</ul>
</nav>
</div>
</div>
<div id="navbar-end">
<div class="navbar-end-item navbar-persistent--container">
<button aria-label="Search" class="btn btn-sm navbar-btn search-button search-button__button" data-toggle="tooltip" title="Search">
<i class="fa-solid fa-magnifying-glass"></i>
</button>
</div>
<div class="navbar-end-item">
<button aria-label="light/dark" class="theme-switch-button btn btn-sm btn-outline-primary navbar-btn rounded-circle" data-toggle="tooltip" title="light/dark">
<span class="theme-switch" data-mode="light"><i class="fa-solid fa-sun"></i></span>
<span class="theme-switch" data-mode="dark"><i class="fa-solid fa-moon"></i></span>
<span class="theme-switch" data-mode="auto"><i class="fa-solid fa-circle-half-stroke"></i></span>
</button>
</div>
<div class="navbar-end-item">
<ul aria-label="Icon Links" class="navbar-nav" id="navbar-icon-links">
</ul>
</div>
</div>
</div>
<div class="navbar-persistent--mobile">
<button aria-label="Search" class="btn btn-sm navbar-btn search-button search-button__button" data-toggle="tooltip" title="Search">
<i class="fa-solid fa-magnifying-glass"></i>
</button>
</div>
<label class="sidebar-toggle secondary-toggle" for="__secondary">
<span class="fa-solid fa-outdent"></span>
</label>
</div>
</nav>
<div class="bd-container">
<div class="bd-container__inner bd-page-width">
<div class="bd-sidebar-primary bd-sidebar">
<div class="sidebar-header-items sidebar-primary__section">
<div class="sidebar-header-items__center">
<div class="navbar-center-item">
<nav class="navbar-nav">
<p aria-label="Site Navigation" aria-level="1" class="sidebar-header-items__title" role="heading">
        Site Navigation
    </p>
<ul class="navbar-nav" id="navbar-main-elements">
<li class="nav-item">
<a class="nav-link nav-internal" href="../../Schedule/schedule_intro.html">
                        Schedule
                      </a>
</li>
<li class="nav-item">
<a class="nav-link nav-internal" href="../../TechnicalHelp/tech_intro.html">
                        Technical Help
                      </a>
</li>
<li class="nav-item">
<a class="nav-link nav-internal" href="../../TechnicalHelp/Links_Policy.html">
                        Quick links and policies
                      </a>
</li>
<li class="nav-item">
<a class="nav-link nav-internal" href="../../../prereqs/NeuroAI.html">
                        Prerequisites and preparatory materials for NeuroAI course
                      </a>
</li>
<li class="nav-item">
<a class="nav-link nav-internal" href="../../W1D1_Generalization/chapter_title.html">
                        Generalization (W1D1)
                      </a>
</li>
<div class="nav-item dropdown">
<button aria-expanded="false" aria-haspopup="true" class="btn dropdown-toggle nav-item" data-toggle="dropdown" type="button">
                    More
                </button>
<div class="dropdown-menu">
<li class="nav-item">
<a class="nav-link nav-internal" href="../../W1D2_ComparingTasks/chapter_title.html">
                        Comparing Tasks (W1D2)
                      </a>
</li>
<li class="nav-item current active">
<a class="nav-link nav-internal" href="../chapter_title.html">
                        Comparing Artificial And Biological Networks (W1D3)
                      </a>
</li>
<li class="nav-item">
<a class="nav-link nav-internal" href="../../W1D5_Microcircuits/chapter_title.html">
                        Microcircuits (W1D5)
                      </a>
</li>
<li class="nav-item">
<a class="nav-link nav-internal" href="../../W2D1_Macrocircuits/chapter_title.html">
                        Macrocircuits (W2D1)
                      </a>
</li>
<li class="nav-item">
<a class="nav-link nav-internal" href="../../W2D2_NeuroSymbolicMethods/chapter_title.html">
                        Neuro Symbolic Methods (W2D2)
                      </a>
</li>
<li class="nav-item">
<a class="nav-link nav-internal" href="../../W2D3_Microlearning/chapter_title.html">
                        Microlearning (W2D3)
                      </a>
</li>
<li class="nav-item">
<a class="nav-link nav-internal" href="../../W2D4_Macrolearning/chapter_title.html">
                        Macrolearning (W2D4)
                      </a>
</li>
<li class="nav-item">
<a class="nav-link nav-internal" href="../../W2D5_Mysteries/chapter_title.html">
                        Mysteries (W2D5)
                      </a>
</li>
<li class="nav-item">
<a class="nav-link nav-internal" href="../../../projects/README.html">
                        Introduction
                      </a>
</li>
<li class="nav-item">
<a class="nav-link nav-internal" href="../../../projects/docs/project_guidance.html">
                        Daily guide for projects
                      </a>
</li>
<li class="nav-item">
<a class="nav-link nav-internal" href="../../../projects/docs/continuing_your_project_after_the_course.html">
                        Continuing your project after the course
                      </a>
</li>
<li class="nav-item">
<a class="nav-link nav-internal" href="../../../projects/docs/datasets_overview.html">
                        Project materials
                      </a>
</li>
<li class="nav-item">
<a class="nav-link nav-internal" href="../../../projects/professional_development/README.html">
                        Introduction
                      </a>
</li>
<li class="nav-item">
<a class="nav-link nav-internal" href="../../../projects/professional_development/mentorship_program.html">
                        Mentorship Program
                      </a>
</li>
</div>
</div>
</ul>
</nav>
</div>
</div>
<div class="sidebar-header-items__end">
<div class="navbar-end-item">
<button aria-label="light/dark" class="theme-switch-button btn btn-sm btn-outline-primary navbar-btn rounded-circle" data-toggle="tooltip" title="light/dark">
<span class="theme-switch" data-mode="light"><i class="fa-solid fa-sun"></i></span>
<span class="theme-switch" data-mode="dark"><i class="fa-solid fa-moon"></i></span>
<span class="theme-switch" data-mode="auto"><i class="fa-solid fa-circle-half-stroke"></i></span>
</button>
</div>
<div class="navbar-end-item">
<ul aria-label="Icon Links" class="navbar-nav" id="navbar-icon-links">
</ul>
</div>
</div>
</div>
<div class="sidebar-start-items sidebar-primary__section">
<div class="sidebar-start-items__item">
<a class="navbar-brand logo" href="../../intro.html">
<img alt="Logo image" class="logo__image only-light" src="../../../_static/ai-logo.png"/>
<img alt="Logo image" class="logo__image only-dark" src="../../../_static/ai-logo.png"/>
</a>
</div>
<div class="sidebar-start-items__item">
<form action="../../../search.html" class="bd-search d-flex align-items-center" method="get">
<i class="fa-solid fa-magnifying-glass"></i>
<input aria-label="Search this book..." autocapitalize="off" autocomplete="off" autocorrect="off" class="form-control" id="search-input" name="q" placeholder="Search this book..." spellcheck="false" type="search"/>
<span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd>K</kbd></span>
</form>
</div>
<div class="sidebar-start-items__item"><nav aria-label="Main" class="bd-links" id="bd-docs-nav">
<div class="bd-toc-item navbar-nav active">
<ul class="nav bd-sidenav bd-sidenav__home-link">
<li class="toctree-l1">
<a class="reference internal" href="../../intro.html">
                    Introduction
                </a>
</li>
</ul>
<ul class="nav bd-sidenav">
<li class="toctree-l1 has-children"><a class="reference internal" href="../../Schedule/schedule_intro.html">Schedule</a><input class="toctree-checkbox" id="toctree-checkbox-1" name="toctree-checkbox-1" type="checkbox"><label class="toctree-toggle" for="toctree-checkbox-1"><i class="fa-solid fa-chevron-down"></i></label><ul>
<li class="toctree-l2"><a class="reference internal" href="../../Schedule/daily_schedules.html">General schedule</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../Schedule/shared_calendars.html">Shared calendars</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../Schedule/timezone_widget.html">Timezone widget</a></li>
</ul>
</input></li>
</ul>
<ul class="nav bd-sidenav">
<li class="toctree-l1 has-children"><a class="reference internal" href="../../TechnicalHelp/tech_intro.html">Technical Help</a><input class="toctree-checkbox" id="toctree-checkbox-2" name="toctree-checkbox-2" type="checkbox"><label class="toctree-toggle" for="toctree-checkbox-2"><i class="fa-solid fa-chevron-down"></i></label><ul>
<li class="toctree-l2 has-children"><a class="reference internal" href="../../TechnicalHelp/Jupyterbook.html">Using jupyterbook</a><input class="toctree-checkbox" id="toctree-checkbox-3" name="toctree-checkbox-3" type="checkbox"><label class="toctree-toggle" for="toctree-checkbox-3"><i class="fa-solid fa-chevron-down"></i></label><ul>
<li class="toctree-l3"><a class="reference internal" href="../../TechnicalHelp/Tutorial_colab.html">Using Google Colab</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../TechnicalHelp/Tutorial_kaggle.html">Using Kaggle</a></li>
</ul>
</input></li>
<li class="toctree-l2"><a class="reference internal" href="../../TechnicalHelp/Discord.html">Using discord</a></li>
</ul>
</input></li>
</ul>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="../../TechnicalHelp/Links_Policy.html">Quick links and policies</a></li>
</ul>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="../../../prereqs/NeuroAI.html">Prerequisites and preparatory materials for NeuroAI course</a></li>
</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">Foundations</span></p>
<ul class="current nav bd-sidenav">
<li class="toctree-l1 has-children"><a class="reference internal" href="../../W1D1_Generalization/chapter_title.html">Generalization (W1D1)</a><input class="toctree-checkbox" id="toctree-checkbox-4" name="toctree-checkbox-4" type="checkbox"><label class="toctree-toggle" for="toctree-checkbox-4"><i class="fa-solid fa-chevron-down"></i></label><ul>
<li class="toctree-l2"><a class="reference internal" href="../../W1D1_Generalization/student/W1D1_Intro.html">Intro</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../W1D1_Generalization/student/W1D1_Tutorial1.html">Tutorial 1: Generalization in AI</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../W1D1_Generalization/student/W1D1_Tutorial2.html">Tutorial 2: Generalization in Neuroscience</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../W1D1_Generalization/student/W1D1_Tutorial3.html">Tutorial 3: Generalization in Cognitive Science</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../W1D1_Generalization/student/W1D1_Outro.html">Daily survey</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../W1D1_Generalization/further_reading.html">Suggested further readings</a></li>
</ul>
</input></li>
<li class="toctree-l1 has-children"><a class="reference internal" href="../../W1D2_ComparingTasks/chapter_title.html">Comparing Tasks (W1D2)</a><input class="toctree-checkbox" id="toctree-checkbox-5" name="toctree-checkbox-5" type="checkbox"/><label class="toctree-toggle" for="toctree-checkbox-5"><i class="fa-solid fa-chevron-down"></i></label><ul>
<li class="toctree-l2"><a class="reference internal" href="../../W1D2_ComparingTasks/student/W1D2_Intro.html">Intro</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../W1D2_ComparingTasks/student/W1D2_Tutorial1.html">Tutorial 1: Task definition, application, relations and impacts on generalization</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../W1D2_ComparingTasks/student/W1D2_Tutorial2.html">Tutorial 2: Contrastive learning for object recognition</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../W1D2_ComparingTasks/student/W1D2_Tutorial3.html">Tutorial 3: Reinforcement learning across temporal scales</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../W1D2_ComparingTasks/student/W1D2_Outro.html">Daily survey</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../W1D2_ComparingTasks/further_reading.html">Suggested further readings</a></li>
</ul>
</li>
<li class="toctree-l1 current active has-children"><a class="reference internal" href="../chapter_title.html">Comparing Artificial And Biological Networks (W1D3)</a><input checked="" class="toctree-checkbox" id="toctree-checkbox-6" name="toctree-checkbox-6" type="checkbox"/><label class="toctree-toggle" for="toctree-checkbox-6"><i class="fa-solid fa-chevron-down"></i></label><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="W1D3_Intro.html">Intro</a></li>
<li class="toctree-l2"><a class="reference internal" href="W1D3_Tutorial1.html">Tutorial 1: Generalization and representational geometry</a></li>
<li class="toctree-l2"><a class="reference internal" href="W1D3_Tutorial2.html">Tutorial 2: Computation as transformation of representational geometries</a></li>
<li class="toctree-l2"><a class="reference internal" href="W1D3_Tutorial3.html">Tutorial 3: Statistical inference on representational geometries</a></li>
<li class="toctree-l2"><a class="reference internal" href="W1D3_Tutorial4.html">(Bonus) Tutorial 4: Representational geometry &amp; noise</a></li>
<li class="toctree-l2 current active"><a class="current reference internal" href="#">Tutorial 5: Dynamical Similarity Analysis (DSA)</a></li>
<li class="toctree-l2"><a class="reference internal" href="W1D3_Outro.html">Daily survey</a></li>
<li class="toctree-l2"><a class="reference internal" href="../further_reading.html">Suggested further readings</a></li>
</ul>
</li>
</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">Architectures</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1 has-children"><a class="reference internal" href="../../W1D5_Microcircuits/chapter_title.html">Microcircuits (W1D5)</a><input class="toctree-checkbox" id="toctree-checkbox-7" name="toctree-checkbox-7" type="checkbox"/><label class="toctree-toggle" for="toctree-checkbox-7"><i class="fa-solid fa-chevron-down"></i></label><ul>
<li class="toctree-l2"><a class="reference internal" href="../../W1D5_Microcircuits/student/W1D5_Intro.html">Intro</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../W1D5_Microcircuits/student/W1D5_Tutorial1.html">Tutorial 1: Sparsity and Sparse Coding</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../W1D5_Microcircuits/student/W1D5_Tutorial2.html">Tutorial 2: Normalization</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../W1D5_Microcircuits/student/W1D5_Tutorial3.html">Tutorial 3: Attention</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../W1D5_Microcircuits/student/W1D5_Outro.html">Daily survey</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../W1D5_Microcircuits/further_reading.html">Suggested further readings</a></li>
</ul>
</li>
<li class="toctree-l1 has-children"><a class="reference internal" href="../../W2D1_Macrocircuits/chapter_title.html">Macrocircuits (W2D1)</a><input class="toctree-checkbox" id="toctree-checkbox-8" name="toctree-checkbox-8" type="checkbox"/><label class="toctree-toggle" for="toctree-checkbox-8"><i class="fa-solid fa-chevron-down"></i></label><ul>
<li class="toctree-l2"><a class="reference internal" href="../../W2D1_Macrocircuits/student/W2D1_Intro.html">Intro</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../W2D1_Macrocircuits/student/W2D1_Tutorial1.html">Tutorial 1: Depth vs width</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../W2D1_Macrocircuits/student/W2D1_Tutorial2.html">Tutorial 2: Double descent</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../W2D1_Macrocircuits/student/W2D1_Tutorial3.html">Tutorial 3: Neural network modularity</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../W2D1_Macrocircuits/student/W2D1_Outro.html">Daily survey</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../W2D1_Macrocircuits/further_reading.html">Suggested further readings</a></li>
</ul>
</li>
<li class="toctree-l1 has-children"><a class="reference internal" href="../../W2D2_NeuroSymbolicMethods/chapter_title.html">Neuro Symbolic Methods (W2D2)</a><input class="toctree-checkbox" id="toctree-checkbox-9" name="toctree-checkbox-9" type="checkbox"/><label class="toctree-toggle" for="toctree-checkbox-9"><i class="fa-solid fa-chevron-down"></i></label><ul>
<li class="toctree-l2"><a class="reference internal" href="../../W2D2_NeuroSymbolicMethods/student/W2D2_Intro.html">W2D2 - Neurosymbolic Methods and Cognitive Architectures</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../W2D2_NeuroSymbolicMethods/student/W2D2_Tutorial1.html">Tutorial 1: Basic operations of vector symbolic algebra</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../W2D2_NeuroSymbolicMethods/student/W2D2_Tutorial2.html">Tutorial 2: Learning with structure</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../W2D2_NeuroSymbolicMethods/student/W2D2_Tutorial3.html">Tutorial 3: Question Answering with Memory</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../W2D2_NeuroSymbolicMethods/student/W2D2_Outro.html">Daily survey</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../W2D2_NeuroSymbolicMethods/further_reading.html">Suggested further readings</a></li>
</ul>
</li>
</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">Learning</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1 has-children"><a class="reference internal" href="../../W2D3_Microlearning/chapter_title.html">Microlearning (W2D3)</a><input class="toctree-checkbox" id="toctree-checkbox-10" name="toctree-checkbox-10" type="checkbox"/><label class="toctree-toggle" for="toctree-checkbox-10"><i class="fa-solid fa-chevron-down"></i></label><ul>
<li class="toctree-l2"><a class="reference internal" href="../../W2D3_Microlearning/student/W2D3_Intro.html">Intro</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../W2D3_Microlearning/student/W2D3_Tutorial1.html">Tutorial 1: Microlearning</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../W2D3_Microlearning/student/W2D3_Outro.html">Daily survey</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../W2D3_Microlearning/further_reading.html">Suggested further readings</a></li>
</ul>
</li>
<li class="toctree-l1 has-children"><a class="reference internal" href="../../W2D4_Macrolearning/chapter_title.html">Macrolearning (W2D4)</a><input class="toctree-checkbox" id="toctree-checkbox-11" name="toctree-checkbox-11" type="checkbox"/><label class="toctree-toggle" for="toctree-checkbox-11"><i class="fa-solid fa-chevron-down"></i></label><ul>
<li class="toctree-l2"><a class="reference internal" href="../../W2D4_Macrolearning/student/W2D4_Intro.html">Intro</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../W2D4_Macrolearning/student/W2D4_Tutorial1.html">Tutorial 1: The problem of changing data distributions</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../W2D4_Macrolearning/student/W2D4_Tutorial2.html">Tutorial 2: Continual learning</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../W2D4_Macrolearning/student/W2D4_Tutorial3.html">Tutorial 3: Meta-learning</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../W2D4_Macrolearning/student/W2D4_Tutorial4.html">Tutorial 4: Biological meta reinforcement learning</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../W2D4_Macrolearning/student/W2D4_Tutorial5.html">(Bonus) Tutorial 5: Replay</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../W2D4_Macrolearning/student/W2D4_Outro.html">Daily survey</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../W2D4_Macrolearning/further_reading.html">Suggested further readings</a></li>
</ul>
</li>
</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">Mysteries</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1 has-children"><a class="reference internal" href="../../W2D5_Mysteries/chapter_title.html">Mysteries (W2D5)</a><input class="toctree-checkbox" id="toctree-checkbox-12" name="toctree-checkbox-12" type="checkbox"/><label class="toctree-toggle" for="toctree-checkbox-12"><i class="fa-solid fa-chevron-down"></i></label><ul>
<li class="toctree-l2"><a class="reference internal" href="../../W2D5_Mysteries/student/W2D5_Intro.html">Intro</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../W2D5_Mysteries/student/W2D5_Tutorial1.html">Tutorial 1: Consciousness</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../W2D5_Mysteries/student/W2D5_Tutorial2.html">Tutorial 2: Ethics</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../W2D5_Mysteries/student/W2D5_Outro.html">Outro &amp; Daily survey</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../W2D5_Mysteries/further_reading.html">Suggested further readings</a></li>
</ul>
</li>
</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">Project Booklet</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="../../../projects/README.html">Introduction</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../projects/docs/project_guidance.html">Daily guide for projects</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../projects/docs/continuing_your_project_after_the_course.html">Continuing your project after the course</a></li>
<li class="toctree-l1 has-children"><a class="reference internal" href="../../../projects/docs/datasets_overview.html">Project materials</a><input class="toctree-checkbox" id="toctree-checkbox-13" name="toctree-checkbox-13" type="checkbox"/><label class="toctree-toggle" for="toctree-checkbox-13"><i class="fa-solid fa-chevron-down"></i></label><ul>
<li class="toctree-l2"><a class="reference internal" href="../../../projects/project-notebooks/Macrocircuits.html">Macrocircuits</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../projects/project-notebooks/Microlearning.html">Microlearning</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../projects/project-notebooks/ComparingNetworks.html">Comparing Networks</a></li>
</ul>
</li>
</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">Professional Development</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="../../../projects/professional_development/README.html">Introduction</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../projects/professional_development/mentorship_program.html">Mentorship Program</a></li>
</ul>
</div>
</nav>
</div>
</div>
<div class="sidebar-end-items sidebar-primary__section">
<div class="sidebar-end-items__item">
</div>
</div>
<div id="rtd-footer-container"></div>
</div>
<main class="bd-main" id="main-content">
<div class="sbt-scroll-pixel-helper"></div>
<div class="bd-content">
<div class="bd-article-container">
<div class="bd-header-article">
<div class="col py-1 d-flex header-article-main">
<div class="header-article__left">
<label class="sidebar-toggle primary-toggle btn btn-sm" data-placement="right" data-toggle="tooltip" for="__primary" title="Toggle primary sidebar">
<span class="fa-solid fa-bars"></span>
</label>
</div>
<div class="header-article__right">
<div class="dropdown dropdown-launch-buttons">
<button aria-expanded="false" aria-label="Launch interactive content" class="btn dropdown-toggle" data-bs-toggle="dropdown" type="button">
<i class="fas fa-rocket"></i>
</button>
<ul class="dropdown-menu">
</ul>
</div>
<button class="btn btn-sm" data-placement="bottom" data-toggle="tooltip" onclick="toggleFullScreen()" title="Fullscreen mode">
<span class="btn__icon-container">
<i class="fas fa-expand"></i>
</span>
</button>
<div class="dropdown dropdown-repository-buttons">
<button aria-expanded="false" aria-label="Source repositories" class="btn dropdown-toggle" data-bs-toggle="dropdown" type="button">
<i class="fab fa-github"></i>
</button>
<ul class="dropdown-menu">
<li><a class="btn btn-sm dropdown-item" data-placement="left" data-toggle="tooltip" href="https://github.com/neuromatch/NeuroAI_Course" target="_blank" title="Source repository">
<span class="btn__icon-container">
<i class="fab fa-github"></i>
</span>
<span class="btn__text-container">repository</span>
</a>

<li><a class="btn btn-sm dropdown-item" data-placement="left" data-toggle="tooltip" href="https://github.com/neuromatch/NeuroAI_Course/issues/new?title=Issue%20on%20page%20%2Ftutorials/W1D3_ComparingArtificialAndBiologicalNetworks/student/W1D3_Tutorial5.html&amp;body=Your%20issue%20content%20here." target="_blank" title="Open an issue">
<span class="btn__icon-container">
<i class="fas fa-lightbulb"></i>
</span>
<span class="btn__text-container">open issue</span>
</a>

</li></li></ul>
</div>
<div class="dropdown dropdown-download-buttons">
<button aria-expanded="false" aria-label="Download this page" class="btn dropdown-toggle" data-bs-toggle="dropdown" type="button">
<i class="fas fa-download"></i>
</button>
<ul class="dropdown-menu">
<li><a class="btn btn-sm dropdown-item" data-placement="left" data-toggle="tooltip" href="../../../_sources/tutorials/W1D3_ComparingArtificialAndBiologicalNetworks/student/W1D3_Tutorial5.ipynb" target="_blank" title="Download source file">
<span class="btn__icon-container">
<i class="fas fa-file"></i>
</span>
<span class="btn__text-container">.ipynb</span>
</a>

<li>
<button class="btn btn-sm dropdown-item" data-placement="left" data-toggle="tooltip" onclick="printPdf(this)" title="Print to PDF">
<span class="btn__icon-container">
<i class="fas fa-file-pdf"></i>
</span>
<span class="btn__text-container">.pdf</span>
</button>

</li></li></ul>
</div>
<label class="sidebar-toggle secondary-toggle btn btn-sm" data-placement="left" data-toggle="tooltip" for="__secondary" title="Toggle secondary sidebar">
<span class="fa-solid fa-list"></span>
</label>
</div>
</div>
</div>
<div class="onlyprint" id="jb-print-docs-body">
<h1>Tutorial 5: Dynamical Similarity Analysis (DSA)</h1>
<!-- Table of contents -->
<div id="print-main-content">
<div id="jb-print-toc">
<div>
<h2> Contents </h2>
</div>
<nav aria-label="Page">
<ul class="visible nav section-nav flex-column">
<li class="toc-h1 nav-item toc-entry">
<a class="reference internal nav-link" href="#">
   Tutorial 5: Dynamical Similarity Analysis (DSA)
  </a>
<ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry">
<a class="reference internal nav-link" href="#install-and-import-feedback-gadget">
     Install and import feedback gadget
    </a>
</li>
<li class="toc-h2 nav-item toc-entry">
<a class="reference internal nav-link" href="#helper-functions">
     Helper functions
    </a>
</li>
<li class="toc-h2 nav-item toc-entry">
<a class="reference internal nav-link" href="#helper-functions-bonus-section">
     Helper functions (Bonus Section)
    </a>
</li>
<li class="toc-h2 nav-item toc-entry">
<a class="reference internal nav-link" href="#plotting-functions-bonus">
     Plotting functions (Bonus)
    </a>
</li>
<li class="toc-h2 nav-item toc-entry">
<a class="reference internal nav-link" href="#data-retrieval">
     Data retrieval
    </a>
</li>
<li class="toc-h2 nav-item toc-entry">
<a class="reference internal nav-link" href="#figure-settings">
     Figure settings
    </a>
</li>
<li class="toc-h2 nav-item toc-entry">
<a class="reference internal nav-link" href="#set-device-gpu-or-cpu">
     Set device (GPU or CPU)
    </a>
</li>
<li class="toc-h2 nav-item toc-entry">
<a class="reference internal nav-link" href="#load-slides">
     Load Slides
    </a>
</li>
</ul>
</li>
<li class="toc-h1 nav-item toc-entry">
<a class="reference internal nav-link" href="#intro">
   Intro
  </a>
<ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry">
<a class="reference internal nav-link" href="#video-1-dynamical-similarity-analysis">
     Video 1: Dynamical Similarity Analysis
    </a>
</li>
<li class="toc-h2 nav-item toc-entry">
<a class="reference internal nav-link" href="#submit-your-feedback">
     Submit your feedback
    </a>
</li>
<li class="toc-h2 nav-item toc-entry">
<a class="reference internal nav-link" href="#section-1-visualization-of-three-temporal-sequences">
     Section 1: Visualization of Three Temporal Sequences
    </a>
</li>
<li class="toc-h2 nav-item toc-entry">
<a class="reference internal nav-link" href="#multi-way-comparison">
     Multi-way Comparison
    </a>
</li>
<li class="toc-h2 nav-item toc-entry">
<a class="reference internal nav-link" href="#dsa-hyperparameters-n-delays-and-delay-interval">
     DSA Hyperparameters (
     <code class="docutils literal notranslate">
<span class="pre">
       n_delays
      </span>
</code>
     and
     <code class="docutils literal notranslate">
<span class="pre">
       delay_interval
      </span>
</code>
     )
    </a>
</li>
<li class="toc-h2 nav-item toc-entry">
<a class="reference internal nav-link" href="#comparison-with-rsa">
     Comparison with RSA
    </a>
</li>
</ul>
</li>
<li class="toc-h1 nav-item toc-entry">
<a class="reference internal nav-link" href="#bonus-representational-geometry-of-recurrent-models">
   (Bonus) Representational Geometry of Recurrent Models
  </a>
<ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry">
<a class="reference internal nav-link" href="#grab-a-recurrent-model">
     Grab a recurrent model
    </a>
</li>
<li class="toc-h2 nav-item toc-entry">
<a class="reference internal nav-link" href="#representational-geometry-paths-for-recurrent-models">
     Representational geometry paths for recurrent models
    </a>
<ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry">
<a class="reference internal nav-link" href="#id1">
       Submit your feedback
      </a>
</li>
</ul>
</li>
</ul>
</li>
<li class="toc-h1 nav-item toc-entry">
<a class="reference internal nav-link" href="#the-big-picture">
   The Big Picture
  </a>
</li>
</ul>
</nav>
</div>
</div>
</div>
<article class="bd-article" role="main">
<p><a href="https://colab.research.google.com/github/neuromatch/NeuroAI_Course/blob/main/tutorials/W1D3_ComparingArtificialAndBiologicalNetworks/student/W1D3_Tutorial5.ipynb" target="_blank"><img alt="Open In Colab" src="https://colab.research.google.com/assets/colab-badge.svg"/></a> Â  <a href="https://kaggle.com/kernels/welcome?src=https://raw.githubusercontent.com/neuromatch/NeuroAI_Course/main/tutorials/W1D3_ComparingArtificialAndBiologicalNetworks/student/W1D3_Tutorial5.ipynb" target="_blank"><img alt="Open in Kaggle" src="https://kaggle.com/static/images/open-in-kaggle.svg"/></a></p>
<section class="tex2jax_ignore mathjax_ignore" id="tutorial-5-dynamical-similarity-analysis-dsa">
<h1>Tutorial 5: Dynamical Similarity Analysis (DSA)<a class="headerlink" href="#tutorial-5-dynamical-similarity-analysis-dsa" title="Permalink to this heading">#</a></h1>
<p><strong>Week 1, Day 3: Comparing Artificial And Biological Networks</strong></p>
<p><strong>By Neuromatch Academy</strong></p>
<p><strong>Content creators:</strong> Mitchell Ostrow, Alex Murphy</p>
<p><strong>Content reviewers:</strong> Xaq Pitkow, Hlib Solodzhuk, Alex Murphy</p>
<p><strong>Production editors:</strong> Konstantine Tsafatinos, Ella Batty, Spiros Chavlis, Samuele Bolotta, Hlib Solodzhuk, Patrick Mineault, Alex Murphy</p>
<p>This short notebook expands the toolset of network comparison by taking a look at another important dimension for analysis - time. In particular, it would be beneficial to understand how the systems evolve over time and whether their dynamics are similar. The presented materials are the most similar to the ones introduced in <a class="reference external" href="https://neuroai.neuromatch.io/tutorials/W1D3_ComparingArtificialAndBiologicalNetworks/student/W1D3_Tutorial2.html">Tutorial 2</a> for this day, and one of the projects on <a class="reference external" href="https://neuroai.neuromatch.io/projects/project-notebooks/ComparingNetworks.html">Comparing Networks</a> is exactly about DSA.</p>
<section id="install-and-import-feedback-gadget">
<h2>Install and import feedback gadget<a class="headerlink" href="#install-and-import-feedback-gadget" title="Permalink to this heading">#</a></h2>
<div class="cell tag_hide-input docutils container">
<details class="hide above-input">
<summary aria-label="Toggle hidden content">
<span class="collapsed">Show code cell source</span>
<span class="expanded">Hide code cell source</span>
</summary>
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># @title Install and import feedback gadget</span>

<span class="o">!</span>pip<span class="w"> </span>install<span class="w"> </span>vibecheck<span class="w"> </span>rsatoolbox<span class="w"> </span>--quiet

<span class="kn">from</span><span class="w"> </span><span class="nn">vibecheck</span><span class="w"> </span><span class="kn">import</span> <span class="n">DatatopsContentReviewContainer</span>
<span class="k">def</span><span class="w"> </span><span class="nf">content_review</span><span class="p">(</span><span class="n">notebook_section</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">DatatopsContentReviewContainer</span><span class="p">(</span>
        <span class="s2">""</span><span class="p">,</span>  <span class="c1"># No text prompt</span>
        <span class="n">notebook_section</span><span class="p">,</span>
        <span class="p">{</span>
            <span class="s2">"url"</span><span class="p">:</span> <span class="s2">"https://pmyvdlilci.execute-api.us-east-1.amazonaws.com/klab"</span><span class="p">,</span>
            <span class="s2">"name"</span><span class="p">:</span> <span class="s2">"neuromatch_neuroai"</span><span class="p">,</span>
            <span class="s2">"user_key"</span><span class="p">:</span> <span class="s2">"wb2cxze8"</span><span class="p">,</span>
        <span class="p">},</span>
    <span class="p">)</span><span class="o">.</span><span class="n">render</span><span class="p">()</span>


<span class="n">feedback_prefix</span> <span class="o">=</span> <span class="s2">"W1D5_DSA"</span>
</pre></div>
</div>
</div>
</details>
</div>
</section>
<section id="helper-functions">
<h2>Helper functions<a class="headerlink" href="#helper-functions" title="Permalink to this heading">#</a></h2>
<div class="cell tag_hide-input docutils container">
<details class="hide above-input">
<summary aria-label="Toggle hidden content">
<span class="collapsed">Show code cell source</span>
<span class="expanded">Hide code cell source</span>
</summary>
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># @title Helper functions</span>

<span class="kn">import</span><span class="w"> </span><span class="nn">numpy</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">np</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">matplotlib.pyplot</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">plt</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">seaborn</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">sns</span>

<span class="k">def</span><span class="w"> </span><span class="nf">generate_2d_random_process</span><span class="p">(</span><span class="n">A</span><span class="p">,</span> <span class="n">B</span><span class="p">,</span> <span class="n">T</span><span class="o">=</span><span class="mi">1000</span><span class="p">):</span>
<span class="w">    </span><span class="sd">"""</span>
<span class="sd">    Generates a 2D random process with the equation x(t+1) = A.x(t) + B.noise.</span>

<span class="sd">    Args:</span>
<span class="sd">        A: 2x2 transition matrix.</span>
<span class="sd">        B: 2x2 noise scaling matrix.</span>
<span class="sd">        T: Number of time steps.</span>

<span class="sd">    Returns:</span>
<span class="sd">        A NumPy array of shape (T+1, 2) representing the trajectory.</span>
<span class="sd">    """</span>
    <span class="c1"># Assuming equilibrium distribution is zero mean and identity covariance for simplicity.</span>
    <span class="c1"># You may adjust this according to your actual equilibrium distribution</span>
    <span class="n">x</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>

    <span class="n">trajectory</span> <span class="o">=</span> <span class="p">[</span><span class="n">x</span><span class="o">.</span><span class="n">copy</span><span class="p">()]</span> <span class="c1"># Initialize with x(0)</span>
    <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">T</span><span class="p">):</span>
      <span class="n">noise</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">normal</span><span class="p">(</span><span class="n">size</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>  <span class="c1"># Standard normal noise</span>
      <span class="n">x</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">A</span><span class="p">,</span> <span class="n">x</span><span class="p">)</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">B</span><span class="p">,</span> <span class="n">noise</span><span class="p">)</span>
      <span class="n">trajectory</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">copy</span><span class="p">())</span>
    <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">trajectory</span><span class="p">)</span>

<span class="sd">"""This module computes the Havok DMD model for a given dataset."""</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">torch</span>

<span class="k">def</span><span class="w"> </span><span class="nf">embed_signal_torch</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">n_delays</span><span class="p">,</span> <span class="n">delay_interval</span><span class="o">=</span><span class="mi">1</span><span class="p">):</span>
<span class="w">    </span><span class="sd">"""</span>
<span class="sd">    Create a delay embedding from the provided tensor data.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    data : torch.tensor</span>
<span class="sd">        The data from which to create the delay embedding. Must be either: (1) a</span>
<span class="sd">        2-dimensional array/tensor of shape T x N where T is the number</span>
<span class="sd">        of time points and N is the number of observed dimensions</span>
<span class="sd">        at each time point, or (2) a 3-dimensional array/tensor of shape</span>
<span class="sd">        K x T x N where K is the number of "trials" and T and N are</span>
<span class="sd">        as defined above.</span>

<span class="sd">    n_delays : int</span>
<span class="sd">        Parameter that controls the size of the delay embedding. Explicitly,</span>
<span class="sd">        the number of delays to include.</span>

<span class="sd">    delay_interval : int</span>
<span class="sd">        The number of time steps between each delay in the delay embedding. Defaults</span>
<span class="sd">        to 1 time step.</span>
<span class="sd">    """</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">):</span>
        <span class="n">data</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">from_numpy</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
    <span class="n">device</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">device</span>

    <span class="k">if</span> <span class="n">data</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">ndim</span><span class="o">==</span><span class="mi">3</span><span class="p">)]</span> <span class="o">-</span> <span class="p">(</span><span class="n">n_delays</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="n">delay_interval</span> <span class="o">&lt;</span> <span class="mi">1</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">"The number of delays is too large for the number of time points in the data!"</span><span class="p">)</span>

    <span class="c1"># initialize the embedding</span>
    <span class="k">if</span> <span class="n">data</span><span class="o">.</span><span class="n">ndim</span> <span class="o">==</span> <span class="mi">3</span><span class="p">:</span>
        <span class="n">embedding</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">data</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">data</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="p">(</span><span class="n">n_delays</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="n">delay_interval</span><span class="p">,</span> <span class="n">data</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">*</span><span class="n">n_delays</span><span class="p">))</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">device</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">embedding</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">data</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="p">(</span><span class="n">n_delays</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="n">delay_interval</span><span class="p">,</span> <span class="n">data</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">*</span><span class="n">n_delays</span><span class="p">))</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">device</span><span class="p">)</span>

    <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n_delays</span><span class="p">):</span>
        <span class="n">index</span> <span class="o">=</span> <span class="p">(</span><span class="n">n_delays</span> <span class="o">-</span> <span class="mi">1</span> <span class="o">-</span> <span class="n">d</span><span class="p">)</span><span class="o">*</span><span class="n">delay_interval</span>
        <span class="n">ddelay</span> <span class="o">=</span> <span class="n">d</span><span class="o">*</span><span class="n">delay_interval</span>

        <span class="k">if</span> <span class="n">data</span><span class="o">.</span><span class="n">ndim</span> <span class="o">==</span> <span class="mi">3</span><span class="p">:</span>
            <span class="n">ddata</span> <span class="o">=</span> <span class="n">d</span><span class="o">*</span><span class="n">data</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
            <span class="n">embedding</span><span class="p">[:,:,</span> <span class="n">ddata</span><span class="p">:</span> <span class="n">ddata</span> <span class="o">+</span> <span class="n">data</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">2</span><span class="p">]]</span> <span class="o">=</span> <span class="n">data</span><span class="p">[:,</span><span class="n">index</span><span class="p">:</span><span class="n">data</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">ddelay</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">ddata</span> <span class="o">=</span> <span class="n">d</span><span class="o">*</span><span class="n">data</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
            <span class="n">embedding</span><span class="p">[:,</span> <span class="n">ddata</span><span class="p">:</span><span class="n">ddata</span> <span class="o">+</span> <span class="n">data</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]]</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="n">index</span><span class="p">:</span><span class="n">data</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="n">ddelay</span><span class="p">]</span>

    <span class="k">return</span> <span class="n">embedding</span>

<span class="k">class</span><span class="w"> </span><span class="nc">DMD</span><span class="p">:</span>
<span class="w">    </span><span class="sd">"""DMD class for computing and predicting with DMD models.</span>
<span class="sd">    """</span>
    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span>
            <span class="bp">self</span><span class="p">,</span>
            <span class="n">data</span><span class="p">,</span>
            <span class="n">n_delays</span><span class="p">,</span>
            <span class="n">delay_interval</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
            <span class="n">rank</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
            <span class="n">rank_thresh</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
            <span class="n">rank_explained_variance</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
            <span class="n">reduced_rank_reg</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
            <span class="n">lamb</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
            <span class="n">device</span><span class="o">=</span><span class="s1">'cpu'</span><span class="p">,</span>
            <span class="n">verbose</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
            <span class="n">send_to_cpu</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
            <span class="n">steps_ahead</span><span class="o">=</span><span class="mi">1</span>
        <span class="p">):</span>
<span class="w">        </span><span class="sd">"""</span>
<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        data : np.ndarray or torch.tensor</span>
<span class="sd">            The data to fit the DMD model to. Must be either: (1) a</span>
<span class="sd">            2-dimensional array/tensor of shape T x N where T is the number</span>
<span class="sd">            of time points and N is the number of observed dimensions</span>
<span class="sd">            at each time point, or (2) a 3-dimensional array/tensor of shape</span>
<span class="sd">            K x T x N where K is the number of "trials" and T and N are</span>
<span class="sd">            as defined above.</span>

<span class="sd">        n_delays : int</span>
<span class="sd">            Parameter that controls the size of the delay embedding. Explicitly,</span>
<span class="sd">            the number of delays to include.</span>

<span class="sd">        delay_interval : int</span>
<span class="sd">            The number of time steps between each delay in the delay embedding. Defaults</span>
<span class="sd">            to 1 time step.</span>

<span class="sd">        rank : int</span>
<span class="sd">            The rank of V in fitting HAVOK DMD - i.e., the number of columns of V to</span>
<span class="sd">            use to fit the DMD model. Defaults to None, in which case all columns of V</span>
<span class="sd">            will be used.</span>

<span class="sd">        rank_thresh : float</span>
<span class="sd">            Parameter that controls the rank of V in fitting HAVOK DMD by dictating a threshold</span>
<span class="sd">            of singular values to use. Explicitly, the rank of V will be the number of singular</span>
<span class="sd">            values greater than rank_thresh. Defaults to None.</span>

<span class="sd">        rank_explained_variance : float</span>
<span class="sd">            Parameter that controls the rank of V in fitting HAVOK DMD by indicating the percentage of</span>
<span class="sd">            cumulative explained variance that should be explained by the columns of V. Defaults to None.</span>

<span class="sd">        reduced_rank_reg : bool</span>
<span class="sd">            Determines whether to use reduced rank regression (True) or principal component regression (False)</span>

<span class="sd">        lamb : float</span>
<span class="sd">            Regularization parameter for ridge regression. Defaults to 0.</span>

<span class="sd">        device: string, int, or torch.device</span>
<span class="sd">            A string, int or torch.device object to indicate the device to torch.</span>

<span class="sd">        verbose: bool</span>
<span class="sd">            If True, print statements will be provided about the progress of the fitting procedure.</span>

<span class="sd">        send_to_cpu: bool</span>
<span class="sd">            If True, will send all tensors in the object back to the cpu after everything is computed.</span>
<span class="sd">            This is implemented to prevent gpu memory overload when computing multiple DMDs.</span>

<span class="sd">        steps_ahead: int</span>
<span class="sd">            The number of time steps ahead to predict. Defaults to 1.</span>
<span class="sd">        """</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">device</span> <span class="o">=</span> <span class="n">device</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_init_data</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">n_delays</span> <span class="o">=</span> <span class="n">n_delays</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">delay_interval</span> <span class="o">=</span> <span class="n">delay_interval</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">rank</span> <span class="o">=</span> <span class="n">rank</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">rank_thresh</span> <span class="o">=</span> <span class="n">rank_thresh</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">rank_explained_variance</span> <span class="o">=</span> <span class="n">rank_explained_variance</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">reduced_rank_reg</span> <span class="o">=</span> <span class="n">reduced_rank_reg</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lamb</span> <span class="o">=</span> <span class="n">lamb</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">verbose</span> <span class="o">=</span> <span class="n">verbose</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">send_to_cpu</span> <span class="o">=</span> <span class="n">send_to_cpu</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">steps_ahead</span> <span class="o">=</span> <span class="n">steps_ahead</span>

        <span class="c1"># Hankel matrix</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">H</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="c1"># SVD attributes</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">U</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">S</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">V</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">S_mat</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">S_mat_inv</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="c1"># DMD attributes</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">A_v</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">A_havok_dmd</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_init_data</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data</span><span class="p">):</span>
        <span class="c1"># check if the data is an np.ndarry - if so, convert it to Torch</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">):</span>
            <span class="n">data</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">from_numpy</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">data</span> <span class="o">=</span> <span class="n">data</span>
        <span class="c1"># create attributes for the data dimensions</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">ndim</span> <span class="o">==</span> <span class="mi">3</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">ntrials</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">window</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">n</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">window</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">n</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">ntrials</span> <span class="o">=</span> <span class="mi">1</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">compute_hankel</span><span class="p">(</span>
            <span class="bp">self</span><span class="p">,</span>
            <span class="n">data</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
            <span class="n">n_delays</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
            <span class="n">delay_interval</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="p">):</span>
<span class="w">        </span><span class="sd">"""</span>
<span class="sd">        Computes the Hankel matrix from the provided data.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        data : np.ndarray or torch.tensor</span>
<span class="sd">            The data to fit the DMD model to. Must be either: (1) a</span>
<span class="sd">            2-dimensional array/tensor of shape T x N where T is the number</span>
<span class="sd">            of time points and N is the number of observed dimensions</span>
<span class="sd">            at each time point, or (2) a 3-dimensional array/tensor of shape</span>
<span class="sd">            K x T x N where K is the number of "trials" and T and N are</span>
<span class="sd">            as defined above.</span>

<span class="sd">        n_delays : int</span>
<span class="sd">            Parameter that controls the size of the delay embedding. Explicitly,</span>
<span class="sd">            the number of delays to include. Defaults to None - provide only if you want</span>
<span class="sd">            to override the value of n_delays from the init.</span>

<span class="sd">        delay_interval : int</span>
<span class="sd">            The number of time steps between each delay in the delay embedding. Defaults</span>
<span class="sd">            to 1 time step. Defaults to None - provide only if you want</span>
<span class="sd">            to override the value of n_delays from the init.</span>
<span class="sd">        """</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">verbose</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">"Computing Hankel matrix ..."</span><span class="p">)</span>

        <span class="c1"># if parameters are provided, overwrite them from the init</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span> <span class="k">if</span> <span class="n">data</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="bp">self</span><span class="o">.</span><span class="n">_init_data</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">n_delays</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">n_delays</span> <span class="k">if</span> <span class="n">n_delays</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">n_delays</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">delay_interval</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">delay_interval</span> <span class="k">if</span> <span class="n">delay_interval</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">delay_interval</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">device</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">H</span> <span class="o">=</span> <span class="n">embed_signal_torch</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">n_delays</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">delay_interval</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">verbose</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">"Hankel matrix computed!"</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">compute_svd</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">"""</span>
<span class="sd">        Computes the SVD of the Hankel matrix.</span>
<span class="sd">        """</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">verbose</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">"Computing SVD on Hankel matrix ..."</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">H</span><span class="o">.</span><span class="n">ndim</span> <span class="o">==</span> <span class="mi">3</span><span class="p">:</span> <span class="c1">#flatten across trials for 3d</span>
            <span class="n">H</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">H</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">H</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">H</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">H</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">H</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">H</span>
        <span class="c1"># compute the SVD</span>
        <span class="n">U</span><span class="p">,</span> <span class="n">S</span><span class="p">,</span> <span class="n">Vh</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">svd</span><span class="p">(</span><span class="n">H</span><span class="o">.</span><span class="n">T</span><span class="p">,</span> <span class="n">full_matrices</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

        <span class="c1"># update attributes</span>
        <span class="n">V</span> <span class="o">=</span> <span class="n">Vh</span><span class="o">.</span><span class="n">T</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">U</span> <span class="o">=</span> <span class="n">U</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">S</span> <span class="o">=</span> <span class="n">S</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">V</span> <span class="o">=</span> <span class="n">V</span>

        <span class="c1"># construct the singuar value matrix and its inverse</span>
        <span class="c1"># dim = self.n_delays * self.n</span>
        <span class="c1"># s = len(S)</span>
        <span class="c1"># self.S_mat = torch.zeros(dim, dim,dtype=torch.float32).to(self.device)</span>
        <span class="c1"># self.S_mat_inv = torch.zeros(dim, dim,dtype=torch.float32).to(self.device)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">S_mat</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">diag</span><span class="p">(</span><span class="n">S</span><span class="p">)</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">device</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">S_mat_inv</span><span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">diag</span><span class="p">(</span><span class="mi">1</span> <span class="o">/</span> <span class="n">S</span><span class="p">)</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">device</span><span class="p">)</span>

        <span class="c1"># compute explained variance</span>
        <span class="n">exp_variance_inds</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">S</span><span class="o">**</span><span class="mi">2</span> <span class="o">/</span> <span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">S</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">())</span>
        <span class="n">cumulative_explained</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">cumsum</span><span class="p">(</span><span class="n">exp_variance_inds</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cumulative_explained_variance</span> <span class="o">=</span> <span class="n">cumulative_explained</span>

        <span class="c1">#make the X and Y components of the regression by staggering the hankel eigen-time delay coordinates by time</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">reduced_rank_reg</span><span class="p">:</span>
            <span class="n">V</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">V</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">V</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">V</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">ntrials</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">V</span><span class="o">.</span><span class="n">numel</span><span class="p">()</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">H</span><span class="o">.</span><span class="n">numel</span><span class="p">():</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">"The dimension of the SVD of the Hankel matrix is smaller than the dimension of the Hankel matrix itself. </span><span class="se">\n</span><span class="s2"> </span><span class="se">\</span>
<span class="s2">                                 This is likely due to the number of time points being smaller than the number of dimensions. </span><span class="se">\n</span><span class="s2"> </span><span class="se">\</span>
<span class="s2">                                 Please reduce the number of delays."</span><span class="p">)</span>

            <span class="n">V</span> <span class="o">=</span> <span class="n">V</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">H</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>

            <span class="c1">#first reshape back into Hankel shape, separated by trials</span>
            <span class="n">newshape</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">H</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">H</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">steps_ahead</span><span class="p">),</span><span class="bp">self</span><span class="o">.</span><span class="n">H</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">Vt_minus</span> <span class="o">=</span> <span class="n">V</span><span class="p">[:,:</span><span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">steps_ahead</span><span class="p">]</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">newshape</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">Vt_plus</span> <span class="o">=</span> <span class="n">V</span><span class="p">[:,</span><span class="bp">self</span><span class="o">.</span><span class="n">steps_ahead</span><span class="p">:]</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">newshape</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">Vt_minus</span> <span class="o">=</span> <span class="n">V</span><span class="p">[:</span><span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">steps_ahead</span><span class="p">]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">Vt_plus</span> <span class="o">=</span> <span class="n">V</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">steps_ahead</span><span class="p">:]</span>


        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">verbose</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">"SVD complete!"</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">recalc_rank</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">rank</span><span class="p">,</span><span class="n">rank_thresh</span><span class="p">,</span><span class="n">rank_explained_variance</span><span class="p">):</span>
<span class="w">        </span><span class="sd">'''</span>
<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        rank : int</span>
<span class="sd">            The rank of V in fitting HAVOK DMD - i.e., the number of columns of V to</span>
<span class="sd">            use to fit the DMD model. Defaults to None, in which case all columns of V</span>
<span class="sd">            will be used. Provide only if you want to override the value from the init.</span>

<span class="sd">        rank_thresh : float</span>
<span class="sd">            Parameter that controls the rank of V in fitting HAVOK DMD by dictating a threshold</span>
<span class="sd">            of singular values to use. Explicitly, the rank of V will be the number of singular</span>
<span class="sd">            values greater than rank_thresh. Defaults to None - provide only if you want</span>
<span class="sd">            to override the value from the init.</span>

<span class="sd">        rank_explained_variance : float</span>
<span class="sd">            Parameter that controls the rank of V in fitting HAVOK DMD by indicating the percentage of</span>
<span class="sd">            cumulative explained variance that should be explained by the columns of V. Defaults to None -</span>
<span class="sd">            provide only if you want to overried the value from the init.</span>
<span class="sd">            '''</span>
        <span class="c1"># if an argument was provided, overwrite the stored rank information</span>
        <span class="n">none_vars</span> <span class="o">=</span> <span class="p">(</span><span class="n">rank</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">)</span> <span class="o">+</span> <span class="p">(</span><span class="n">rank_thresh</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">)</span> <span class="o">+</span> <span class="p">(</span><span class="n">rank_explained_variance</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">none_vars</span> <span class="o">!=</span> <span class="mi">3</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">rank</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">rank_thresh</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">rank_explained_variance</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">rank</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">rank</span> <span class="k">if</span> <span class="n">rank</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">rank</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">rank_thresh</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">rank_thresh</span> <span class="k">if</span> <span class="n">rank_thresh</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">rank_thresh</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">rank_explained_variance</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">rank_explained_variance</span> <span class="k">if</span> <span class="n">rank_explained_variance</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">rank_explained_variance</span>

        <span class="n">none_vars</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">rank</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">)</span> <span class="o">+</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">rank_thresh</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">)</span> <span class="o">+</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">rank_explained_variance</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">none_vars</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">"More than one value was provided between rank, rank_thresh, and rank_explained_variance. Please provide only one of these, and ensure the others are None!"</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">none_vars</span> <span class="o">==</span> <span class="mi">3</span><span class="p">:</span>
           <span class="bp">self</span><span class="o">.</span><span class="n">rank</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">S</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">reduced_rank_reg</span><span class="p">:</span>
            <span class="n">S</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">proj_mat_S</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">S</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">S</span>

        <span class="k">if</span> <span class="n">rank_thresh</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">S</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">rank_thresh</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">rank</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">S</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">rank</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">argmax</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">S</span><span class="p">),</span> <span class="mi">0</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">device</span><span class="p">)</span><span class="o">*</span><span class="p">(</span><span class="n">S</span> <span class="o">&lt;</span> <span class="n">rank_thresh</span><span class="p">))</span>

        <span class="k">if</span> <span class="n">rank_explained_variance</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">rank</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">argmax</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">cumulative_explained_variance</span> <span class="o">&gt;</span> <span class="n">rank_explained_variance</span><span class="p">)</span><span class="o">.</span><span class="n">type</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">int</span><span class="p">))</span><span class="o">.</span><span class="n">cpu</span><span class="p">()</span><span class="o">.</span><span class="n">numpy</span><span class="p">())</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">rank</span> <span class="o">&gt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">H</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">rank</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">H</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">rank</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">S</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">&gt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">rank_thresh</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">rank</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">S</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">rank</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">argmax</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">S</span><span class="p">),</span> <span class="mi">0</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">device</span><span class="p">)</span><span class="o">*</span><span class="p">(</span><span class="n">S</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">rank_thresh</span><span class="p">))</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">compute_havok_dmd</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">lamb</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">        </span><span class="sd">"""</span>
<span class="sd">        Computes the Havok DMD matrix (Principal Component Regression)</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        lamb : float</span>
<span class="sd">            Regularization parameter for ridge regression. Defaults to 0 - provide only if you want</span>
<span class="sd">            to override the value of n_delays from the init.</span>

<span class="sd">        """</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">verbose</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">"Computing least squares fits to HAVOK DMD ..."</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">lamb</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">lamb</span> <span class="k">if</span> <span class="n">lamb</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">lamb</span>

        <span class="n">A_v</span> <span class="o">=</span> <span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">inv</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Vt_minus</span><span class="p">[:,</span> <span class="p">:</span><span class="bp">self</span><span class="o">.</span><span class="n">rank</span><span class="p">]</span><span class="o">.</span><span class="n">T</span> <span class="o">@</span> <span class="bp">self</span><span class="o">.</span><span class="n">Vt_minus</span><span class="p">[:,</span> <span class="p">:</span><span class="bp">self</span><span class="o">.</span><span class="n">rank</span><span class="p">]</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">lamb</span><span class="o">*</span><span class="n">torch</span><span class="o">.</span><span class="n">eye</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">rank</span><span class="p">)</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">device</span><span class="p">))</span> \
               <span class="o">@</span> <span class="bp">self</span><span class="o">.</span><span class="n">Vt_minus</span><span class="p">[:,</span> <span class="p">:</span><span class="bp">self</span><span class="o">.</span><span class="n">rank</span><span class="p">]</span><span class="o">.</span><span class="n">T</span> <span class="o">@</span> <span class="bp">self</span><span class="o">.</span><span class="n">Vt_plus</span><span class="p">[:,</span> <span class="p">:</span><span class="bp">self</span><span class="o">.</span><span class="n">rank</span><span class="p">])</span><span class="o">.</span><span class="n">T</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">A_v</span> <span class="o">=</span> <span class="n">A_v</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">A_havok_dmd</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">U</span> <span class="o">@</span> <span class="bp">self</span><span class="o">.</span><span class="n">S_mat</span><span class="p">[:</span><span class="bp">self</span><span class="o">.</span><span class="n">U</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="p">:</span><span class="bp">self</span><span class="o">.</span><span class="n">rank</span><span class="p">]</span> <span class="o">@</span> <span class="bp">self</span><span class="o">.</span><span class="n">A_v</span> <span class="o">@</span> <span class="bp">self</span><span class="o">.</span><span class="n">S_mat_inv</span><span class="p">[:</span><span class="bp">self</span><span class="o">.</span><span class="n">rank</span><span class="p">,</span> <span class="p">:</span><span class="bp">self</span><span class="o">.</span><span class="n">U</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]]</span> <span class="o">@</span> <span class="bp">self</span><span class="o">.</span><span class="n">U</span><span class="o">.</span><span class="n">T</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">verbose</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">"Least squares complete! </span><span class="se">\n</span><span class="s2">"</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">compute_proj_mat</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">lamb</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">verbose</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">"Computing Projector Matrix for Reduced Rank Regression"</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">lamb</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">lamb</span> <span class="k">if</span> <span class="n">lamb</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">lamb</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">proj_mat</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">Vt_plus</span><span class="o">.</span><span class="n">T</span> <span class="o">@</span> <span class="bp">self</span><span class="o">.</span><span class="n">Vt_minus</span> <span class="o">@</span> <span class="n">torch</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">inv</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Vt_minus</span><span class="o">.</span><span class="n">T</span> <span class="o">@</span> <span class="bp">self</span><span class="o">.</span><span class="n">Vt_minus</span> <span class="o">+</span>
                                                                          <span class="bp">self</span><span class="o">.</span><span class="n">lamb</span><span class="o">*</span><span class="n">torch</span><span class="o">.</span><span class="n">eye</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Vt_minus</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">device</span><span class="p">))</span> <span class="o">@</span> \
                                                                          <span class="bp">self</span><span class="o">.</span><span class="n">Vt_minus</span><span class="o">.</span><span class="n">T</span> <span class="o">@</span> <span class="bp">self</span><span class="o">.</span><span class="n">Vt_plus</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">proj_mat_S</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">proj_mat_V</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">eigh</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">proj_mat</span><span class="p">)</span>
        <span class="c1">#todo: more efficient to flip ranks (negative index) in compute_reduced_rank_regression but also less interpretable</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">proj_mat_S</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">flip</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">proj_mat_S</span><span class="p">,</span> <span class="n">dims</span><span class="o">=</span><span class="p">(</span><span class="mi">0</span><span class="p">,))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">proj_mat_V</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">flip</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">proj_mat_V</span><span class="p">,</span> <span class="n">dims</span><span class="o">=</span><span class="p">(</span><span class="mi">1</span><span class="p">,))</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">verbose</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">"Projector Matrix computed! </span><span class="se">\n</span><span class="s2">"</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">compute_reduced_rank_regression</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">lamb</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">verbose</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">"Computing Reduced Rank Regression ..."</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">lamb</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">lamb</span> <span class="k">if</span> <span class="n">lamb</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">lamb</span>
        <span class="n">proj_mat</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">proj_mat_V</span><span class="p">[:,:</span><span class="bp">self</span><span class="o">.</span><span class="n">rank</span><span class="p">]</span> <span class="o">@</span> <span class="bp">self</span><span class="o">.</span><span class="n">proj_mat_V</span><span class="p">[:,:</span><span class="bp">self</span><span class="o">.</span><span class="n">rank</span><span class="p">]</span><span class="o">.</span><span class="n">T</span>
        <span class="n">B_ols</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">inv</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Vt_minus</span><span class="o">.</span><span class="n">T</span> <span class="o">@</span> <span class="bp">self</span><span class="o">.</span><span class="n">Vt_minus</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">lamb</span><span class="o">*</span><span class="n">torch</span><span class="o">.</span><span class="n">eye</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Vt_minus</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">device</span><span class="p">))</span> <span class="o">@</span> <span class="bp">self</span><span class="o">.</span><span class="n">Vt_minus</span><span class="o">.</span><span class="n">T</span> <span class="o">@</span> <span class="bp">self</span><span class="o">.</span><span class="n">Vt_plus</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">A_v</span> <span class="o">=</span> <span class="n">B_ols</span> <span class="o">@</span> <span class="n">proj_mat</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">A_havok_dmd</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">U</span> <span class="o">@</span> <span class="bp">self</span><span class="o">.</span><span class="n">S_mat</span><span class="p">[:</span><span class="bp">self</span><span class="o">.</span><span class="n">U</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">],:</span><span class="bp">self</span><span class="o">.</span><span class="n">A_v</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]]</span> <span class="o">@</span> <span class="bp">self</span><span class="o">.</span><span class="n">A_v</span><span class="o">.</span><span class="n">T</span> <span class="o">@</span> <span class="bp">self</span><span class="o">.</span><span class="n">S_mat_inv</span><span class="p">[:</span><span class="bp">self</span><span class="o">.</span><span class="n">A_v</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="p">:</span><span class="bp">self</span><span class="o">.</span><span class="n">U</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]]</span> <span class="o">@</span> <span class="bp">self</span><span class="o">.</span><span class="n">U</span><span class="o">.</span><span class="n">T</span>


        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">verbose</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">"Reduced Rank Regression complete! </span><span class="se">\n</span><span class="s2">"</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">fit</span><span class="p">(</span>
            <span class="bp">self</span><span class="p">,</span>
            <span class="n">data</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
            <span class="n">n_delays</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
            <span class="n">delay_interval</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
            <span class="n">rank</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
            <span class="n">rank_thresh</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
            <span class="n">rank_explained_variance</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
            <span class="n">lamb</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
            <span class="n">device</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
            <span class="n">verbose</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
            <span class="n">steps_ahead</span><span class="o">=</span><span class="kc">None</span>
        <span class="p">):</span>
<span class="w">        </span><span class="sd">"""</span>
<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        data : np.ndarray or torch.tensor</span>
<span class="sd">            The data to fit the DMD model to. Must be either: (1) a</span>
<span class="sd">            2-dimensional array/tensor of shape T x N where T is the number</span>
<span class="sd">            of time points and N is the number of observed dimensions</span>
<span class="sd">            at each time point, or (2) a 3-dimensional array/tensor of shape</span>
<span class="sd">            K x T x N where K is the number of "trials" and T and N are</span>
<span class="sd">            as defined above. Defaults to None - provide only if you want to</span>
<span class="sd">            override the value from the init.</span>

<span class="sd">        n_delays : int</span>
<span class="sd">            Parameter that controls the size of the delay embedding. Explicitly,</span>
<span class="sd">            the number of delays to include. Defaults to None - provide only if you want to</span>
<span class="sd">            override the value from the init.</span>

<span class="sd">        delay_interval : int</span>
<span class="sd">            The number of time steps between each delay in the delay embedding. Defaults to None -</span>
<span class="sd">            provide only if you want to override the value from the init.</span>

<span class="sd">        rank : int</span>
<span class="sd">            The rank of V in fitting HAVOK DMD - i.e., the number of columns of V to</span>
<span class="sd">            use to fit the DMD model. Defaults to None, in which case all columns of V</span>
<span class="sd">            will be used - provide only if you want to</span>
<span class="sd">            override the value from the init.</span>

<span class="sd">        rank_thresh : int</span>
<span class="sd">            Parameter that controls the rank of V in fitting HAVOK DMD by dictating a threshold</span>
<span class="sd">            of singular values to use. Explicitly, the rank of V will be the number of singular</span>
<span class="sd">            values greater than rank_thresh. Defaults to None - provide only if you want to</span>
<span class="sd">            override the value from the init.</span>

<span class="sd">        rank_explained_variance : float</span>
<span class="sd">            Parameter that controls the rank of V in fitting HAVOK DMD by indicating the percentage of</span>
<span class="sd">            cumulative explained variance that should be explained by the columns of V. Defaults to None -</span>
<span class="sd">            provide only if you want to overried the value from the init.</span>

<span class="sd">        lamb : float</span>
<span class="sd">            Regularization parameter for ridge regression. Defaults to None - provide only if you want to</span>
<span class="sd">            override the value from the init.</span>

<span class="sd">        device: string or int</span>
<span class="sd">            A string or int to indicate the device to torch. For example, can be 'cpu' or 'cuda',</span>
<span class="sd">            or alternatively 0 if the intenion is to use GPU device 0. Defaults to None - provide only</span>
<span class="sd">            if you want to override the value from the init.</span>

<span class="sd">        verbose: bool</span>
<span class="sd">            If True, print statements will be provided about the progress of the fitting procedure.</span>
<span class="sd">            Defaults to None - provide only if you want to override the value from the init.</span>

<span class="sd">        steps_ahead: int</span>
<span class="sd">            The number of time steps ahead to predict. Defaults to 1.</span>

<span class="sd">        """</span>
        <span class="c1"># if parameters are provided, overwrite them from the init</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">steps_ahead</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">steps_ahead</span> <span class="k">if</span> <span class="n">steps_ahead</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">steps_ahead</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">device</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">device</span> <span class="k">if</span> <span class="n">device</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">device</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">verbose</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">verbose</span> <span class="k">if</span> <span class="n">verbose</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">verbose</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">compute_hankel</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">n_delays</span><span class="p">,</span> <span class="n">delay_interval</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">compute_svd</span><span class="p">()</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">reduced_rank_reg</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">compute_proj_mat</span><span class="p">(</span><span class="n">lamb</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">recalc_rank</span><span class="p">(</span><span class="n">rank</span><span class="p">,</span><span class="n">rank_thresh</span><span class="p">,</span><span class="n">rank_explained_variance</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">compute_reduced_rank_regression</span><span class="p">(</span><span class="n">lamb</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">recalc_rank</span><span class="p">(</span><span class="n">rank</span><span class="p">,</span><span class="n">rank_thresh</span><span class="p">,</span><span class="n">rank_explained_variance</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">compute_havok_dmd</span><span class="p">(</span><span class="n">lamb</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">send_to_cpu</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">all_to_device</span><span class="p">(</span><span class="s1">'cpu'</span><span class="p">)</span> <span class="c1">#send back to the cpu to save memory</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">predict</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">test_data</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">reseed</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">full_return</span><span class="o">=</span><span class="kc">False</span>
        <span class="p">):</span>
<span class="w">        </span><span class="sd">"""</span>
<span class="sd">        Returns</span>
<span class="sd">         -------</span>
<span class="sd">         pred_data : torch.tensor</span>
<span class="sd">             The predictions generated by the HAVOK model. Of the same shape as test_data. Note that the first</span>
<span class="sd">             (self.n_delays - 1)*self.delay_interval + 1 time steps of the generated predictions are by construction</span>
<span class="sd">             identical to the test_data.</span>

<span class="sd">         H_test_havok_dmd : torch.tensor (Optional)</span>
<span class="sd">             Returned if full_return=True. The predicted Hankel matrix generated by the HAVOK model.</span>
<span class="sd">         H_test : torch.tensor (Optional)</span>
<span class="sd">             Returned if full_return=True. The true Hankel matrix</span>
<span class="sd">        """</span>
        <span class="c1"># initialize test_data</span>
        <span class="k">if</span> <span class="n">test_data</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">test_data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">test_data</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">):</span>
            <span class="n">test_data</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">from_numpy</span><span class="p">(</span><span class="n">test_data</span><span class="p">)</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">device</span><span class="p">)</span>
        <span class="n">ndim</span> <span class="o">=</span> <span class="n">test_data</span><span class="o">.</span><span class="n">ndim</span>
        <span class="k">if</span> <span class="n">ndim</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
            <span class="n">test_data</span> <span class="o">=</span> <span class="n">test_data</span><span class="o">.</span><span class="n">unsqueeze</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
        <span class="n">H_test</span> <span class="o">=</span> <span class="n">embed_signal_torch</span><span class="p">(</span><span class="n">test_data</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">n_delays</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">delay_interval</span><span class="p">)</span>
        <span class="n">steps_ahead</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">steps_ahead</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">steps_ahead</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="mi">1</span>

        <span class="k">if</span> <span class="n">reseed</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">reseed</span> <span class="o">=</span> <span class="mi">1</span>

        <span class="n">H_test_havok_dmd</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">H_test</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">device</span><span class="p">)</span>
        <span class="n">H_test_havok_dmd</span><span class="p">[:,</span> <span class="p">:</span><span class="n">steps_ahead</span><span class="p">]</span> <span class="o">=</span> <span class="n">H_test</span><span class="p">[:,</span> <span class="p">:</span><span class="n">steps_ahead</span><span class="p">]</span>

        <span class="n">A</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">A_havok_dmd</span><span class="o">.</span><span class="n">unsqueeze</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">steps_ahead</span><span class="p">,</span> <span class="n">H_test</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]):</span>
            <span class="k">if</span> <span class="n">t</span> <span class="o">%</span> <span class="n">reseed</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">H_test_havok_dmd</span><span class="p">[:,</span> <span class="n">t</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">A</span> <span class="o">@</span> <span class="n">H_test</span><span class="p">[:,</span> <span class="n">t</span> <span class="o">-</span> <span class="n">steps_ahead</span><span class="p">]</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="o">-</span><span class="mi">2</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">))</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="o">-</span><span class="mi">2</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">H_test_havok_dmd</span><span class="p">[:,</span> <span class="n">t</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">A</span> <span class="o">@</span> <span class="n">H_test_havok_dmd</span><span class="p">[:,</span> <span class="n">t</span> <span class="o">-</span> <span class="n">steps_ahead</span><span class="p">]</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="o">-</span><span class="mi">2</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">))</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="o">-</span><span class="mi">2</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">pred_data</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">hstack</span><span class="p">([</span><span class="n">test_data</span><span class="p">[:,</span> <span class="p">:(</span><span class="bp">self</span><span class="o">.</span><span class="n">n_delays</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">delay_interval</span> <span class="o">+</span> <span class="n">steps_ahead</span><span class="p">],</span> <span class="n">H_test_havok_dmd</span><span class="p">[:,</span> <span class="n">steps_ahead</span><span class="p">:,</span> <span class="p">:</span><span class="bp">self</span><span class="o">.</span><span class="n">n</span><span class="p">]])</span>

        <span class="k">if</span> <span class="n">ndim</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
            <span class="n">pred_data</span> <span class="o">=</span> <span class="n">pred_data</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

        <span class="k">if</span> <span class="n">full_return</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">pred_data</span><span class="p">,</span> <span class="n">H_test_havok_dmd</span><span class="p">,</span> <span class="n">H_test</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">pred_data</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">all_to_device</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">device</span><span class="o">=</span><span class="s1">'cpu'</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">k</span><span class="p">,</span><span class="n">v</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="vm">__dict__</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="vm">__dict__</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">v</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">device</span><span class="p">)</span>

<span class="kn">from</span><span class="w"> </span><span class="nn">typing</span><span class="w"> </span><span class="kn">import</span> <span class="n">Literal</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">torch.nn</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">nn</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">torch.optim</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">optim</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">typing</span><span class="w"> </span><span class="kn">import</span> <span class="n">Literal</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">torch.nn.utils.parametrize</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">parametrize</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">scipy.stats</span><span class="w"> </span><span class="kn">import</span> <span class="n">wasserstein_distance</span>

<span class="k">def</span><span class="w"> </span><span class="nf">pad_zeros</span><span class="p">(</span><span class="n">A</span><span class="p">,</span><span class="n">B</span><span class="p">,</span><span class="n">device</span><span class="p">):</span>

    <span class="k">with</span> <span class="n">torch</span><span class="o">.</span><span class="n">no_grad</span><span class="p">():</span>
        <span class="n">dim</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">A</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">B</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
        <span class="n">A1</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">dim</span><span class="p">,</span><span class="n">dim</span><span class="p">))</span><span class="o">.</span><span class="n">float</span><span class="p">()</span>
        <span class="n">A1</span><span class="p">[:</span><span class="n">A</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],:</span><span class="n">A</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]]</span> <span class="o">+=</span> <span class="n">A</span>
        <span class="n">A</span> <span class="o">=</span> <span class="n">A1</span><span class="o">.</span><span class="n">float</span><span class="p">()</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">device</span><span class="p">)</span>

        <span class="n">B1</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">dim</span><span class="p">,</span><span class="n">dim</span><span class="p">))</span><span class="o">.</span><span class="n">float</span><span class="p">()</span>
        <span class="n">B1</span><span class="p">[:</span><span class="n">B</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],:</span><span class="n">B</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]]</span> <span class="o">+=</span> <span class="n">B</span>
        <span class="n">B</span> <span class="o">=</span> <span class="n">B1</span><span class="o">.</span><span class="n">float</span><span class="p">()</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">device</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">A</span><span class="p">,</span><span class="n">B</span>

<span class="k">class</span><span class="w"> </span><span class="nc">LearnableSimilarityTransform</span><span class="p">(</span><span class="n">nn</span><span class="o">.</span><span class="n">Module</span><span class="p">):</span>
<span class="w">    </span><span class="sd">"""</span>
<span class="sd">    Computes the similarity transform for a learnable orthonormal matrix C</span>
<span class="sd">    """</span>
    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">n</span><span class="p">,</span><span class="n">orthog</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
<span class="w">        </span><span class="sd">"""</span>
<span class="sd">        Parameters</span>
<span class="sd">        __________</span>
<span class="sd">        n : int</span>
<span class="sd">            dimension of the C matrix</span>
<span class="sd">        """</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">LearnableSimilarityTransform</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
        <span class="c1">#initialize orthogonal matrix as identity</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">C</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Parameter</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">eye</span><span class="p">(</span><span class="n">n</span><span class="p">)</span><span class="o">.</span><span class="n">float</span><span class="p">())</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">orthog</span> <span class="o">=</span> <span class="n">orthog</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">forward</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">B</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">orthog</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">C</span> <span class="o">@</span> <span class="n">B</span> <span class="o">@</span> <span class="bp">self</span><span class="o">.</span><span class="n">C</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">2</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">C</span> <span class="o">@</span> <span class="n">B</span> <span class="o">@</span> <span class="n">torch</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">inv</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">C</span><span class="p">)</span>

<span class="k">class</span><span class="w"> </span><span class="nc">Skew</span><span class="p">(</span><span class="n">nn</span><span class="o">.</span><span class="n">Module</span><span class="p">):</span>
    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">n</span><span class="p">,</span><span class="n">device</span><span class="p">):</span>
<span class="w">        </span><span class="sd">"""</span>
<span class="sd">        Computes a skew-symmetric matrix X from some parameters (also called X)</span>

<span class="sd">        """</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">L1</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Linear</span><span class="p">(</span><span class="n">n</span><span class="p">,</span><span class="n">n</span><span class="p">,</span><span class="n">bias</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span> <span class="n">device</span> <span class="o">=</span> <span class="n">device</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">L2</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Linear</span><span class="p">(</span><span class="n">n</span><span class="p">,</span><span class="n">n</span><span class="p">,</span><span class="n">bias</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span> <span class="n">device</span> <span class="o">=</span> <span class="n">device</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">L3</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Linear</span><span class="p">(</span><span class="n">n</span><span class="p">,</span><span class="n">n</span><span class="p">,</span><span class="n">bias</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span> <span class="n">device</span> <span class="o">=</span> <span class="n">device</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">forward</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">X</span><span class="p">):</span>
        <span class="n">X</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">tanh</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">L1</span><span class="p">(</span><span class="n">X</span><span class="p">))</span>
        <span class="n">X</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">tanh</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">L2</span><span class="p">(</span><span class="n">X</span><span class="p">))</span>
        <span class="n">X</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">L3</span><span class="p">(</span><span class="n">X</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">X</span> <span class="o">-</span> <span class="n">X</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">2</span><span class="p">)</span>

<span class="k">class</span><span class="w"> </span><span class="nc">Matrix</span><span class="p">(</span><span class="n">nn</span><span class="o">.</span><span class="n">Module</span><span class="p">):</span>
    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">n</span><span class="p">,</span><span class="n">device</span><span class="p">):</span>
<span class="w">        </span><span class="sd">"""</span>
<span class="sd">        Computes a matrix X from some parameters (also called X)</span>

<span class="sd">        """</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">L1</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Linear</span><span class="p">(</span><span class="n">n</span><span class="p">,</span><span class="n">n</span><span class="p">,</span><span class="n">bias</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span> <span class="n">device</span> <span class="o">=</span> <span class="n">device</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">L2</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Linear</span><span class="p">(</span><span class="n">n</span><span class="p">,</span><span class="n">n</span><span class="p">,</span><span class="n">bias</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span> <span class="n">device</span> <span class="o">=</span> <span class="n">device</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">L3</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Linear</span><span class="p">(</span><span class="n">n</span><span class="p">,</span><span class="n">n</span><span class="p">,</span><span class="n">bias</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span> <span class="n">device</span> <span class="o">=</span> <span class="n">device</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">forward</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">X</span><span class="p">):</span>
        <span class="n">X</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">tanh</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">L1</span><span class="p">(</span><span class="n">X</span><span class="p">))</span>
        <span class="n">X</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">tanh</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">L2</span><span class="p">(</span><span class="n">X</span><span class="p">))</span>
        <span class="n">X</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">L3</span><span class="p">(</span><span class="n">X</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">X</span>

<span class="k">class</span><span class="w"> </span><span class="nc">CayleyMap</span><span class="p">(</span><span class="n">nn</span><span class="o">.</span><span class="n">Module</span><span class="p">):</span>
<span class="w">    </span><span class="sd">"""</span>
<span class="sd">    Maps a skew-symmetric matrix to an orthogonal matrix in O(n)</span>
<span class="sd">    """</span>
    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">n</span><span class="p">,</span> <span class="n">device</span><span class="p">):</span>
<span class="w">        </span><span class="sd">"""</span>
<span class="sd">        Parameters</span>
<span class="sd">        __________</span>

<span class="sd">        n : int</span>
<span class="sd">            dimension of the matrix we want to map</span>

<span class="sd">        device : {'cpu','cuda'} or int</span>
<span class="sd">            hardware device on which to send the matrix</span>
<span class="sd">        """</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">register_buffer</span><span class="p">(</span><span class="s2">"Id"</span><span class="p">,</span> <span class="n">torch</span><span class="o">.</span><span class="n">eye</span><span class="p">(</span><span class="n">n</span><span class="p">,</span><span class="n">device</span> <span class="o">=</span> <span class="n">device</span><span class="p">))</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">forward</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">X</span><span class="p">):</span>
        <span class="c1"># (I + X)(I - X)^{-1}</span>
        <span class="k">return</span> <span class="n">torch</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">solve</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Id</span> <span class="o">+</span> <span class="n">X</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">Id</span> <span class="o">-</span> <span class="n">X</span><span class="p">)</span>

<span class="k">class</span><span class="w"> </span><span class="nc">SimilarityTransformDist</span><span class="p">:</span>
<span class="w">    </span><span class="sd">"""</span>
<span class="sd">    Computes the Procrustes Analysis over Vector Fields</span>
<span class="sd">    """</span>
    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>
                <span class="n">iters</span> <span class="o">=</span> <span class="mi">200</span><span class="p">,</span>
                <span class="n">score_method</span><span class="p">:</span> <span class="n">Literal</span><span class="p">[</span><span class="s2">"angular"</span><span class="p">,</span> <span class="s2">"euclidean"</span><span class="p">,</span><span class="s2">"wasserstein"</span><span class="p">]</span> <span class="o">=</span> <span class="s2">"angular"</span><span class="p">,</span>
                <span class="n">lr</span> <span class="o">=</span> <span class="mf">0.01</span><span class="p">,</span>
                <span class="n">device</span><span class="p">:</span> <span class="n">Literal</span><span class="p">[</span><span class="s2">"cpu"</span><span class="p">,</span><span class="s2">"cuda"</span><span class="p">]</span> <span class="o">=</span> <span class="s1">'cpu'</span><span class="p">,</span>
                <span class="n">verbose</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
                <span class="n">group</span><span class="p">:</span> <span class="n">Literal</span><span class="p">[</span><span class="s2">"O(n)"</span><span class="p">,</span><span class="s2">"SO(n)"</span><span class="p">,</span><span class="s2">"GL(n)"</span><span class="p">]</span> <span class="o">=</span> <span class="s2">"O(n)"</span><span class="p">,</span>
                <span class="n">wasserstein_compare</span> <span class="o">=</span> <span class="kc">None</span>
                <span class="p">):</span>
<span class="w">        </span><span class="sd">"""</span>
<span class="sd">        Parameters</span>
<span class="sd">        _________</span>
<span class="sd">        iters : int</span>
<span class="sd">            number of iterations to perform gradient descent</span>

<span class="sd">        score_method : {"angular","euclidean","wasserstein"}</span>
<span class="sd">            specifies the type of metric to use</span>
<span class="sd">            "wasserstein" will compare the singular values or eigenvalues</span>
<span class="sd">            of the two matrices as in Redman et al., (2023)</span>

<span class="sd">        lr : float</span>
<span class="sd">            learning rate</span>

<span class="sd">        device : {'cpu','cuda'} or int</span>

<span class="sd">        verbose : bool</span>
<span class="sd">            prints when finished optimizing</span>

<span class="sd">        group : {'SO(n)','O(n)', 'GL(n)'}</span>
<span class="sd">            specifies the group of matrices to optimize over</span>

<span class="sd">        wasserstein_compare : {'sv','eig',None}</span>
<span class="sd">            specifies whether to compare the singular values or eigenvalues</span>
<span class="sd">            if score_method is "wasserstein", or the shapes are different</span>
<span class="sd">        """</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">iters</span> <span class="o">=</span> <span class="n">iters</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">score_method</span> <span class="o">=</span> <span class="n">score_method</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lr</span> <span class="o">=</span> <span class="n">lr</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">verbose</span> <span class="o">=</span> <span class="n">verbose</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">device</span> <span class="o">=</span> <span class="n">device</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">C_star</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">A</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">B</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">group</span> <span class="o">=</span> <span class="n">group</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">wasserstein_compare</span> <span class="o">=</span> <span class="n">wasserstein_compare</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">fit</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>
            <span class="n">A</span><span class="p">,</span>
            <span class="n">B</span><span class="p">,</span>
            <span class="n">iters</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
            <span class="n">lr</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
            <span class="n">group</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
            <span class="p">):</span>
<span class="w">        </span><span class="sd">"""</span>
<span class="sd">        Computes the optimal matrix C over specified group</span>

<span class="sd">        Parameters</span>
<span class="sd">        __________</span>
<span class="sd">        A : np.array or torch.tensor</span>
<span class="sd">            first data matrix</span>
<span class="sd">        B : np.array or torch.tensor</span>
<span class="sd">            second data matrix</span>
<span class="sd">        iters : int or None</span>
<span class="sd">            number of optimization steps, if None then resorts to saved self.iters</span>
<span class="sd">        lr : float or None</span>
<span class="sd">            learning rate, if None then resorts to saved self.lr</span>
<span class="sd">        group : {'SO(n)','O(n)', 'GL(n)'}</span>
<span class="sd">            specifies the group of matrices to optimize over</span>

<span class="sd">        Returns</span>
<span class="sd">        _______</span>
<span class="sd">        None</span>
<span class="sd">        """</span>
        <span class="k">assert</span> <span class="n">A</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="n">A</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
        <span class="k">assert</span> <span class="n">B</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="n">B</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>

        <span class="n">A</span> <span class="o">=</span> <span class="n">A</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">device</span><span class="p">)</span>
        <span class="n">B</span> <span class="o">=</span> <span class="n">B</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">device</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">A</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">B</span> <span class="o">=</span> <span class="n">A</span><span class="p">,</span><span class="n">B</span>
        <span class="n">lr</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">lr</span> <span class="k">if</span> <span class="n">lr</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">lr</span>
        <span class="n">iters</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">iters</span> <span class="k">if</span> <span class="n">iters</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">iters</span>
        <span class="n">group</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">group</span> <span class="k">if</span> <span class="n">group</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">group</span>

        <span class="k">if</span> <span class="n">group</span> <span class="ow">in</span> <span class="p">{</span><span class="s2">"SO(n)"</span><span class="p">,</span> <span class="s2">"O(n)"</span><span class="p">}:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">losses</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">C_star</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">sim_net</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">optimize_C</span><span class="p">(</span><span class="n">A</span><span class="p">,</span>
                                                                     <span class="n">B</span><span class="p">,</span>
                                                                     <span class="n">lr</span><span class="p">,</span><span class="n">iters</span><span class="p">,</span>
                                                                     <span class="n">orthog</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                                                                     <span class="n">verbose</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">verbose</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">group</span> <span class="o">==</span> <span class="s2">"O(n)"</span><span class="p">:</span>
            <span class="c1">#permute the first row and column of B then rerun the optimization</span>
            <span class="n">P</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">eye</span><span class="p">(</span><span class="n">B</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">device</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">device</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">P</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
                <span class="n">P</span><span class="p">[[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span> <span class="p">:]</span> <span class="o">=</span> <span class="n">P</span><span class="p">[[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span> <span class="p">:]</span>
            <span class="n">losses</span><span class="p">,</span> <span class="n">C_star</span><span class="p">,</span> <span class="n">sim_net</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">optimize_C</span><span class="p">(</span><span class="n">A</span><span class="p">,</span>
                                                    <span class="n">P</span> <span class="o">@</span> <span class="n">B</span> <span class="o">@</span> <span class="n">P</span><span class="o">.</span><span class="n">T</span><span class="p">,</span>
                                                    <span class="n">lr</span><span class="p">,</span><span class="n">iters</span><span class="p">,</span>
                                                    <span class="n">orthog</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                                                    <span class="n">verbose</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">verbose</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">losses</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">losses</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">losses</span> <span class="o">=</span> <span class="n">losses</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">C_star</span> <span class="o">=</span> <span class="n">C_star</span> <span class="o">@</span> <span class="n">P</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">sim_net</span> <span class="o">=</span> <span class="n">sim_net</span>
        <span class="k">if</span> <span class="n">group</span> <span class="o">==</span> <span class="s2">"GL(n)"</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">losses</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">C_star</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">sim_net</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">optimize_C</span><span class="p">(</span><span class="n">A</span><span class="p">,</span>
                                                                <span class="n">B</span><span class="p">,</span>
                                                                <span class="n">lr</span><span class="p">,</span><span class="n">iters</span><span class="p">,</span>
                                                                <span class="n">orthog</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                                                                <span class="n">verbose</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">verbose</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">optimize_C</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">A</span><span class="p">,</span><span class="n">B</span><span class="p">,</span><span class="n">lr</span><span class="p">,</span><span class="n">iters</span><span class="p">,</span><span class="n">orthog</span><span class="p">,</span><span class="n">verbose</span><span class="p">):</span>
        <span class="c1">#parameterize mapping to be orthogonal</span>
        <span class="n">n</span> <span class="o">=</span> <span class="n">A</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">sim_net</span> <span class="o">=</span> <span class="n">LearnableSimilarityTransform</span><span class="p">(</span><span class="n">n</span><span class="p">,</span><span class="n">orthog</span><span class="o">=</span><span class="n">orthog</span><span class="p">)</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">device</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">orthog</span><span class="p">:</span>
            <span class="n">parametrize</span><span class="o">.</span><span class="n">register_parametrization</span><span class="p">(</span><span class="n">sim_net</span><span class="p">,</span> <span class="s2">"C"</span><span class="p">,</span> <span class="n">Skew</span><span class="p">(</span><span class="n">n</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">device</span><span class="p">))</span>
            <span class="n">parametrize</span><span class="o">.</span><span class="n">register_parametrization</span><span class="p">(</span><span class="n">sim_net</span><span class="p">,</span> <span class="s2">"C"</span><span class="p">,</span> <span class="n">CayleyMap</span><span class="p">(</span><span class="n">n</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">device</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">parametrize</span><span class="o">.</span><span class="n">register_parametrization</span><span class="p">(</span><span class="n">sim_net</span><span class="p">,</span> <span class="s2">"C"</span><span class="p">,</span> <span class="n">Matrix</span><span class="p">(</span><span class="n">n</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">device</span><span class="p">))</span>

        <span class="n">simdist_loss</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">MSELoss</span><span class="p">(</span><span class="n">reduction</span> <span class="o">=</span> <span class="s1">'sum'</span><span class="p">)</span>

        <span class="n">optimizer</span> <span class="o">=</span> <span class="n">optim</span><span class="o">.</span><span class="n">Adam</span><span class="p">(</span><span class="n">sim_net</span><span class="o">.</span><span class="n">parameters</span><span class="p">(),</span> <span class="n">lr</span><span class="o">=</span><span class="n">lr</span><span class="p">)</span>
        <span class="c1"># scheduler = optim.lr_scheduler.ExponentialLR(optimizer, gamma=0.999)</span>

        <span class="n">losses</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">A</span> <span class="o">/=</span> <span class="n">torch</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">A</span><span class="p">)</span>
        <span class="n">B</span> <span class="o">/=</span> <span class="n">torch</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">B</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">iters</span><span class="p">):</span>
            <span class="c1"># Zero the gradients of the optimizer.</span>
            <span class="n">optimizer</span><span class="o">.</span><span class="n">zero_grad</span><span class="p">()</span>
            <span class="c1"># Compute the Frobenius norm between A and the product.</span>
            <span class="n">loss</span> <span class="o">=</span> <span class="n">simdist_loss</span><span class="p">(</span><span class="n">A</span><span class="p">,</span> <span class="n">sim_net</span><span class="p">(</span><span class="n">B</span><span class="p">))</span>

            <span class="n">loss</span><span class="o">.</span><span class="n">backward</span><span class="p">()</span>

            <span class="n">optimizer</span><span class="o">.</span><span class="n">step</span><span class="p">()</span>
            <span class="c1"># if _ % 99:</span>
            <span class="c1">#     scheduler.step()</span>
            <span class="n">losses</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">loss</span><span class="o">.</span><span class="n">item</span><span class="p">())</span>

        <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">"Finished optimizing C"</span><span class="p">)</span>

        <span class="n">C_star</span> <span class="o">=</span> <span class="n">sim_net</span><span class="o">.</span><span class="n">C</span><span class="o">.</span><span class="n">detach</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">losses</span><span class="p">,</span> <span class="n">C_star</span><span class="p">,</span><span class="n">sim_net</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">score</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">A</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">B</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">score_method</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">group</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">        </span><span class="sd">"""</span>
<span class="sd">        Given an optimal C already computed, calculate the metric</span>

<span class="sd">        Parameters</span>
<span class="sd">        __________</span>
<span class="sd">        A : np.array or torch.tensor or None</span>
<span class="sd">            first data matrix, if None defaults to the saved matrix in fit</span>
<span class="sd">        B : np.array or torch.tensor or None</span>
<span class="sd">            second data matrix if None, defaults to the savec matrix in fit</span>
<span class="sd">        score_method : None or {'angular','euclidean'}</span>
<span class="sd">            overwrites the score method in the object for this application</span>
<span class="sd">        Returns</span>
<span class="sd">        _______</span>

<span class="sd">        score : float</span>
<span class="sd">            similarity of the data under the similarity transform w.r.t C</span>
<span class="sd">        """</span>
        <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">C_star</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
        <span class="n">A</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">A</span> <span class="k">if</span> <span class="n">A</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">A</span>
        <span class="n">B</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">B</span> <span class="k">if</span> <span class="n">B</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">B</span>
        <span class="k">assert</span> <span class="n">A</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
        <span class="k">assert</span> <span class="n">B</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
        <span class="k">assert</span> <span class="n">A</span><span class="o">.</span><span class="n">shape</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">C_star</span><span class="o">.</span><span class="n">shape</span>
        <span class="k">assert</span> <span class="n">B</span><span class="o">.</span><span class="n">shape</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">C_star</span><span class="o">.</span><span class="n">shape</span>
        <span class="n">score_method</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">score_method</span> <span class="k">if</span> <span class="n">score_method</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">score_method</span>
        <span class="n">group</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">group</span> <span class="k">if</span> <span class="n">group</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">group</span>
        <span class="k">with</span> <span class="n">torch</span><span class="o">.</span><span class="n">no_grad</span><span class="p">():</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">A</span><span class="p">,</span><span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">):</span>
                <span class="n">A</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">from_numpy</span><span class="p">(</span><span class="n">A</span><span class="p">)</span><span class="o">.</span><span class="n">float</span><span class="p">()</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">device</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">B</span><span class="p">,</span><span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">):</span>
                <span class="n">B</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">from_numpy</span><span class="p">(</span><span class="n">B</span><span class="p">)</span><span class="o">.</span><span class="n">float</span><span class="p">()</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">device</span><span class="p">)</span>
            <span class="n">C</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">C_star</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">device</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">group</span> <span class="ow">in</span> <span class="p">{</span><span class="s2">"SO(n)"</span><span class="p">,</span> <span class="s2">"O(n)"</span><span class="p">}:</span>
            <span class="n">Cinv</span> <span class="o">=</span> <span class="n">C</span><span class="o">.</span><span class="n">T</span>
        <span class="k">elif</span> <span class="n">group</span> <span class="ow">in</span> <span class="p">{</span><span class="s2">"GL(n)"</span><span class="p">}:</span>
            <span class="n">Cinv</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">inv</span><span class="p">(</span><span class="n">C</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">AssertionError</span><span class="p">(</span><span class="s2">"Need proper group name"</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">score_method</span> <span class="o">==</span> <span class="s1">'angular'</span><span class="p">:</span>
            <span class="n">num</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">trace</span><span class="p">(</span><span class="n">A</span><span class="o">.</span><span class="n">T</span> <span class="o">@</span> <span class="n">C</span> <span class="o">@</span> <span class="n">B</span> <span class="o">@</span> <span class="n">Cinv</span><span class="p">)</span>
            <span class="n">den</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">A</span><span class="p">,</span><span class="n">p</span> <span class="o">=</span> <span class="s1">'fro'</span><span class="p">)</span><span class="o">*</span><span class="n">torch</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">B</span><span class="p">,</span><span class="n">p</span> <span class="o">=</span> <span class="s1">'fro'</span><span class="p">)</span>
            <span class="n">score</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">arccos</span><span class="p">(</span><span class="n">num</span><span class="o">/</span><span class="n">den</span><span class="p">)</span><span class="o">.</span><span class="n">cpu</span><span class="p">()</span><span class="o">.</span><span class="n">numpy</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">score</span><span class="p">):</span> <span class="c1">#around -1 and 1, we sometimes get NaNs due to arccos</span>
                <span class="k">if</span> <span class="n">num</span><span class="o">/</span><span class="n">den</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="n">score</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">score</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">score</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">A</span> <span class="o">-</span> <span class="n">C</span> <span class="o">@</span> <span class="n">B</span> <span class="o">@</span> <span class="n">Cinv</span><span class="p">,</span><span class="n">p</span><span class="o">=</span><span class="s1">'fro'</span><span class="p">)</span><span class="o">.</span><span class="n">cpu</span><span class="p">()</span><span class="o">.</span><span class="n">numpy</span><span class="p">()</span><span class="o">.</span><span class="n">item</span><span class="p">()</span> <span class="c1">#/ A.numpy().size</span>

        <span class="k">return</span> <span class="n">score</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">fit_score</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>
                <span class="n">A</span><span class="p">,</span>
                <span class="n">B</span><span class="p">,</span>
                <span class="n">iters</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                <span class="n">lr</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                <span class="n">score_method</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                <span class="n">zero_pad</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
                <span class="n">group</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span>
<span class="w">        </span><span class="sd">"""</span>
<span class="sd">        for efficiency, computes the optimal matrix and returns the score</span>

<span class="sd">        Parameters</span>
<span class="sd">        __________</span>
<span class="sd">        A : np.array or torch.tensor</span>
<span class="sd">            first data matrix</span>
<span class="sd">        B : np.array or torch.tensor</span>
<span class="sd">            second data matrix</span>
<span class="sd">        iters : int or None</span>
<span class="sd">            number of optimization steps, if None then resorts to saved self.iters</span>
<span class="sd">        lr : float or None</span>
<span class="sd">            learning rate, if None then resorts to saved self.lr</span>
<span class="sd">        score_method : {'angular','euclidean'} or None</span>
<span class="sd">            overwrites parameter in the class</span>
<span class="sd">        zero_pad : bool</span>
<span class="sd">            if True, then the smaller matrix will be zero padded so its the same size</span>
<span class="sd">        Returns</span>
<span class="sd">        _______</span>

<span class="sd">        score : float</span>
<span class="sd">            similarity of the data under the similarity transform w.r.t C</span>

<span class="sd">        """</span>
        <span class="n">score_method</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">score_method</span> <span class="k">if</span> <span class="n">score_method</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">score_method</span>
        <span class="n">group</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">group</span> <span class="k">if</span> <span class="n">group</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">group</span>

        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">A</span><span class="p">,</span><span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">):</span>
            <span class="n">A</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">from_numpy</span><span class="p">(</span><span class="n">A</span><span class="p">)</span><span class="o">.</span><span class="n">float</span><span class="p">()</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">B</span><span class="p">,</span><span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">):</span>
            <span class="n">B</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">from_numpy</span><span class="p">(</span><span class="n">B</span><span class="p">)</span><span class="o">.</span><span class="n">float</span><span class="p">()</span>

        <span class="k">assert</span> <span class="n">A</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="n">B</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">wasserstein_compare</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="n">A</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">!=</span> <span class="n">B</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">wasserstein_compare</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">AssertionError</span><span class="p">(</span><span class="s2">"Matrices must be the same size unless using wasserstein distance"</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span> <span class="c1">#otherwise resort to L2 Wasserstein over singular or eigenvalues</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"resorting to wasserstein distance over </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">wasserstein_compare</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">score_method</span> <span class="o">==</span> <span class="s2">"wasserstein"</span><span class="p">:</span>
            <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">wasserstein_compare</span> <span class="ow">in</span> <span class="p">{</span><span class="s2">"sv"</span><span class="p">,</span><span class="s2">"eig"</span><span class="p">}</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">wasserstein_compare</span> <span class="o">==</span> <span class="s2">"sv"</span><span class="p">:</span>
                <span class="n">a</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">svd</span><span class="p">(</span><span class="n">A</span><span class="p">)</span><span class="o">.</span><span class="n">S</span><span class="o">.</span><span class="n">view</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span>
                <span class="n">b</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">svd</span><span class="p">(</span><span class="n">B</span><span class="p">)</span><span class="o">.</span><span class="n">S</span><span class="o">.</span><span class="n">view</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span>
            <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">wasserstein_compare</span> <span class="o">==</span> <span class="s2">"eig"</span><span class="p">:</span>
                <span class="n">a</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">eig</span><span class="p">(</span><span class="n">A</span><span class="p">)</span><span class="o">.</span><span class="n">eigenvalues</span>
                <span class="n">a</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">vstack</span><span class="p">([</span><span class="n">a</span><span class="o">.</span><span class="n">real</span><span class="p">,</span><span class="n">a</span><span class="o">.</span><span class="n">imag</span><span class="p">])</span><span class="o">.</span><span class="n">T</span>

                <span class="n">b</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">eig</span><span class="p">(</span><span class="n">B</span><span class="p">)</span><span class="o">.</span><span class="n">eigenvalues</span>
                <span class="n">b</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">vstack</span><span class="p">([</span><span class="n">b</span><span class="o">.</span><span class="n">real</span><span class="p">,</span><span class="n">b</span><span class="o">.</span><span class="n">imag</span><span class="p">])</span><span class="o">.</span><span class="n">T</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">AssertionError</span><span class="p">(</span><span class="s2">"wasserstein_compare must be 'sv' or 'eig'"</span><span class="p">)</span>
            <span class="n">device</span> <span class="o">=</span> <span class="n">a</span><span class="o">.</span><span class="n">device</span>
            <span class="n">a</span> <span class="o">=</span> <span class="n">a</span><span class="c1">#.cpu()</span>
            <span class="n">b</span> <span class="o">=</span> <span class="n">b</span><span class="c1">#.cpu()</span>
            <span class="n">M</span> <span class="o">=</span> <span class="n">ot</span><span class="o">.</span><span class="n">dist</span><span class="p">(</span><span class="n">a</span><span class="p">,</span><span class="n">b</span><span class="p">)</span><span class="c1">#.numpy()</span>
            <span class="n">a</span><span class="p">,</span><span class="n">b</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="n">a</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span><span class="o">/</span><span class="n">a</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">torch</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="n">b</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span><span class="o">/</span><span class="n">b</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">a</span><span class="p">,</span><span class="n">b</span> <span class="o">=</span> <span class="n">a</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">device</span><span class="p">),</span><span class="n">b</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">device</span><span class="p">)</span>

            <span class="n">score_star</span> <span class="o">=</span> <span class="n">ot</span><span class="o">.</span><span class="n">emd2</span><span class="p">(</span><span class="n">a</span><span class="p">,</span><span class="n">b</span><span class="p">,</span><span class="n">M</span><span class="p">)</span>
            <span class="c1">#wasserstein_distance(A.cpu().numpy(),B.cpu().numpy())</span>

        <span class="k">else</span><span class="p">:</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">A</span><span class="p">,</span> <span class="n">B</span><span class="p">,</span><span class="n">iters</span><span class="p">,</span><span class="n">lr</span><span class="p">,</span><span class="n">group</span><span class="p">)</span>
            <span class="n">score_star</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">score</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">A</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">B</span><span class="p">,</span><span class="n">score_method</span><span class="o">=</span><span class="n">score_method</span><span class="p">,</span><span class="n">group</span><span class="o">=</span><span class="n">group</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">score_star</span>

<span class="k">class</span><span class="w"> </span><span class="nc">DSA</span><span class="p">:</span>
<span class="w">    </span><span class="sd">"""</span>
<span class="sd">    Computes the Dynamical Similarity Analysis (DSA) for two data matrices</span>
<span class="sd">    """</span>
    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>
                <span class="n">X</span><span class="p">,</span>
                <span class="n">Y</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                <span class="n">n_delays</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
                <span class="n">delay_interval</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
                <span class="n">rank</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                <span class="n">rank_thresh</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                <span class="n">rank_explained_variance</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                <span class="n">lamb</span> <span class="o">=</span> <span class="mf">0.0</span><span class="p">,</span>
                <span class="n">send_to_cpu</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
                <span class="n">iters</span> <span class="o">=</span> <span class="mi">1500</span><span class="p">,</span>
                <span class="n">score_method</span><span class="p">:</span> <span class="n">Literal</span><span class="p">[</span><span class="s2">"angular"</span><span class="p">,</span> <span class="s2">"euclidean"</span><span class="p">,</span><span class="s2">"wasserstein"</span><span class="p">]</span> <span class="o">=</span> <span class="s2">"angular"</span><span class="p">,</span>
                <span class="n">lr</span> <span class="o">=</span> <span class="mf">5e-3</span><span class="p">,</span>
                <span class="n">group</span><span class="p">:</span> <span class="n">Literal</span><span class="p">[</span><span class="s2">"GL(n)"</span><span class="p">,</span> <span class="s2">"O(n)"</span><span class="p">,</span> <span class="s2">"SO(n)"</span><span class="p">]</span> <span class="o">=</span> <span class="s2">"O(n)"</span><span class="p">,</span>
                <span class="n">zero_pad</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
                <span class="n">device</span> <span class="o">=</span> <span class="s1">'cpu'</span><span class="p">,</span>
                <span class="n">verbose</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
                <span class="n">reduced_rank_reg</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
                <span class="n">kernel</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                <span class="n">num_centers</span><span class="o">=</span><span class="mf">0.1</span><span class="p">,</span>
                <span class="n">svd_solver</span><span class="o">=</span><span class="s1">'arnoldi'</span><span class="p">,</span>
                <span class="n">wasserstein_compare</span><span class="p">:</span> <span class="n">Literal</span><span class="p">[</span><span class="s1">'sv'</span><span class="p">,</span><span class="s1">'eig'</span><span class="p">,</span><span class="kc">None</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="p">):</span>
<span class="w">        </span><span class="sd">"""</span>
<span class="sd">        Parameters</span>
<span class="sd">        __________</span>

<span class="sd">        X : np.array or torch.tensor or list of np.arrays or torch.tensors</span>
<span class="sd">            first data matrix/matrices</span>

<span class="sd">        Y : None or np.array or torch.tensor or list of np.arrays or torch.tensors</span>
<span class="sd">            second data matrix/matrices.</span>
<span class="sd">            * If Y is None, X is compared to itself pairwise</span>
<span class="sd">            (must be a list)</span>
<span class="sd">            * If Y is a single matrix, all matrices in X are compared to Y</span>
<span class="sd">            * If Y is a list, all matrices in X are compared to all matrices in Y</span>

<span class="sd">        DMD parameters:</span>

<span class="sd">        n_delays : int or list or tuple/list: (int,int), (list,list),(list,int),(int,list)</span>
<span class="sd">            number of delays to use in constructing the Hankel matrix</span>

<span class="sd">        delay_interval : int or list or tuple/list: (int,int), (list,list),(list,int),(int,list)</span>
<span class="sd">            interval between samples taken in constructing Hankel matrix</span>

<span class="sd">        rank : int or list or tuple/list: (int,int), (list,list),(list,int),(int,list)</span>
<span class="sd">            rank of DMD matrix fit in reduced-rank regression</span>

<span class="sd">        rank_thresh : float or list or tuple/list: (float,float), (list,list),(list,float),(float,list)</span>
<span class="sd">            Parameter that controls the rank of V in fitting HAVOK DMD by dictating a threshold</span>
<span class="sd">            of singular values to use. Explicitly, the rank of V will be the number of singular</span>
<span class="sd">            values greater than rank_thresh. Defaults to None.</span>

<span class="sd">        rank_explained_variance : float or list or tuple: (float,float), (list,list),(list,float),(float,list)</span>
<span class="sd">            Parameter that controls the rank of V in fitting HAVOK DMD by indicating the percentage of</span>
<span class="sd">            cumulative explained variance that should be explained by the columns of V. Defaults to None.</span>

<span class="sd">        lamb : float</span>
<span class="sd">            L-1 regularization parameter in DMD fit</span>

<span class="sd">        send_to_cpu: bool</span>
<span class="sd">            If True, will send all tensors in the object back to the cpu after everything is computed.</span>
<span class="sd">            This is implemented to prevent gpu memory overload when computing multiple DMDs.</span>

<span class="sd">        NOTE: for all of these above, they can be single values or lists or tuples,</span>
<span class="sd">            depending on the corresponding dimensions of the data</span>
<span class="sd">            If at least one of X and Y are lists, then if they are a single value</span>
<span class="sd">                it will default to the rank of all DMD matrices.</span>
<span class="sd">            If they are (int,int), then they will correspond to an individual dmd matrix</span>
<span class="sd">                OR to X and Y respectively across all matrices</span>
<span class="sd">            If it is (list,list), then each element will correspond to an individual</span>
<span class="sd">                dmd matrix indexed at the same position</span>

<span class="sd">        SimDist parameters:</span>

<span class="sd">        iters : int</span>
<span class="sd">            number of optimization iterations in Procrustes over vector fields</span>

<span class="sd">        score_method : {'angular','euclidean'}</span>
<span class="sd">            type of metric to compute, angular vs euclidean distance</span>

<span class="sd">        lr : float</span>
<span class="sd">            learning rate of the Procrustes over vector fields optimization</span>

<span class="sd">        group : {'SO(n)','O(n)', 'GL(n)'}</span>
<span class="sd">            specifies the group of matrices to optimize over</span>

<span class="sd">        zero_pad : bool</span>
<span class="sd">            whether or not to zero-pad if the dimensions are different</span>

<span class="sd">        device : 'cpu' or 'cuda' or int</span>
<span class="sd">            hardware to use in both DMD and PoVF</span>

<span class="sd">        verbose : bool</span>
<span class="sd">            whether or not print when sections of the analysis is completed</span>

<span class="sd">        wasserstein_compare : {'sv','eig',None}</span>
<span class="sd">            specifies whether to compare the singular values or eigenvalues</span>
<span class="sd">            if score_method is "wasserstein", or the shapes are different</span>
<span class="sd">        """</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">X</span> <span class="o">=</span> <span class="n">X</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">Y</span> <span class="o">=</span> <span class="n">Y</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">X</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Y</span><span class="p">,</span><span class="nb">list</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">X</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">Y</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">Y</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">X</span> <span class="c1">#swap so code is easy</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">check_method</span><span class="p">()</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">method</span> <span class="o">==</span> <span class="s1">'self-pairwise'</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">data</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">X</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">data</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">X</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">Y</span><span class="p">]</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">n_delays</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">broadcast_params</span><span class="p">(</span><span class="n">n_delays</span><span class="p">,</span><span class="n">cast</span><span class="o">=</span><span class="nb">int</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">delay_interval</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">broadcast_params</span><span class="p">(</span><span class="n">delay_interval</span><span class="p">,</span><span class="n">cast</span><span class="o">=</span><span class="nb">int</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">rank</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">broadcast_params</span><span class="p">(</span><span class="n">rank</span><span class="p">,</span><span class="n">cast</span><span class="o">=</span><span class="nb">int</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">rank_thresh</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">broadcast_params</span><span class="p">(</span><span class="n">rank_thresh</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">rank_explained_variance</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">broadcast_params</span><span class="p">(</span><span class="n">rank_explained_variance</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lamb</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">broadcast_params</span><span class="p">(</span><span class="n">lamb</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">send_to_cpu</span> <span class="o">=</span> <span class="n">send_to_cpu</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">iters</span> <span class="o">=</span> <span class="n">iters</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">score_method</span> <span class="o">=</span> <span class="n">score_method</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lr</span> <span class="o">=</span> <span class="n">lr</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">device</span> <span class="o">=</span> <span class="n">device</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">verbose</span> <span class="o">=</span> <span class="n">verbose</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">zero_pad</span> <span class="o">=</span> <span class="n">zero_pad</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">group</span> <span class="o">=</span> <span class="n">group</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">reduced_rank_reg</span> <span class="o">=</span> <span class="n">reduced_rank_reg</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">kernel</span> <span class="o">=</span> <span class="n">kernel</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">wasserstein_compare</span> <span class="o">=</span> <span class="n">wasserstein_compare</span>

        <span class="k">if</span> <span class="n">kernel</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="c1">#get a list of all DMDs here</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">dmds</span> <span class="o">=</span> <span class="p">[[</span><span class="n">DMD</span><span class="p">(</span><span class="n">Xi</span><span class="p">,</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">n_delays</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">j</span><span class="p">],</span>
                    <span class="n">delay_interval</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">delay_interval</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">j</span><span class="p">],</span>
                    <span class="n">rank</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">rank</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">j</span><span class="p">],</span>
                    <span class="n">rank_thresh</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">rank_thresh</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">j</span><span class="p">],</span>
                    <span class="n">rank_explained_variance</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">rank_explained_variance</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">j</span><span class="p">],</span>
                    <span class="n">reduced_rank_reg</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">reduced_rank_reg</span><span class="p">,</span>
                    <span class="n">lamb</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">lamb</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">j</span><span class="p">],</span>
                    <span class="n">device</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">device</span><span class="p">,</span>
                    <span class="n">verbose</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">verbose</span><span class="p">,</span>
                    <span class="n">send_to_cpu</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">send_to_cpu</span><span class="p">)</span> <span class="k">for</span> <span class="n">j</span><span class="p">,</span><span class="n">Xi</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">dat</span><span class="p">)]</span> <span class="k">for</span> <span class="n">i</span><span class="p">,</span><span class="n">dat</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">)]</span>
        <span class="k">else</span><span class="p">:</span>
             <span class="c1">#get a list of all DMDs here</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">dmds</span> <span class="o">=</span> <span class="p">[[</span><span class="n">KernelDMD</span><span class="p">(</span><span class="n">Xi</span><span class="p">,</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">n_delays</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">j</span><span class="p">],</span>
                    <span class="n">kernel</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">kernel</span><span class="p">,</span>
                    <span class="n">num_centers</span><span class="o">=</span><span class="n">num_centers</span><span class="p">,</span>
                    <span class="n">delay_interval</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">delay_interval</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">j</span><span class="p">],</span>
                    <span class="n">rank</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">rank</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">j</span><span class="p">],</span>
                    <span class="n">reduced_rank_reg</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">reduced_rank_reg</span><span class="p">,</span>
                    <span class="n">lamb</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">lamb</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">j</span><span class="p">],</span>
                    <span class="n">verbose</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">verbose</span><span class="p">,</span>
                    <span class="n">svd_solver</span><span class="o">=</span><span class="n">svd_solver</span><span class="p">,</span>
                    <span class="p">)</span> <span class="k">for</span> <span class="n">j</span><span class="p">,</span><span class="n">Xi</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">dat</span><span class="p">)]</span> <span class="k">for</span> <span class="n">i</span><span class="p">,</span><span class="n">dat</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">)]</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">simdist</span> <span class="o">=</span> <span class="n">SimilarityTransformDist</span><span class="p">(</span><span class="n">iters</span><span class="p">,</span><span class="n">score_method</span><span class="p">,</span><span class="n">lr</span><span class="p">,</span><span class="n">device</span><span class="p">,</span><span class="n">verbose</span><span class="p">,</span><span class="n">group</span><span class="p">,</span><span class="n">wasserstein_compare</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">check_method</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">'''</span>
<span class="sd">        helper function to identify what type of dsa we're running</span>
<span class="sd">        '''</span>
        <span class="n">tensor_or_np</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">x</span><span class="p">,(</span><span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span><span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">))</span>

        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">X</span><span class="p">,</span><span class="nb">list</span><span class="p">):</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">Y</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">method</span> <span class="o">=</span> <span class="s1">'self-pairwise'</span>
            <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Y</span><span class="p">,</span><span class="nb">list</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">method</span> <span class="o">=</span> <span class="s1">'bipartite-pairwise'</span>
            <span class="k">elif</span> <span class="n">tensor_or_np</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Y</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">method</span> <span class="o">=</span> <span class="s1">'list-to-one'</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">Y</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">Y</span><span class="p">]</span> <span class="c1">#wrap in a list for iteration</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">'unknown type of Y'</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">tensor_or_np</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">X</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">X</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">X</span><span class="p">]</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">Y</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">'only one element provided'</span><span class="p">)</span>
            <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Y</span><span class="p">,</span><span class="nb">list</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">method</span> <span class="o">=</span> <span class="s1">'one-to-list'</span>
            <span class="k">elif</span> <span class="n">tensor_or_np</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Y</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">method</span> <span class="o">=</span> <span class="s1">'default'</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">Y</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">Y</span><span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">'unknown type of Y'</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">'unknown type of X'</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">broadcast_params</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">param</span><span class="p">,</span><span class="n">cast</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">        </span><span class="sd">'''</span>
<span class="sd">        aligns the dimensionality of the parameters with the data so it's one-to-one</span>
<span class="sd">        '''</span>
        <span class="n">out</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">param</span><span class="p">,(</span><span class="nb">int</span><span class="p">,</span><span class="nb">float</span><span class="p">,</span><span class="n">np</span><span class="o">.</span><span class="n">integer</span><span class="p">))</span> <span class="ow">or</span> <span class="n">param</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span> <span class="c1">#self.X has already been mapped to [self.X]</span>
            <span class="n">out</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">param</span><span class="p">]</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">X</span><span class="p">))</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">Y</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">out</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">param</span><span class="p">]</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Y</span><span class="p">))</span>
        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">param</span><span class="p">,(</span><span class="nb">tuple</span><span class="p">,</span><span class="nb">list</span><span class="p">,</span><span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">)):</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">method</span> <span class="o">==</span> <span class="s1">'self-pairwise'</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">param</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">X</span><span class="p">):</span>
                <span class="n">out</span> <span class="o">=</span> <span class="p">[</span><span class="n">param</span><span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">param</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="mi">2</span> <span class="c1">#only 2 elements max</span>

                <span class="c1">#if the inner terms are singly valued, we broadcast, otherwise needs to be the same dimensions</span>
                <span class="k">for</span> <span class="n">i</span><span class="p">,</span><span class="n">data</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">([</span><span class="bp">self</span><span class="o">.</span><span class="n">X</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">Y</span><span class="p">]):</span>
                    <span class="k">if</span> <span class="n">data</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                        <span class="k">continue</span>
                    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">param</span><span class="p">[</span><span class="n">i</span><span class="p">],(</span><span class="nb">int</span><span class="p">,</span><span class="nb">float</span><span class="p">)):</span>
                        <span class="n">out</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">param</span><span class="p">[</span><span class="n">i</span><span class="p">]]</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">data</span><span class="p">))</span>
                    <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">param</span><span class="p">[</span><span class="n">i</span><span class="p">],(</span><span class="nb">list</span><span class="p">,</span><span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span><span class="nb">tuple</span><span class="p">)):</span>
                        <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">param</span><span class="p">[</span><span class="n">i</span><span class="p">])</span> <span class="o">&gt;=</span> <span class="nb">len</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
                        <span class="n">out</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">param</span><span class="p">[</span><span class="n">i</span><span class="p">][:</span><span class="nb">len</span><span class="p">(</span><span class="n">data</span><span class="p">)])</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">"unknown type entered for parameter"</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">cast</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">param</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">out</span> <span class="o">=</span> <span class="p">[[</span><span class="n">cast</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">dat</span><span class="p">]</span> <span class="k">for</span> <span class="n">dat</span> <span class="ow">in</span> <span class="n">out</span><span class="p">]</span>

        <span class="k">return</span> <span class="n">out</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">fit_dmds</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>
                 <span class="n">X</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                 <span class="n">Y</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                 <span class="n">n_delays</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                 <span class="n">delay_interval</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                 <span class="n">rank</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                 <span class="n">rank_thresh</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                 <span class="n">rank_explained_variance</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                 <span class="n">reduced_rank_reg</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                 <span class="n">lamb</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                 <span class="n">device</span><span class="o">=</span><span class="s1">'cpu'</span><span class="p">,</span>
                 <span class="n">verbose</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                 <span class="n">send_to_cpu</span><span class="o">=</span><span class="kc">True</span>
                <span class="p">):</span>
<span class="w">        </span><span class="sd">"""</span>
<span class="sd">        Recomputes only the DMDs with a single set of hyperparameters. This will not compare, that will need to be done with the full procedure</span>
<span class="sd">        """</span>
        <span class="n">X</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">X</span> <span class="k">if</span> <span class="n">X</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">X</span>
        <span class="n">Y</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">Y</span> <span class="k">if</span> <span class="n">Y</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">Y</span>
        <span class="n">n_delays</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">n_delays</span> <span class="k">if</span> <span class="n">n_delays</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">n_delays</span>
        <span class="n">delay_interval</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">delay_interval</span> <span class="k">if</span> <span class="n">delay_interval</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">delay_interval</span>
        <span class="n">rank</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">rank</span> <span class="k">if</span> <span class="n">rank</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">rank</span>
        <span class="n">lamb</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">lamb</span> <span class="k">if</span> <span class="n">lamb</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">lamb</span>
        <span class="n">data</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">X</span><span class="p">,</span><span class="nb">list</span><span class="p">):</span>
            <span class="n">data</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">X</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">data</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">X</span><span class="p">])</span>
        <span class="k">if</span> <span class="n">Y</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">Y</span><span class="p">,</span><span class="nb">list</span><span class="p">):</span>
                <span class="n">data</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">Y</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">data</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">Y</span><span class="p">])</span>

        <span class="n">dmds</span> <span class="o">=</span> <span class="p">[[</span><span class="n">DMD</span><span class="p">(</span><span class="n">Xi</span><span class="p">,</span><span class="n">n_delays</span><span class="p">,</span><span class="n">delay_interval</span><span class="p">,</span>
                     <span class="n">rank</span><span class="p">,</span><span class="n">rank_thresh</span><span class="p">,</span><span class="n">rank_explained_variance</span><span class="p">,</span><span class="n">reduced_rank_reg</span><span class="p">,</span>
                     <span class="n">lamb</span><span class="p">,</span><span class="n">device</span><span class="p">,</span><span class="n">verbose</span><span class="p">,</span><span class="n">send_to_cpu</span><span class="p">)</span> <span class="k">for</span> <span class="n">Xi</span> <span class="ow">in</span> <span class="n">dat</span><span class="p">]</span> <span class="k">for</span> <span class="n">dat</span> <span class="ow">in</span> <span class="n">data</span><span class="p">]</span>

        <span class="k">for</span> <span class="n">dmd_sets</span> <span class="ow">in</span> <span class="n">dmds</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">dmd</span> <span class="ow">in</span> <span class="n">dmd_sets</span><span class="p">:</span>
                <span class="n">dmd</span><span class="o">.</span><span class="n">fit</span><span class="p">()</span>

        <span class="k">return</span> <span class="n">dmds</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">fit_score</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">"""</span>
<span class="sd">        Standard fitting function for both DMDs and PoVF</span>

<span class="sd">        Parameters</span>
<span class="sd">        __________</span>

<span class="sd">        Returns</span>
<span class="sd">        _______</span>

<span class="sd">        sims : np.array</span>
<span class="sd">            data matrix of the similarity scores between the specific sets of data</span>
<span class="sd">        """</span>
        <span class="k">for</span> <span class="n">dmd_sets</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">dmds</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">dmd</span> <span class="ow">in</span> <span class="n">dmd_sets</span><span class="p">:</span>
                <span class="n">dmd</span><span class="o">.</span><span class="n">fit</span><span class="p">()</span>

        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">score</span><span class="p">()</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">score</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">iters</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">lr</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">score_method</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">        </span><span class="sd">"""</span>
<span class="sd">        Rescore DSA with precomputed dmds if you want to try again</span>

<span class="sd">        Parameters</span>
<span class="sd">        __________</span>
<span class="sd">        iters : int or None</span>
<span class="sd">            number of optimization steps, if None then resorts to saved self.iters</span>
<span class="sd">        lr : float or None</span>
<span class="sd">            learning rate, if None then resorts to saved self.lr</span>
<span class="sd">        score_method : None or {'angular','euclidean'}</span>
<span class="sd">            overwrites the score method in the object for this application</span>

<span class="sd">        Returns</span>
<span class="sd">        ________</span>
<span class="sd">        score : float</span>
<span class="sd">            similarity score of the two precomputed DMDs</span>
<span class="sd">        """</span>

        <span class="n">iters</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">iters</span> <span class="k">if</span> <span class="n">iters</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">iters</span>
        <span class="n">lr</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">lr</span> <span class="k">if</span> <span class="n">lr</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">lr</span>
        <span class="n">score_method</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">score_method</span> <span class="k">if</span> <span class="n">score_method</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">score_method</span>

        <span class="n">ind2</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">-</span> <span class="nb">int</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">method</span> <span class="o">==</span> <span class="s1">'self-pairwise'</span><span class="p">)</span>
        <span class="c1"># 0 if self.pairwise (want to compare the set to itself)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">sims</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dmds</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dmds</span><span class="p">[</span><span class="n">ind2</span><span class="p">])))</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span><span class="n">dmd1</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dmds</span><span class="p">[</span><span class="mi">0</span><span class="p">]):</span>
            <span class="k">for</span> <span class="n">j</span><span class="p">,</span><span class="n">dmd2</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dmds</span><span class="p">[</span><span class="n">ind2</span><span class="p">]):</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">method</span> <span class="o">==</span> <span class="s1">'self-pairwise'</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">j</span> <span class="o">&gt;=</span> <span class="n">i</span><span class="p">:</span>
                        <span class="k">continue</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">verbose</span><span class="p">:</span>
                    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">'computing similarity between DMDs </span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s1"> and </span><span class="si">{</span><span class="n">j</span><span class="si">}</span><span class="s1">'</span><span class="p">)</span>

                <span class="bp">self</span><span class="o">.</span><span class="n">sims</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">simdist</span><span class="o">.</span><span class="n">fit_score</span><span class="p">(</span><span class="n">dmd1</span><span class="o">.</span><span class="n">A_v</span><span class="p">,</span><span class="n">dmd2</span><span class="o">.</span><span class="n">A_v</span><span class="p">,</span><span class="n">iters</span><span class="p">,</span><span class="n">lr</span><span class="p">,</span><span class="n">score_method</span><span class="p">,</span><span class="n">zero_pad</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">zero_pad</span><span class="p">)</span>

                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">method</span> <span class="o">==</span> <span class="s1">'self-pairwise'</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">sims</span><span class="p">[</span><span class="n">j</span><span class="p">,</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sims</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">]</span>


        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">method</span> <span class="o">==</span> <span class="s1">'default'</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">sims</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span>

        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">sims</span>
</pre></div>
</div>
</div>
</details>
</div>
</section>
<section id="helper-functions-bonus-section">
<h2>Helper functions (Bonus Section)<a class="headerlink" href="#helper-functions-bonus-section" title="Permalink to this heading">#</a></h2>
<div class="cell tag_hide-input docutils container">
<details class="hide above-input">
<summary aria-label="Toggle hidden content">
<span class="collapsed">Show code cell source</span>
<span class="expanded">Hide code cell source</span>
</summary>
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># @title Helper functions (Bonus Section)</span>

<span class="kn">import</span><span class="w"> </span><span class="nn">contextlib</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">io</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">argparse</span>
<span class="c1"># Standard library imports</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">collections</span><span class="w"> </span><span class="kn">import</span> <span class="n">OrderedDict</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">logging</span>

<span class="c1"># External libraries: General utilities</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">argparse</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">numpy</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">np</span>

<span class="c1"># PyTorch related imports</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">torch</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">torch.nn</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">nn</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">torch.nn.functional</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">F</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">torch.optim</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">optim</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">torch.optim.lr_scheduler</span><span class="w"> </span><span class="kn">import</span> <span class="n">StepLR</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">torchvision</span><span class="w"> </span><span class="kn">import</span> <span class="n">datasets</span><span class="p">,</span> <span class="n">transforms</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">torchvision.models.feature_extraction</span><span class="w"> </span><span class="kn">import</span> <span class="n">create_feature_extractor</span><span class="p">,</span> <span class="n">get_graph_node_names</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">torchvision.utils</span><span class="w"> </span><span class="kn">import</span> <span class="n">make_grid</span>

<span class="c1"># Matplotlib for plotting</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">matplotlib</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">mpl</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">matplotlib.pyplot</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">plt</span>
<span class="o">%</span><span class="k">matplotlib</span> inline

<span class="c1"># SciPy for statistical functions</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">scipy</span><span class="w"> </span><span class="kn">import</span> <span class="n">stats</span>

<span class="c1"># Scikit-Learn for machine learning utilities</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">sklearn.decomposition</span><span class="w"> </span><span class="kn">import</span> <span class="n">PCA</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">sklearn</span><span class="w"> </span><span class="kn">import</span> <span class="n">manifold</span>

<span class="c1"># RSA toolbox specific imports</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">rsatoolbox</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">rsatoolbox.data</span><span class="w"> </span><span class="kn">import</span> <span class="n">Dataset</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">rsatoolbox.rdm.calc</span><span class="w"> </span><span class="kn">import</span> <span class="n">calc_rdm</span>

<span class="k">class</span><span class="w"> </span><span class="nc">Net</span><span class="p">(</span><span class="n">nn</span><span class="o">.</span><span class="n">Module</span><span class="p">):</span>
<span class="w">    </span><span class="sd">"""</span>
<span class="sd">    A neural network model for image classification, consisting of two convolutional layers,</span>
<span class="sd">    followed by two fully connected layers with dropout regularization.</span>

<span class="sd">    Methods:</span>
<span class="sd">    - forward(input): Defines the forward pass of the network.</span>
<span class="sd">    """</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">"""</span>
<span class="sd">        Initializes the network layers.</span>

<span class="sd">        Layers:</span>
<span class="sd">        - conv1: First convolutional layer with 1 input channel, 32 output channels, and a 3x3 kernel.</span>
<span class="sd">        - conv2: Second convolutional layer with 32 input channels, 64 output channels, and a 3x3 kernel.</span>
<span class="sd">        - dropout1: Dropout layer with a dropout probability of 0.25.</span>
<span class="sd">        - dropout2: Dropout layer with a dropout probability of 0.5.</span>
<span class="sd">        - fc1: First fully connected layer with 9216 input features and 128 output features.</span>
<span class="sd">        - fc2: Second fully connected layer with 128 input features and 10 output features.</span>
<span class="sd">        """</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">Net</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">conv1</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Conv2d</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">32</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">conv2</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Conv2d</span><span class="p">(</span><span class="mi">32</span><span class="p">,</span> <span class="mi">64</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dropout1</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Dropout</span><span class="p">(</span><span class="mf">0.25</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dropout2</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Dropout</span><span class="p">(</span><span class="mf">0.5</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">fc1</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Linear</span><span class="p">(</span><span class="mi">9216</span><span class="p">,</span> <span class="mi">128</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">fc2</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Linear</span><span class="p">(</span><span class="mi">128</span><span class="p">,</span> <span class="mi">10</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">forward</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="nb">input</span><span class="p">):</span>
<span class="w">        </span><span class="sd">"""</span>
<span class="sd">        Defines the forward pass of the network.</span>

<span class="sd">        Inputs:</span>
<span class="sd">        - input (torch.Tensor): Input tensor of shape (batch_size, 1, height, width).</span>

<span class="sd">        Outputs:</span>
<span class="sd">        - output (torch.Tensor): Output tensor of shape (batch_size, 10) representing the class probabilities for each input sample.</span>
<span class="sd">        """</span>
        <span class="n">x</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">conv1</span><span class="p">(</span><span class="nb">input</span><span class="p">)</span>
        <span class="n">x</span> <span class="o">=</span> <span class="n">F</span><span class="o">.</span><span class="n">relu</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
        <span class="n">x</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">conv2</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
        <span class="n">x</span> <span class="o">=</span> <span class="n">F</span><span class="o">.</span><span class="n">relu</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
        <span class="n">x</span> <span class="o">=</span> <span class="n">F</span><span class="o">.</span><span class="n">max_pool2d</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
        <span class="n">x</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dropout1</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
        <span class="n">x</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">flatten</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
        <span class="n">x</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">fc1</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
        <span class="n">x</span> <span class="o">=</span> <span class="n">F</span><span class="o">.</span><span class="n">relu</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
        <span class="n">x</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dropout2</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
        <span class="n">x</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">fc2</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
        <span class="n">output</span> <span class="o">=</span> <span class="n">F</span><span class="o">.</span><span class="n">softmax</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">dim</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">output</span>

<span class="k">class</span><span class="w"> </span><span class="nc">recurrent_Net</span><span class="p">(</span><span class="n">nn</span><span class="o">.</span><span class="n">Module</span><span class="p">):</span>
<span class="w">    </span><span class="sd">"""</span>
<span class="sd">    A recurrent neural network model for image classification, consisting of two convolutional layers</span>
<span class="sd">    with recurrent connections and a readout layer.</span>

<span class="sd">    Methods:</span>
<span class="sd">    - __init__(time_steps=5): Initializes the network layers and sets the number of time steps for recurrence.</span>
<span class="sd">    - forward(input): Defines the forward pass of the network.</span>
<span class="sd">    """</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">time_steps</span><span class="o">=</span><span class="mi">5</span><span class="p">):</span>
<span class="w">        </span><span class="sd">"""</span>
<span class="sd">        Initializes the network layers and sets the number of time steps for recurrence.</span>

<span class="sd">        Layers:</span>
<span class="sd">        - conv1: First convolutional layer with 1 input channel, 16 output channels, and a 3x3 kernel with a stride of 3.</span>
<span class="sd">        - conv2: Second convolutional layer with 16 input channels, 16 output channels, and a 3x3 kernel with padding of 1.</span>
<span class="sd">        - readout: A sequential layer containing:</span>
<span class="sd">            - dropout: Dropout layer with a dropout probability of 0.25.</span>
<span class="sd">            - avgpool: Adaptive average pooling layer to reduce spatial dimensions to 1x1.</span>
<span class="sd">            - flatten: Flatten layer to convert the 2D pooled output to 1D.</span>
<span class="sd">            - linear: Fully connected layer with 16 input features and 10 output features.</span>
<span class="sd">        - time_steps (int): Number of time steps for the recurrent connection.</span>
<span class="sd">        """</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">recurrent_Net</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">conv1</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Conv2d</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">16</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">conv2</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Conv2d</span><span class="p">(</span><span class="mi">16</span><span class="p">,</span> <span class="mi">16</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">padding</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">readout</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Sequential</span><span class="p">(</span><span class="n">OrderedDict</span><span class="p">([</span>
            <span class="p">(</span><span class="s1">'dropout'</span><span class="p">,</span> <span class="n">nn</span><span class="o">.</span><span class="n">Dropout</span><span class="p">(</span><span class="mf">0.25</span><span class="p">)),</span>
            <span class="p">(</span><span class="s1">'avgpool'</span><span class="p">,</span> <span class="n">nn</span><span class="o">.</span><span class="n">AdaptiveAvgPool2d</span><span class="p">(</span><span class="mi">1</span><span class="p">)),</span>
            <span class="p">(</span><span class="s1">'flatten'</span><span class="p">,</span> <span class="n">nn</span><span class="o">.</span><span class="n">Flatten</span><span class="p">()),</span>
            <span class="p">(</span><span class="s1">'linear'</span><span class="p">,</span> <span class="n">nn</span><span class="o">.</span><span class="n">Linear</span><span class="p">(</span><span class="mi">16</span><span class="p">,</span> <span class="mi">10</span><span class="p">))</span>
        <span class="p">]))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">time_steps</span> <span class="o">=</span> <span class="n">time_steps</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">forward</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="nb">input</span><span class="p">):</span>
<span class="w">        </span><span class="sd">"""</span>
<span class="sd">        Defines the forward pass of the network.</span>

<span class="sd">        Inputs:</span>
<span class="sd">        - input (torch.Tensor): Input tensor of shape (batch_size, 1, height, width).</span>

<span class="sd">        Outputs:</span>
<span class="sd">        - output (torch.Tensor): Output tensor of shape (batch_size, 10) representing the class probabilities for each input sample.</span>
<span class="sd">        """</span>
        <span class="nb">input</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">conv1</span><span class="p">(</span><span class="nb">input</span><span class="p">)</span>
        <span class="n">x</span> <span class="o">=</span> <span class="nb">input</span>
        <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">time_steps</span><span class="p">):</span>
            <span class="n">x</span> <span class="o">=</span> <span class="nb">input</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">conv2</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
            <span class="n">x</span> <span class="o">=</span> <span class="n">F</span><span class="o">.</span><span class="n">relu</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>

        <span class="n">x</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">readout</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
        <span class="n">output</span> <span class="o">=</span> <span class="n">F</span><span class="o">.</span><span class="n">softmax</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">dim</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">output</span>


<span class="k">def</span><span class="w"> </span><span class="nf">train_one_epoch</span><span class="p">(</span><span class="n">args</span><span class="p">,</span> <span class="n">model</span><span class="p">,</span> <span class="n">device</span><span class="p">,</span> <span class="n">train_loader</span><span class="p">,</span> <span class="n">optimizer</span><span class="p">,</span> <span class="n">epoch</span><span class="p">):</span>
<span class="w">    </span><span class="sd">"""</span>
<span class="sd">    Trains the model for one epoch.</span>

<span class="sd">    Inputs:</span>
<span class="sd">    - args (Namespace): Arguments for training configuration.</span>
<span class="sd">    - model (torch.nn.Module): The model to be trained.</span>
<span class="sd">    - device (torch.device): The device to use for training (CPU/GPU).</span>
<span class="sd">    - train_loader (torch.utils.data.DataLoader): DataLoader for the training data.</span>
<span class="sd">    - optimizer (torch.optim.Optimizer): Optimizer for updating the model parameters.</span>
<span class="sd">    - epoch (int): The current epoch number.</span>
<span class="sd">    """</span>
    <span class="n">model</span><span class="o">.</span><span class="n">train</span><span class="p">()</span>
    <span class="k">for</span> <span class="n">batch_idx</span><span class="p">,</span> <span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">target</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">train_loader</span><span class="p">):</span>
        <span class="n">data</span><span class="p">,</span> <span class="n">target</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">device</span><span class="p">),</span> <span class="n">target</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">device</span><span class="p">)</span>
        <span class="n">optimizer</span><span class="o">.</span><span class="n">zero_grad</span><span class="p">()</span>
        <span class="n">output</span> <span class="o">=</span> <span class="n">model</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
        <span class="n">output</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">output</span><span class="p">)</span>  <span class="c1"># to make it a log_softmax</span>
        <span class="n">loss</span> <span class="o">=</span> <span class="n">F</span><span class="o">.</span><span class="n">nll_loss</span><span class="p">(</span><span class="n">output</span><span class="p">,</span> <span class="n">target</span><span class="p">)</span>
        <span class="n">loss</span><span class="o">.</span><span class="n">backward</span><span class="p">()</span>
        <span class="n">optimizer</span><span class="o">.</span><span class="n">step</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">batch_idx</span> <span class="o">%</span> <span class="n">args</span><span class="o">.</span><span class="n">log_interval</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">'Train Epoch: </span><span class="si">{}</span><span class="s1"> [</span><span class="si">{}</span><span class="s1">/</span><span class="si">{}</span><span class="s1"> (</span><span class="si">{:.0f}</span><span class="s1">%)]</span><span class="se">\t</span><span class="s1">Loss: </span><span class="si">{:.6f}</span><span class="s1">'</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                <span class="n">epoch</span><span class="p">,</span> <span class="n">batch_idx</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">data</span><span class="p">),</span> <span class="nb">len</span><span class="p">(</span><span class="n">train_loader</span><span class="o">.</span><span class="n">dataset</span><span class="p">),</span>
                <span class="mf">100.</span> <span class="o">*</span> <span class="n">batch_idx</span> <span class="o">/</span> <span class="nb">len</span><span class="p">(</span><span class="n">train_loader</span><span class="p">),</span> <span class="n">loss</span><span class="o">.</span><span class="n">item</span><span class="p">()))</span>
            <span class="k">if</span> <span class="n">args</span><span class="o">.</span><span class="n">dry_run</span><span class="p">:</span>
                <span class="k">break</span>

<span class="k">def</span><span class="w"> </span><span class="nf">test</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">device</span><span class="p">,</span> <span class="n">test_loader</span><span class="p">,</span> <span class="n">return_features</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
<span class="w">    </span><span class="sd">"""</span>
<span class="sd">    Evaluates the model on the test dataset.</span>

<span class="sd">    Inputs:</span>
<span class="sd">    - model (torch.nn.Module): The model to be evaluated.</span>
<span class="sd">    - device (torch.device): The device to use for evaluation (CPU/GPU).</span>
<span class="sd">    - test_loader (torch.utils.data.DataLoader): DataLoader for the test data.</span>
<span class="sd">    - return_features (bool): If True, returns the features from the model. Default is False.</span>
<span class="sd">    """</span>
    <span class="n">model</span><span class="o">.</span><span class="n">eval</span><span class="p">()</span>
    <span class="n">test_loss</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">correct</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">with</span> <span class="n">torch</span><span class="o">.</span><span class="n">no_grad</span><span class="p">():</span>
        <span class="k">for</span> <span class="n">data</span><span class="p">,</span> <span class="n">target</span> <span class="ow">in</span> <span class="n">test_loader</span><span class="p">:</span>
            <span class="n">data</span><span class="p">,</span> <span class="n">target</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">device</span><span class="p">),</span> <span class="n">target</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">device</span><span class="p">)</span>
            <span class="n">output</span> <span class="o">=</span> <span class="n">model</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
            <span class="n">output</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">output</span><span class="p">)</span>
            <span class="n">test_loss</span> <span class="o">+=</span> <span class="n">F</span><span class="o">.</span><span class="n">nll_loss</span><span class="p">(</span><span class="n">output</span><span class="p">,</span> <span class="n">target</span><span class="p">,</span> <span class="n">reduction</span><span class="o">=</span><span class="s1">'sum'</span><span class="p">)</span><span class="o">.</span><span class="n">item</span><span class="p">()</span>  <span class="c1"># sum up batch loss</span>
            <span class="n">pred</span> <span class="o">=</span> <span class="n">output</span><span class="o">.</span><span class="n">argmax</span><span class="p">(</span><span class="n">dim</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">keepdim</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>  <span class="c1"># get the index of the max log-probability</span>
            <span class="n">correct</span> <span class="o">+=</span> <span class="n">pred</span><span class="o">.</span><span class="n">eq</span><span class="p">(</span><span class="n">target</span><span class="o">.</span><span class="n">view_as</span><span class="p">(</span><span class="n">pred</span><span class="p">))</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span><span class="o">.</span><span class="n">item</span><span class="p">()</span>

    <span class="n">test_loss</span> <span class="o">/=</span> <span class="nb">len</span><span class="p">(</span><span class="n">test_loader</span><span class="o">.</span><span class="n">dataset</span><span class="p">)</span>

    <span class="nb">print</span><span class="p">(</span><span class="s1">'</span><span class="se">\n</span><span class="s1">Test set: Average loss: </span><span class="si">{:.4f}</span><span class="s1">, Accuracy: </span><span class="si">{}</span><span class="s1">/</span><span class="si">{}</span><span class="s1"> (</span><span class="si">{:.0f}</span><span class="s1">%)</span><span class="se">\n</span><span class="s1">'</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
        <span class="n">test_loss</span><span class="p">,</span> <span class="n">correct</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">test_loader</span><span class="o">.</span><span class="n">dataset</span><span class="p">),</span>
        <span class="mf">100.</span> <span class="o">*</span> <span class="n">correct</span> <span class="o">/</span> <span class="nb">len</span><span class="p">(</span><span class="n">test_loader</span><span class="o">.</span><span class="n">dataset</span><span class="p">)))</span>

<span class="k">def</span><span class="w"> </span><span class="nf">build_args</span><span class="p">():</span>
<span class="w">    </span><span class="sd">"""</span>
<span class="sd">    Builds and parses command-line arguments for training.</span>
<span class="sd">    """</span>
    <span class="n">parser</span> <span class="o">=</span> <span class="n">argparse</span><span class="o">.</span><span class="n">ArgumentParser</span><span class="p">(</span><span class="n">description</span><span class="o">=</span><span class="s1">'PyTorch MNIST Example'</span><span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">'--batch-size'</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">int</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="mi">64</span><span class="p">,</span> <span class="n">metavar</span><span class="o">=</span><span class="s1">'N'</span><span class="p">,</span>
                        <span class="n">help</span><span class="o">=</span><span class="s1">'input batch size for training (default: 64)'</span><span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">'--test-batch-size'</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">int</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="mi">1000</span><span class="p">,</span> <span class="n">metavar</span><span class="o">=</span><span class="s1">'N'</span><span class="p">,</span>
                        <span class="n">help</span><span class="o">=</span><span class="s1">'input batch size for testing (default: 1000)'</span><span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">'--epochs'</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">int</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">metavar</span><span class="o">=</span><span class="s1">'N'</span><span class="p">,</span>
                        <span class="n">help</span><span class="o">=</span><span class="s1">'number of epochs to train (default: 14)'</span><span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">'--lr'</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">float</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="mf">1.0</span><span class="p">,</span> <span class="n">metavar</span><span class="o">=</span><span class="s1">'LR'</span><span class="p">,</span>
                        <span class="n">help</span><span class="o">=</span><span class="s1">'learning rate (default: 1.0)'</span><span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">'--gamma'</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">float</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="mf">0.7</span><span class="p">,</span> <span class="n">metavar</span><span class="o">=</span><span class="s1">'M'</span><span class="p">,</span>
                        <span class="n">help</span><span class="o">=</span><span class="s1">'Learning rate step gamma (default: 0.7)'</span><span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">'--no-cuda'</span><span class="p">,</span> <span class="n">action</span><span class="o">=</span><span class="s1">'store_true'</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                        <span class="n">help</span><span class="o">=</span><span class="s1">'disables CUDA training'</span><span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">'--no-mps'</span><span class="p">,</span> <span class="n">action</span><span class="o">=</span><span class="s1">'store_true'</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                        <span class="n">help</span><span class="o">=</span><span class="s1">'disables macOS GPU training'</span><span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">'--dry-run'</span><span class="p">,</span> <span class="n">action</span><span class="o">=</span><span class="s1">'store_true'</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                        <span class="n">help</span><span class="o">=</span><span class="s1">'quickly check a single pass'</span><span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">'--seed'</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">int</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">metavar</span><span class="o">=</span><span class="s1">'S'</span><span class="p">,</span>
                        <span class="n">help</span><span class="o">=</span><span class="s1">'random seed (default: 1)'</span><span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">'--log-interval'</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">int</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="mi">50</span><span class="p">,</span> <span class="n">metavar</span><span class="o">=</span><span class="s1">'N'</span><span class="p">,</span>
                        <span class="n">help</span><span class="o">=</span><span class="s1">'how many batches to wait before logging training status'</span><span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">'--save-model'</span><span class="p">,</span> <span class="n">action</span><span class="o">=</span><span class="s1">'store_true'</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                        <span class="n">help</span><span class="o">=</span><span class="s1">'For Saving the current Model'</span><span class="p">)</span>
    <span class="n">args</span> <span class="o">=</span> <span class="n">parser</span><span class="o">.</span><span class="n">parse_args</span><span class="p">(</span><span class="s1">''</span><span class="p">)</span>

    <span class="n">use_cuda</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">cuda</span><span class="o">.</span><span class="n">is_available</span><span class="p">()</span> <span class="c1">#not args.no_cuda and</span>

    <span class="k">if</span> <span class="n">use_cuda</span><span class="p">:</span>
        <span class="n">device</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">device</span><span class="p">(</span><span class="s2">"cuda"</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">device</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">device</span><span class="p">(</span><span class="s2">"cpu"</span><span class="p">)</span>

    <span class="n">args</span><span class="o">.</span><span class="n">use_cuda</span> <span class="o">=</span> <span class="n">use_cuda</span>
    <span class="n">args</span><span class="o">.</span><span class="n">device</span> <span class="o">=</span> <span class="n">device</span>
    <span class="k">return</span> <span class="n">args</span>

<span class="k">def</span><span class="w"> </span><span class="nf">fetch_dataloaders</span><span class="p">(</span><span class="n">args</span><span class="p">):</span>
<span class="w">    </span><span class="sd">"""</span>
<span class="sd">    Fetches the data loaders for training and testing datasets.</span>

<span class="sd">    Inputs:</span>
<span class="sd">    - args (Namespace): Parsed arguments with training configuration.</span>

<span class="sd">    Outputs:</span>
<span class="sd">    - train_loader (torch.utils.data.DataLoader): DataLoader for the training data.</span>
<span class="sd">    - test_loader (torch.utils.data.DataLoader): DataLoader for the test data.</span>
<span class="sd">    """</span>
    <span class="n">train_kwargs</span> <span class="o">=</span> <span class="p">{</span><span class="s1">'batch_size'</span><span class="p">:</span> <span class="n">args</span><span class="o">.</span><span class="n">batch_size</span><span class="p">}</span>
    <span class="n">test_kwargs</span> <span class="o">=</span> <span class="p">{</span><span class="s1">'batch_size'</span><span class="p">:</span> <span class="n">args</span><span class="o">.</span><span class="n">test_batch_size</span><span class="p">}</span>
    <span class="k">if</span> <span class="n">args</span><span class="o">.</span><span class="n">use_cuda</span><span class="p">:</span>
        <span class="n">cuda_kwargs</span> <span class="o">=</span> <span class="p">{</span><span class="s1">'num_workers'</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span>
                       <span class="s1">'pin_memory'</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span>
                       <span class="s1">'shuffle'</span><span class="p">:</span> <span class="kc">True</span><span class="p">}</span>
        <span class="n">train_kwargs</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">cuda_kwargs</span><span class="p">)</span>
        <span class="n">test_kwargs</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">cuda_kwargs</span><span class="p">)</span>

    <span class="n">transform</span><span class="o">=</span><span class="n">transforms</span><span class="o">.</span><span class="n">Compose</span><span class="p">([</span>
        <span class="n">transforms</span><span class="o">.</span><span class="n">ToTensor</span><span class="p">(),</span>
        <span class="n">transforms</span><span class="o">.</span><span class="n">Normalize</span><span class="p">((</span><span class="mf">0.1307</span><span class="p">,),</span> <span class="p">(</span><span class="mf">0.3081</span><span class="p">,))</span>
        <span class="p">])</span>
    <span class="k">with</span> <span class="n">contextlib</span><span class="o">.</span><span class="n">redirect_stdout</span><span class="p">(</span><span class="n">io</span><span class="o">.</span><span class="n">StringIO</span><span class="p">()):</span> <span class="c1">#to suppress output</span>
        <span class="n">dataset1</span> <span class="o">=</span> <span class="n">datasets</span><span class="o">.</span><span class="n">MNIST</span><span class="p">(</span><span class="s1">'../data'</span><span class="p">,</span> <span class="n">train</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">download</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                       <span class="n">transform</span><span class="o">=</span><span class="n">transform</span><span class="p">)</span>
        <span class="n">dataset2</span> <span class="o">=</span> <span class="n">datasets</span><span class="o">.</span><span class="n">MNIST</span><span class="p">(</span><span class="s1">'../data'</span><span class="p">,</span> <span class="n">train</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                       <span class="n">transform</span><span class="o">=</span><span class="n">transform</span><span class="p">)</span>
        <span class="n">train_loader</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">utils</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">DataLoader</span><span class="p">(</span><span class="n">dataset1</span><span class="p">,</span> <span class="o">**</span><span class="n">train_kwargs</span><span class="p">)</span>
        <span class="n">test_loader</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">utils</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">DataLoader</span><span class="p">(</span><span class="n">dataset2</span><span class="p">,</span> <span class="o">**</span><span class="n">test_kwargs</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">train_loader</span><span class="p">,</span> <span class="n">test_loader</span>

<span class="k">def</span><span class="w"> </span><span class="nf">train_model</span><span class="p">(</span><span class="n">args</span><span class="p">,</span> <span class="n">model</span><span class="p">,</span> <span class="n">optimizer</span><span class="p">):</span>
<span class="w">    </span><span class="sd">"""</span>
<span class="sd">    Trains the model using the specified arguments and optimizer.</span>

<span class="sd">    Inputs:</span>
<span class="sd">    - args (Namespace): Parsed arguments with training configuration.</span>
<span class="sd">    - model (torch.nn.Module): The model to be trained.</span>
<span class="sd">    - optimizer (torch.optim.Optimizer): Optimizer for updating the model parameters.</span>

<span class="sd">    Outputs:</span>
<span class="sd">    - None: The function trains the model and optionally saves it.</span>
<span class="sd">    """</span>
    <span class="n">scheduler</span> <span class="o">=</span> <span class="n">StepLR</span><span class="p">(</span><span class="n">optimizer</span><span class="p">,</span> <span class="n">step_size</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">gamma</span><span class="o">=</span><span class="n">args</span><span class="o">.</span><span class="n">gamma</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">epoch</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">args</span><span class="o">.</span><span class="n">epochs</span> <span class="o">+</span> <span class="mi">1</span><span class="p">):</span>
        <span class="n">train_one_epoch</span><span class="p">(</span><span class="n">args</span><span class="p">,</span> <span class="n">model</span><span class="p">,</span> <span class="n">args</span><span class="o">.</span><span class="n">device</span><span class="p">,</span> <span class="n">train_loader</span><span class="p">,</span> <span class="n">optimizer</span><span class="p">,</span> <span class="n">epoch</span><span class="p">)</span>
        <span class="n">test</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">args</span><span class="o">.</span><span class="n">device</span><span class="p">,</span> <span class="n">test_loader</span><span class="p">)</span>
        <span class="n">scheduler</span><span class="o">.</span><span class="n">step</span><span class="p">()</span>

    <span class="k">if</span> <span class="n">args</span><span class="o">.</span><span class="n">save_model</span><span class="p">:</span>
        <span class="n">torch</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">state_dict</span><span class="p">(),</span> <span class="s2">"mnist_cnn.pt"</span><span class="p">)</span>


<span class="k">def</span><span class="w"> </span><span class="nf">calc_rdms</span><span class="p">(</span><span class="n">model_features</span><span class="p">,</span> <span class="n">method</span><span class="o">=</span><span class="s1">'correlation'</span><span class="p">):</span>
<span class="w">    </span><span class="sd">"""</span>
<span class="sd">    Calculates representational dissimilarity matrices (RDMs) for model features.</span>

<span class="sd">    Inputs:</span>
<span class="sd">    - model_features (dict): A dictionary where keys are layer names and values are features of the layers.</span>
<span class="sd">    - method (str): The method to calculate RDMs, e.g., 'correlation'. Default is 'correlation'.</span>

<span class="sd">    Outputs:</span>
<span class="sd">    - rdms (pyrsa.rdm.RDMs): RDMs object containing dissimilarity matrices.</span>
<span class="sd">    - rdms_dict (dict): A dictionary with layer names as keys and their corresponding RDMs as values.</span>
<span class="sd">    """</span>
    <span class="n">ds_list</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">l</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">model_features</span><span class="p">)):</span>
        <span class="n">layer</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">model_features</span><span class="o">.</span><span class="n">keys</span><span class="p">())[</span><span class="n">l</span><span class="p">]</span>
        <span class="n">feats</span> <span class="o">=</span> <span class="n">model_features</span><span class="p">[</span><span class="n">layer</span><span class="p">]</span>

        <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">feats</span><span class="p">)</span> <span class="ow">is</span> <span class="nb">list</span><span class="p">:</span>
            <span class="n">feats</span> <span class="o">=</span> <span class="n">feats</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>

        <span class="k">if</span> <span class="n">args</span><span class="o">.</span><span class="n">use_cuda</span><span class="p">:</span>
            <span class="n">feats</span> <span class="o">=</span> <span class="n">feats</span><span class="o">.</span><span class="n">cpu</span><span class="p">()</span>

        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">feats</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">2</span><span class="p">:</span>
            <span class="n">feats</span> <span class="o">=</span> <span class="n">feats</span><span class="o">.</span><span class="n">flatten</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>

        <span class="n">feats</span> <span class="o">=</span> <span class="n">feats</span><span class="o">.</span><span class="n">detach</span><span class="p">()</span><span class="o">.</span><span class="n">numpy</span><span class="p">()</span>
        <span class="n">ds</span> <span class="o">=</span> <span class="n">Dataset</span><span class="p">(</span><span class="n">feats</span><span class="p">,</span> <span class="n">descriptors</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="n">layer</span><span class="o">=</span><span class="n">layer</span><span class="p">))</span>
        <span class="n">ds_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ds</span><span class="p">)</span>

    <span class="n">rdms</span> <span class="o">=</span> <span class="n">calc_rdm</span><span class="p">(</span><span class="n">ds_list</span><span class="p">,</span> <span class="n">method</span><span class="o">=</span><span class="n">method</span><span class="p">)</span>
    <span class="n">rdms_dict</span> <span class="o">=</span> <span class="p">{</span><span class="nb">list</span><span class="p">(</span><span class="n">model_features</span><span class="o">.</span><span class="n">keys</span><span class="p">())[</span><span class="n">i</span><span class="p">]:</span> <span class="n">rdms</span><span class="o">.</span><span class="n">get_matrices</span><span class="p">()[</span><span class="n">i</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">model_features</span><span class="p">))}</span>

    <span class="k">return</span> <span class="n">rdms</span><span class="p">,</span> <span class="n">rdms_dict</span>

<span class="k">def</span><span class="w"> </span><span class="nf">fgsm_attack</span><span class="p">(</span><span class="n">image</span><span class="p">,</span> <span class="n">epsilon</span><span class="p">,</span> <span class="n">data_grad</span><span class="p">):</span>
<span class="w">    </span><span class="sd">"""</span>
<span class="sd">    Performs FGSM attack on an image.</span>

<span class="sd">    Inputs:</span>
<span class="sd">    - image (torch.Tensor): Original image.</span>
<span class="sd">    - epsilon (float): Perturbation magnitude.</span>
<span class="sd">    - data_grad (torch.Tensor): Gradient of the data.</span>

<span class="sd">    Outputs:</span>
<span class="sd">    - perturbed_image (torch.Tensor): Perturbed image after FGSM attack.</span>
<span class="sd">    """</span>
    <span class="n">sign_data_grad</span> <span class="o">=</span> <span class="n">data_grad</span><span class="o">.</span><span class="n">sign</span><span class="p">()</span>
    <span class="n">perturbed_image</span> <span class="o">=</span> <span class="n">image</span> <span class="o">+</span> <span class="n">epsilon</span> <span class="o">*</span> <span class="n">sign_data_grad</span>
    <span class="n">perturbed_image</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">clamp</span><span class="p">(</span><span class="n">perturbed_image</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">perturbed_image</span>

<span class="k">def</span><span class="w"> </span><span class="nf">denorm</span><span class="p">(</span><span class="n">batch</span><span class="p">,</span> <span class="n">mean</span><span class="o">=</span><span class="p">[</span><span class="mf">0.1307</span><span class="p">],</span> <span class="n">std</span><span class="o">=</span><span class="p">[</span><span class="mf">0.3081</span><span class="p">]):</span>
<span class="w">    </span><span class="sd">"""</span>
<span class="sd">    Converts a batch of normalized tensors to their original scale.</span>

<span class="sd">    Inputs:</span>
<span class="sd">    - batch (torch.Tensor): Batch of normalized tensors.</span>
<span class="sd">    - mean (torch.Tensor or list): Mean used for normalization.</span>
<span class="sd">    - std (torch.Tensor or list): Standard deviation used for normalization.</span>

<span class="sd">    Outputs:</span>
<span class="sd">    - torch.Tensor: Batch of tensors without normalization applied to them.</span>
<span class="sd">    """</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">mean</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
        <span class="n">mean</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">(</span><span class="n">mean</span><span class="p">)</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">batch</span><span class="o">.</span><span class="n">device</span><span class="p">)</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">std</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
        <span class="n">std</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">(</span><span class="n">std</span><span class="p">)</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">batch</span><span class="o">.</span><span class="n">device</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">batch</span> <span class="o">*</span> <span class="n">std</span><span class="o">.</span><span class="n">view</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span> <span class="o">+</span> <span class="n">mean</span><span class="o">.</span><span class="n">view</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>

<span class="k">def</span><span class="w"> </span><span class="nf">generate_adversarial</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">imgs</span><span class="p">,</span> <span class="n">targets</span><span class="p">,</span> <span class="n">epsilon</span><span class="p">):</span>
<span class="w">    </span><span class="sd">"""</span>
<span class="sd">    Generates adversarial examples using FGSM attack.</span>

<span class="sd">    Inputs:</span>
<span class="sd">    - model (torch.nn.Module): The model to attack.</span>
<span class="sd">    - imgs (torch.Tensor): Batch of images.</span>
<span class="sd">    - targets (torch.Tensor): Batch of target labels.</span>
<span class="sd">    - epsilon (float): Perturbation magnitude.</span>

<span class="sd">    Outputs:</span>
<span class="sd">    - adv_imgs (torch.Tensor): Batch of adversarial images.</span>
<span class="sd">    """</span>
    <span class="n">adv_imgs</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="k">for</span> <span class="n">img</span><span class="p">,</span> <span class="n">target</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">imgs</span><span class="p">,</span> <span class="n">targets</span><span class="p">):</span>
        <span class="n">img</span> <span class="o">=</span> <span class="n">img</span><span class="o">.</span><span class="n">unsqueeze</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
        <span class="n">target</span> <span class="o">=</span> <span class="n">target</span><span class="o">.</span><span class="n">unsqueeze</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
        <span class="n">img</span><span class="o">.</span><span class="n">requires_grad</span> <span class="o">=</span> <span class="kc">True</span>

        <span class="n">output</span> <span class="o">=</span> <span class="n">model</span><span class="p">(</span><span class="n">img</span><span class="p">)</span>
        <span class="n">output</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">output</span><span class="p">)</span>
        <span class="n">loss</span> <span class="o">=</span> <span class="n">F</span><span class="o">.</span><span class="n">nll_loss</span><span class="p">(</span><span class="n">output</span><span class="p">,</span> <span class="n">target</span><span class="p">)</span>

        <span class="n">model</span><span class="o">.</span><span class="n">zero_grad</span><span class="p">()</span>
        <span class="n">loss</span><span class="o">.</span><span class="n">backward</span><span class="p">()</span>

        <span class="n">data_grad</span> <span class="o">=</span> <span class="n">img</span><span class="o">.</span><span class="n">grad</span><span class="o">.</span><span class="n">data</span>
        <span class="n">data_denorm</span> <span class="o">=</span> <span class="n">denorm</span><span class="p">(</span><span class="n">img</span><span class="p">)</span>
        <span class="n">perturbed_data</span> <span class="o">=</span> <span class="n">fgsm_attack</span><span class="p">(</span><span class="n">data_denorm</span><span class="p">,</span> <span class="n">epsilon</span><span class="p">,</span> <span class="n">data_grad</span><span class="p">)</span>
        <span class="n">perturbed_data_normalized</span> <span class="o">=</span> <span class="n">transforms</span><span class="o">.</span><span class="n">Normalize</span><span class="p">((</span><span class="mf">0.1307</span><span class="p">,),</span> <span class="p">(</span><span class="mf">0.3081</span><span class="p">,))(</span><span class="n">perturbed_data</span><span class="p">)</span>

        <span class="n">adv_imgs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">perturbed_data_normalized</span><span class="o">.</span><span class="n">detach</span><span class="p">())</span>

    <span class="k">return</span> <span class="n">torch</span><span class="o">.</span><span class="n">cat</span><span class="p">(</span><span class="n">adv_imgs</span><span class="p">)</span>

<span class="k">def</span><span class="w"> </span><span class="nf">test_adversarial</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">imgs</span><span class="p">,</span> <span class="n">targets</span><span class="p">):</span>
<span class="w">    </span><span class="sd">"""</span>
<span class="sd">    Tests the model on adversarial examples and prints the accuracy.</span>

<span class="sd">    Inputs:</span>
<span class="sd">    - model (torch.nn.Module): The model to be tested.</span>
<span class="sd">    - imgs (torch.Tensor): Batch of adversarial images.</span>
<span class="sd">    - targets (torch.Tensor): Batch of target labels.</span>
<span class="sd">    """</span>
    <span class="n">correct</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">output</span> <span class="o">=</span> <span class="n">model</span><span class="p">(</span><span class="n">imgs</span><span class="p">)</span>
    <span class="n">output</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">output</span><span class="p">)</span>
    <span class="n">pred</span> <span class="o">=</span> <span class="n">output</span><span class="o">.</span><span class="n">argmax</span><span class="p">(</span><span class="n">dim</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">keepdim</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>  <span class="c1"># get the index of the max log-probability</span>
    <span class="n">correct</span> <span class="o">+=</span> <span class="n">pred</span><span class="o">.</span><span class="n">eq</span><span class="p">(</span><span class="n">targets</span><span class="o">.</span><span class="n">view_as</span><span class="p">(</span><span class="n">pred</span><span class="p">))</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span><span class="o">.</span><span class="n">item</span><span class="p">()</span>

    <span class="n">final_acc</span> <span class="o">=</span> <span class="n">correct</span> <span class="o">/</span> <span class="nb">float</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">imgs</span><span class="p">))</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"adversarial test accuracy = </span><span class="si">{</span><span class="n">correct</span><span class="si">}</span><span class="s2"> / </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">imgs</span><span class="p">)</span><span class="si">}</span><span class="s2"> = </span><span class="si">{</span><span class="n">final_acc</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>

<span class="k">def</span><span class="w"> </span><span class="nf">extract_features</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">imgs</span><span class="p">,</span> <span class="n">return_layers</span><span class="p">,</span> <span class="n">plot</span><span class="o">=</span><span class="s1">'none'</span><span class="p">):</span>
<span class="w">    </span><span class="sd">"""</span>
<span class="sd">    Extracts features from specified layers of the model.</span>

<span class="sd">    Inputs:</span>
<span class="sd">    - model (torch.nn.Module): The model from which to extract features.</span>
<span class="sd">    - imgs (torch.Tensor): Batch of input images.</span>
<span class="sd">    - return_layers (list): List of layer names from which to extract features.</span>
<span class="sd">    - plot (str): Option to plot the features. Default is 'none'.</span>

<span class="sd">    Outputs:</span>
<span class="sd">    - model_features (dict): A dictionary with layer names as keys and extracted features as values.</span>
<span class="sd">    """</span>
    <span class="k">if</span> <span class="n">return_layers</span> <span class="o">==</span> <span class="s1">'all'</span><span class="p">:</span>
        <span class="n">return_layers</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">get_graph_node_names</span><span class="p">(</span><span class="n">model</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">return_layers</span> <span class="o">==</span> <span class="s1">'layers'</span><span class="p">:</span>
        <span class="n">layers</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">get_graph_node_names</span><span class="p">(</span><span class="n">model</span><span class="p">)</span>
        <span class="n">return_layers</span> <span class="o">=</span> <span class="p">[</span><span class="n">l</span> <span class="k">for</span> <span class="n">l</span> <span class="ow">in</span> <span class="n">layers</span> <span class="k">if</span> <span class="s1">'input'</span> <span class="ow">in</span> <span class="n">l</span> <span class="ow">or</span> <span class="s1">'conv'</span> <span class="ow">in</span> <span class="n">l</span> <span class="ow">or</span> <span class="s1">'fc'</span> <span class="ow">in</span> <span class="n">l</span><span class="p">]</span>

    <span class="n">feature_extractor</span> <span class="o">=</span> <span class="n">create_feature_extractor</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">return_nodes</span><span class="o">=</span><span class="n">return_layers</span><span class="p">)</span>
    <span class="n">model_features</span> <span class="o">=</span> <span class="n">feature_extractor</span><span class="p">(</span><span class="n">imgs</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">model_features</span>
</pre></div>
</div>
</div>
</details>
</div>
</section>
<section id="plotting-functions-bonus">
<h2>Plotting functions (Bonus)<a class="headerlink" href="#plotting-functions-bonus" title="Permalink to this heading">#</a></h2>
<div class="cell tag_hide-input docutils container">
<details class="hide above-input">
<summary aria-label="Toggle hidden content">
<span class="collapsed">Show code cell source</span>
<span class="expanded">Hide code cell source</span>
</summary>
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># @title Plotting functions (Bonus)</span>

<span class="k">def</span><span class="w"> </span><span class="nf">sample_images</span><span class="p">(</span><span class="n">data_loader</span><span class="p">,</span> <span class="n">n</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span> <span class="n">plot</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
<span class="w">    </span><span class="sd">"""</span>
<span class="sd">    Samples a specified number of images from a data loader.</span>

<span class="sd">    Inputs:</span>
<span class="sd">    - data_loader (torch.utils.data.DataLoader): Data loader containing images and labels.</span>
<span class="sd">    - n (int): Number of images to sample per class.</span>
<span class="sd">    - plot (bool): Whether to plot the sampled images using matplotlib.</span>

<span class="sd">    Outputs:</span>
<span class="sd">    - imgs (torch.Tensor): Sampled images.</span>
<span class="sd">    - labels (torch.Tensor): Corresponding labels for the sampled images.</span>
<span class="sd">    """</span>

    <span class="k">with</span> <span class="n">plt</span><span class="o">.</span><span class="n">xkcd</span><span class="p">():</span>
        <span class="n">imgs</span><span class="p">,</span> <span class="n">targets</span> <span class="o">=</span> <span class="nb">next</span><span class="p">(</span><span class="nb">iter</span><span class="p">(</span><span class="n">data_loader</span><span class="p">))</span>

        <span class="n">imgs_o</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">labels</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">value</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">10</span><span class="p">):</span>
            <span class="n">cat_imgs</span> <span class="o">=</span> <span class="n">imgs</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">targets</span> <span class="o">==</span> <span class="n">value</span><span class="p">)][</span><span class="mi">0</span><span class="p">:</span><span class="n">n</span><span class="p">]</span>
            <span class="n">imgs_o</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">cat_imgs</span><span class="p">)</span>
            <span class="n">labels</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">value</span><span class="p">]</span><span class="o">*</span><span class="nb">len</span><span class="p">(</span><span class="n">cat_imgs</span><span class="p">))</span>

        <span class="n">imgs</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">cat</span><span class="p">(</span><span class="n">imgs_o</span><span class="p">,</span> <span class="n">dim</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="n">labels</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">(</span><span class="n">labels</span><span class="p">)</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span>

        <span class="k">if</span> <span class="n">plot</span><span class="p">:</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">moveaxis</span><span class="p">(</span><span class="n">make_grid</span><span class="p">(</span><span class="n">imgs</span><span class="p">,</span> <span class="n">nrow</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span> <span class="n">padding</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">normalize</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">pad_value</span><span class="o">=</span><span class="mi">0</span><span class="p">),</span> <span class="mi">0</span><span class="p">,</span><span class="o">-</span><span class="mi">1</span><span class="p">))</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">axis</span><span class="p">(</span><span class="s1">'off'</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">imgs</span><span class="p">,</span> <span class="n">labels</span>


<span class="k">def</span><span class="w"> </span><span class="nf">plot_rdms</span><span class="p">(</span><span class="n">model_rdms</span><span class="p">):</span>
<span class="w">    </span><span class="sd">"""</span>
<span class="sd">    Plots the Representational Dissimilarity Matrices (RDMs) for each layer of a model.</span>

<span class="sd">    Inputs:</span>
<span class="sd">    - model_rdms (dict): A dictionary where keys are layer names and values are the corresponding RDMs.</span>
<span class="sd">    """</span>

    <span class="k">with</span> <span class="n">plt</span><span class="o">.</span><span class="n">xkcd</span><span class="p">():</span>
        <span class="n">fig</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">8</span><span class="p">,</span> <span class="mi">4</span><span class="p">))</span>
        <span class="n">gs</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">add_gridspec</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">model_rdms</span><span class="p">))</span>
        <span class="n">fig</span><span class="o">.</span><span class="n">subplots_adjust</span><span class="p">(</span><span class="n">wspace</span><span class="o">=</span><span class="mf">0.2</span><span class="p">,</span> <span class="n">hspace</span><span class="o">=</span><span class="mf">0.2</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">l</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">model_rdms</span><span class="p">)):</span>

            <span class="n">layer</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">model_rdms</span><span class="o">.</span><span class="n">keys</span><span class="p">())[</span><span class="n">l</span><span class="p">]</span>
            <span class="n">rdm</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">squeeze</span><span class="p">(</span><span class="n">model_rdms</span><span class="p">[</span><span class="n">layer</span><span class="p">])</span>

            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">rdm</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">:</span>
                <span class="n">rdm</span> <span class="o">=</span> <span class="n">rdm</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span> <span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">rdm</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">])),</span> <span class="nb">int</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">rdm</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">])))</span> <span class="p">)</span>

            <span class="n">rdm</span> <span class="o">=</span> <span class="n">rdm</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">rdm</span><span class="p">)</span>

            <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplot</span><span class="p">(</span><span class="n">gs</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="n">l</span><span class="p">])</span>
            <span class="n">ax_</span> <span class="o">=</span> <span class="n">ax</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">rdm</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="s1">'magma_r'</span><span class="p">)</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="sa">f</span><span class="s1">'</span><span class="si">{</span><span class="n">layer</span><span class="si">}</span><span class="s1">'</span><span class="p">)</span>

        <span class="n">fig</span><span class="o">.</span><span class="n">subplots_adjust</span><span class="p">(</span><span class="n">right</span><span class="o">=</span><span class="mf">0.9</span><span class="p">)</span>
        <span class="n">cbar_ax</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">add_axes</span><span class="p">([</span><span class="mf">1.01</span><span class="p">,</span> <span class="mf">0.18</span><span class="p">,</span> <span class="mf">0.01</span><span class="p">,</span> <span class="mf">0.53</span><span class="p">])</span>
        <span class="n">cbar_ax</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="o">-</span><span class="mf">2.3</span><span class="p">,</span> <span class="mf">0.05</span><span class="p">,</span> <span class="s1">'Normalized euclidean distance'</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span> <span class="n">rotation</span><span class="o">=</span><span class="mi">90</span><span class="p">)</span>
        <span class="n">fig</span><span class="o">.</span><span class="n">colorbar</span><span class="p">(</span><span class="n">ax_</span><span class="p">,</span> <span class="n">cax</span><span class="o">=</span><span class="n">cbar_ax</span><span class="p">)</span>

        <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>

<span class="k">def</span><span class="w"> </span><span class="nf">rep_path</span><span class="p">(</span><span class="n">model_features</span><span class="p">,</span> <span class="n">model_colors</span><span class="p">,</span> <span class="n">labels</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">rdm_calc_method</span><span class="o">=</span><span class="s1">'euclidean'</span><span class="p">,</span> <span class="n">rdm_comp_method</span><span class="o">=</span><span class="s1">'cosine'</span><span class="p">):</span>
<span class="w">    </span><span class="sd">"""</span>
<span class="sd">    Represents paths of model features in a reduced-dimensional space.</span>

<span class="sd">    Inputs:</span>
<span class="sd">    - model_features (dict): Dictionary containing model features for each model.</span>
<span class="sd">    - model_colors (dict): Dictionary mapping model names to colors for visualization.</span>
<span class="sd">    - labels (array-like, optional): Array of labels corresponding to the model features.</span>
<span class="sd">    - rdm_calc_method (str, optional): Method for calculating RDMS ('euclidean' or 'correlation').</span>
<span class="sd">    - rdm_comp_method (str, optional): Method for comparing RDMS ('cosine' or 'corr').</span>
<span class="sd">    """</span>
    <span class="k">with</span> <span class="n">plt</span><span class="o">.</span><span class="n">xkcd</span><span class="p">():</span>
        <span class="n">path_len</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">path_colors</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">rdms_list</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">ax_ticks</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">tick_colors</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">model_names</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">model_features</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
        <span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">model_names</span><span class="p">)):</span>
            <span class="n">model_name</span> <span class="o">=</span> <span class="n">model_names</span><span class="p">[</span><span class="n">m</span><span class="p">]</span>
            <span class="n">features</span> <span class="o">=</span> <span class="n">model_features</span><span class="p">[</span><span class="n">model_name</span><span class="p">]</span>
            <span class="n">path_colors</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">model_colors</span><span class="p">[</span><span class="n">model_name</span><span class="p">])</span>
            <span class="n">path_len</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">features</span><span class="p">))</span>
            <span class="n">ax_ticks</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">features</span><span class="o">.</span><span class="n">keys</span><span class="p">()))</span>
            <span class="n">tick_colors</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">model_colors</span><span class="p">[</span><span class="n">model_name</span><span class="p">]]</span><span class="o">*</span><span class="nb">len</span><span class="p">(</span><span class="n">features</span><span class="p">))</span>
            <span class="n">rdms</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">calc_rdms</span><span class="p">(</span><span class="n">features</span><span class="p">,</span> <span class="n">method</span><span class="o">=</span><span class="n">rdm_calc_method</span><span class="p">)</span>
            <span class="n">rdms_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">rdms</span><span class="p">)</span>

        <span class="n">path_len</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">cumsum</span><span class="p">(</span><span class="n">path_len</span><span class="p">),</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">labels</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">rdms</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">calc_rdms</span><span class="p">({</span><span class="s1">'labels'</span> <span class="p">:</span> <span class="n">F</span><span class="o">.</span><span class="n">one_hot</span><span class="p">(</span><span class="n">labels</span><span class="p">)</span><span class="o">.</span><span class="n">float</span><span class="p">()</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">device</span><span class="p">)},</span> <span class="n">method</span><span class="o">=</span><span class="n">rdm_calc_method</span><span class="p">)</span>
            <span class="n">rdms_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">rdms</span><span class="p">)</span>
            <span class="n">ax_ticks</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="s1">'labels'</span><span class="p">])</span>
            <span class="n">tick_colors</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="s1">'m'</span><span class="p">])</span>
            <span class="n">idx_labels</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>

        <span class="n">rdms</span> <span class="o">=</span> <span class="n">rsatoolbox</span><span class="o">.</span><span class="n">rdm</span><span class="o">.</span><span class="n">concat</span><span class="p">(</span><span class="n">rdms_list</span><span class="p">)</span>

        <span class="c1">#Flatten the list</span>
        <span class="n">ax_ticks</span> <span class="o">=</span> <span class="p">[</span><span class="n">l</span> <span class="k">for</span> <span class="n">model_layers</span> <span class="ow">in</span> <span class="n">ax_ticks</span> <span class="k">for</span> <span class="n">l</span> <span class="ow">in</span> <span class="n">model_layers</span><span class="p">]</span>
        <span class="n">tick_colors</span> <span class="o">=</span> <span class="p">[</span><span class="n">l</span> <span class="k">for</span> <span class="n">model_layers</span> <span class="ow">in</span> <span class="n">tick_colors</span> <span class="k">for</span> <span class="n">l</span> <span class="ow">in</span> <span class="n">model_layers</span><span class="p">]</span>
        <span class="n">tick_colors</span> <span class="o">=</span> <span class="p">[</span><span class="s1">'k'</span> <span class="k">if</span> <span class="n">tick</span> <span class="o">==</span> <span class="s1">'input'</span> <span class="k">else</span> <span class="n">color</span> <span class="k">for</span> <span class="n">tick</span><span class="p">,</span> <span class="n">color</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">ax_ticks</span><span class="p">,</span> <span class="n">tick_colors</span><span class="p">)]</span>

        <span class="n">rdms_comp</span> <span class="o">=</span> <span class="n">rsatoolbox</span><span class="o">.</span><span class="n">rdm</span><span class="o">.</span><span class="n">compare</span><span class="p">(</span><span class="n">rdms</span><span class="p">,</span> <span class="n">rdms</span><span class="p">,</span> <span class="n">method</span><span class="o">=</span><span class="n">rdm_comp_method</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">rdm_comp_method</span> <span class="o">==</span> <span class="s1">'cosine'</span><span class="p">:</span>
            <span class="n">rdms_comp</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arccos</span><span class="p">(</span><span class="n">rdms_comp</span><span class="p">)</span>
        <span class="n">rdms_comp</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan_to_num</span><span class="p">(</span><span class="n">rdms_comp</span><span class="p">,</span> <span class="n">nan</span><span class="o">=</span><span class="mf">0.0</span><span class="p">)</span>

        <span class="c1"># Symmetrize</span>
        <span class="n">rdms_comp</span> <span class="o">=</span> <span class="p">(</span><span class="n">rdms_comp</span> <span class="o">+</span> <span class="n">rdms_comp</span><span class="o">.</span><span class="n">T</span><span class="p">)</span> <span class="o">/</span> <span class="mf">2.0</span>

        <span class="c1"># reduce dim to 2</span>
        <span class="n">transformer</span> <span class="o">=</span> <span class="n">manifold</span><span class="o">.</span><span class="n">MDS</span><span class="p">(</span><span class="n">n_components</span> <span class="o">=</span> <span class="mi">2</span><span class="p">,</span> <span class="n">max_iter</span><span class="o">=</span><span class="mi">1000</span><span class="p">,</span> <span class="n">n_init</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span> <span class="n">normalized_stress</span><span class="o">=</span><span class="s1">'auto'</span><span class="p">,</span> <span class="n">dissimilarity</span><span class="o">=</span><span class="s2">"precomputed"</span><span class="p">)</span>
        <span class="n">dims</span><span class="o">=</span> <span class="n">transformer</span><span class="o">.</span><span class="n">fit_transform</span><span class="p">(</span><span class="n">rdms_comp</span><span class="p">)</span>

        <span class="c1"># remove duplicates of the input layer from multiple models</span>
        <span class="n">remove_duplicates</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">ax_ticks</span><span class="p">)</span> <span class="o">==</span> <span class="s1">'input'</span><span class="p">)[</span><span class="mi">0</span><span class="p">][</span><span class="mi">1</span><span class="p">:]</span>
        <span class="k">for</span> <span class="n">index</span> <span class="ow">in</span> <span class="n">remove_duplicates</span><span class="p">:</span>
            <span class="k">del</span> <span class="n">ax_ticks</span><span class="p">[</span><span class="n">index</span><span class="p">]</span>
            <span class="k">del</span> <span class="n">tick_colors</span><span class="p">[</span><span class="n">index</span><span class="p">]</span>
            <span class="n">rdms_comp</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">delete</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">delete</span><span class="p">(</span><span class="n">rdms_comp</span><span class="p">,</span> <span class="n">index</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">),</span> <span class="n">index</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

        <span class="n">fig</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">8</span><span class="p">,</span> <span class="mi">4</span><span class="p">))</span>
        <span class="n">gs</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">add_gridspec</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
        <span class="n">fig</span><span class="o">.</span><span class="n">subplots_adjust</span><span class="p">(</span><span class="n">wspace</span><span class="o">=</span><span class="mf">0.2</span><span class="p">,</span> <span class="n">hspace</span><span class="o">=</span><span class="mf">0.2</span><span class="p">)</span>

        <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplot</span><span class="p">(</span><span class="n">gs</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">])</span>
        <span class="n">ax_</span> <span class="o">=</span> <span class="n">ax</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">rdms_comp</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="s1">'viridis_r'</span><span class="p">)</span>
        <span class="n">fig</span><span class="o">.</span><span class="n">subplots_adjust</span><span class="p">(</span><span class="n">left</span><span class="o">=</span><span class="mf">0.2</span><span class="p">)</span>
        <span class="n">cbar_ax</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">add_axes</span><span class="p">([</span><span class="o">-</span><span class="mf">0.01</span><span class="p">,</span> <span class="mf">0.2</span><span class="p">,</span> <span class="mf">0.01</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">])</span>
        <span class="c1">#cbar_ax.text(-7, 0.05, 'dissimilarity between rdms', size=10, rotation=90)</span>
        <span class="n">fig</span><span class="o">.</span><span class="n">colorbar</span><span class="p">(</span><span class="n">ax_</span><span class="p">,</span> <span class="n">cax</span><span class="o">=</span><span class="n">cbar_ax</span><span class="p">,</span><span class="n">location</span><span class="o">=</span><span class="s1">'left'</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">'Dissimilarity between layer rdms'</span><span class="p">,</span> <span class="n">fontdict</span> <span class="o">=</span> <span class="p">{</span><span class="s1">'fontsize'</span><span class="p">:</span> <span class="mi">14</span><span class="p">})</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_xticks</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">ax_ticks</span><span class="p">)),</span> <span class="n">labels</span><span class="o">=</span><span class="n">ax_ticks</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">7</span><span class="p">,</span> <span class="n">rotation</span><span class="o">=</span><span class="mi">83</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_yticks</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">ax_ticks</span><span class="p">)),</span> <span class="n">labels</span><span class="o">=</span><span class="n">ax_ticks</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">7</span><span class="p">)</span>
        <span class="p">[</span><span class="n">t</span><span class="o">.</span><span class="n">set_color</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="k">for</span> <span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">t</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">tick_colors</span><span class="p">,</span> <span class="n">ax</span><span class="o">.</span><span class="n">xaxis</span><span class="o">.</span><span class="n">get_ticklabels</span><span class="p">())]</span>
        <span class="p">[</span><span class="n">t</span><span class="o">.</span><span class="n">set_color</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="k">for</span> <span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">t</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">tick_colors</span><span class="p">,</span> <span class="n">ax</span><span class="o">.</span><span class="n">yaxis</span><span class="o">.</span><span class="n">get_ticklabels</span><span class="p">())]</span>

        <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplot</span><span class="p">(</span><span class="n">gs</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">])</span>
        <span class="n">amin</span><span class="p">,</span> <span class="n">amax</span> <span class="o">=</span> <span class="n">dims</span><span class="o">.</span><span class="n">min</span><span class="p">(),</span> <span class="n">dims</span><span class="o">.</span><span class="n">max</span><span class="p">()</span>
        <span class="n">amin</span><span class="p">,</span> <span class="n">amax</span> <span class="o">=</span> <span class="p">(</span><span class="n">amin</span> <span class="o">+</span> <span class="n">amax</span><span class="p">)</span> <span class="o">/</span> <span class="mi">2</span> <span class="o">-</span> <span class="p">(</span><span class="n">amax</span> <span class="o">-</span> <span class="n">amin</span><span class="p">)</span> <span class="o">*</span> <span class="mi">5</span><span class="o">/</span><span class="mi">8</span><span class="p">,</span> <span class="p">(</span><span class="n">amin</span> <span class="o">+</span> <span class="n">amax</span><span class="p">)</span> <span class="o">/</span> <span class="mi">2</span> <span class="o">+</span> <span class="p">(</span><span class="n">amax</span> <span class="o">-</span> <span class="n">amin</span><span class="p">)</span> <span class="o">*</span> <span class="mi">5</span><span class="o">/</span><span class="mi">8</span>

        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">rdms_list</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span><span class="p">):</span>

            <span class="n">path_indices</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">path_len</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">path_len</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">])</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">dims</span><span class="p">[</span><span class="n">path_indices</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span> <span class="n">dims</span><span class="p">[</span><span class="n">path_indices</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span> <span class="n">color</span><span class="o">=</span><span class="n">path_colors</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">marker</span><span class="o">=</span><span class="s1">'.'</span><span class="p">)</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">'Representational geometry path'</span><span class="p">,</span> <span class="n">fontdict</span> <span class="o">=</span> <span class="p">{</span><span class="s1">'fontsize'</span><span class="p">:</span> <span class="mi">14</span><span class="p">})</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">set_xlim</span><span class="p">([</span><span class="n">amin</span><span class="p">,</span> <span class="n">amax</span><span class="p">])</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">set_ylim</span><span class="p">([</span><span class="n">amin</span><span class="p">,</span> <span class="n">amax</span><span class="p">])</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="sa">f</span><span class="s2">"dim 1"</span><span class="p">)</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="sa">f</span><span class="s2">"dim 2"</span><span class="p">)</span>

        <span class="c1"># if idx_input is not None:</span>
        <span class="n">idx_input</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">dims</span><span class="p">[</span><span class="n">idx_input</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span> <span class="n">dims</span><span class="p">[</span><span class="n">idx_input</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span> <span class="n">color</span><span class="o">=</span><span class="s1">'k'</span><span class="p">,</span> <span class="n">marker</span><span class="o">=</span><span class="s1">'s'</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">labels</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">dims</span><span class="p">[</span><span class="n">idx_labels</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span> <span class="n">dims</span><span class="p">[</span><span class="n">idx_labels</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span> <span class="n">color</span><span class="o">=</span><span class="s1">'m'</span><span class="p">,</span> <span class="n">marker</span><span class="o">=</span><span class="s1">'*'</span><span class="p">)</span>

        <span class="n">ax</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">model_names</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">8</span><span class="p">)</span>
        <span class="n">fig</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>

<span class="k">def</span><span class="w"> </span><span class="nf">plot_dim_reduction</span><span class="p">(</span><span class="n">model_features</span><span class="p">,</span> <span class="n">labels</span><span class="p">,</span> <span class="n">transformer_funcs</span><span class="p">):</span>
<span class="w">    </span><span class="sd">"""</span>
<span class="sd">    Plots the dimensionality reduction results for model features using various transformers.</span>

<span class="sd">    Inputs:</span>
<span class="sd">    - model_features (dict): Dictionary containing model features for each layer.</span>
<span class="sd">    - labels (array-like): Array of labels corresponding to the model features.</span>
<span class="sd">    - transformer_funcs (list): List of dimensionality reduction techniques to apply ('PCA', 'MDS', 't-SNE').</span>
<span class="sd">    """</span>
    <span class="k">with</span> <span class="n">plt</span><span class="o">.</span><span class="n">xkcd</span><span class="p">():</span>

        <span class="n">transformers</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">transformer_funcs</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">t</span> <span class="o">==</span> <span class="s1">'PCA'</span><span class="p">:</span> <span class="n">transformers</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">PCA</span><span class="p">(</span><span class="n">n_components</span><span class="o">=</span><span class="mi">2</span><span class="p">))</span>
            <span class="k">if</span> <span class="n">t</span> <span class="o">==</span> <span class="s1">'MDS'</span><span class="p">:</span> <span class="n">transformers</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">manifold</span><span class="o">.</span><span class="n">MDS</span><span class="p">(</span><span class="n">n_components</span> <span class="o">=</span> <span class="mi">2</span><span class="p">,</span> <span class="n">normalized_stress</span><span class="o">=</span><span class="s1">'auto'</span><span class="p">))</span>
            <span class="k">if</span> <span class="n">t</span> <span class="o">==</span> <span class="s1">'t-SNE'</span><span class="p">:</span> <span class="n">transformers</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">manifold</span><span class="o">.</span><span class="n">TSNE</span><span class="p">(</span><span class="n">n_components</span> <span class="o">=</span> <span class="mi">2</span><span class="p">,</span> <span class="n">perplexity</span><span class="o">=</span><span class="mi">40</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="mi">0</span><span class="p">))</span>

        <span class="n">fig</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">8</span><span class="p">,</span> <span class="mf">2.5</span><span class="o">*</span><span class="nb">len</span><span class="p">(</span><span class="n">transformers</span><span class="p">)))</span>
        <span class="c1"># and we add one plot per reference point</span>
        <span class="n">gs</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">add_gridspec</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">transformers</span><span class="p">),</span> <span class="nb">len</span><span class="p">(</span><span class="n">model_features</span><span class="p">))</span>
        <span class="n">fig</span><span class="o">.</span><span class="n">subplots_adjust</span><span class="p">(</span><span class="n">wspace</span><span class="o">=</span><span class="mf">0.2</span><span class="p">,</span> <span class="n">hspace</span><span class="o">=</span><span class="mf">0.2</span><span class="p">)</span>

        <span class="n">return_layers</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">model_features</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>

        <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">transformer_funcs</span><span class="p">)):</span>

            <span class="k">for</span> <span class="n">l</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">return_layers</span><span class="p">)):</span>
                <span class="n">layer</span> <span class="o">=</span>  <span class="n">return_layers</span><span class="p">[</span><span class="n">l</span><span class="p">]</span>
                <span class="n">feats</span> <span class="o">=</span> <span class="n">model_features</span><span class="p">[</span><span class="n">layer</span><span class="p">]</span><span class="o">.</span><span class="n">detach</span><span class="p">()</span><span class="o">.</span><span class="n">cpu</span><span class="p">()</span><span class="o">.</span><span class="n">flatten</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
                <span class="n">feats_transformed</span><span class="o">=</span> <span class="n">transformers</span><span class="p">[</span><span class="n">f</span><span class="p">]</span><span class="o">.</span><span class="n">fit_transform</span><span class="p">(</span><span class="n">feats</span><span class="p">)</span>

                <span class="n">amin</span><span class="p">,</span> <span class="n">amax</span> <span class="o">=</span> <span class="n">feats_transformed</span><span class="o">.</span><span class="n">min</span><span class="p">(),</span> <span class="n">feats_transformed</span><span class="o">.</span><span class="n">max</span><span class="p">()</span>
                <span class="n">amin</span><span class="p">,</span> <span class="n">amax</span> <span class="o">=</span> <span class="p">(</span><span class="n">amin</span> <span class="o">+</span> <span class="n">amax</span><span class="p">)</span> <span class="o">/</span> <span class="mi">2</span> <span class="o">-</span> <span class="p">(</span><span class="n">amax</span> <span class="o">-</span> <span class="n">amin</span><span class="p">)</span> <span class="o">*</span> <span class="mi">5</span><span class="o">/</span><span class="mi">8</span><span class="p">,</span> <span class="p">(</span><span class="n">amin</span> <span class="o">+</span> <span class="n">amax</span><span class="p">)</span> <span class="o">/</span> <span class="mi">2</span> <span class="o">+</span> <span class="p">(</span><span class="n">amax</span> <span class="o">-</span> <span class="n">amin</span><span class="p">)</span> <span class="o">*</span> <span class="mi">5</span><span class="o">/</span><span class="mi">8</span>
                <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplot</span><span class="p">(</span><span class="n">gs</span><span class="p">[</span><span class="n">f</span><span class="p">,</span><span class="n">l</span><span class="p">])</span>
                <span class="n">ax</span><span class="o">.</span><span class="n">set_xlim</span><span class="p">([</span><span class="n">amin</span><span class="p">,</span> <span class="n">amax</span><span class="p">])</span>
                <span class="n">ax</span><span class="o">.</span><span class="n">set_ylim</span><span class="p">([</span><span class="n">amin</span><span class="p">,</span> <span class="n">amax</span><span class="p">])</span>
                <span class="n">ax</span><span class="o">.</span><span class="n">axis</span><span class="p">(</span><span class="s2">"off"</span><span class="p">)</span>
                <span class="c1">#ax.set_title(f'{layer}')</span>
                <span class="k">if</span> <span class="n">f</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span> <span class="n">ax</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="mf">0.5</span><span class="p">,</span> <span class="mf">1.12</span><span class="p">,</span> <span class="sa">f</span><span class="s1">'</span><span class="si">{</span><span class="n">layer</span><span class="si">}</span><span class="s1">'</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="mi">16</span><span class="p">,</span> <span class="n">ha</span><span class="o">=</span><span class="s2">"center"</span><span class="p">,</span> <span class="n">transform</span><span class="o">=</span><span class="n">ax</span><span class="o">.</span><span class="n">transAxes</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">l</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span> <span class="n">ax</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="o">-</span><span class="mf">0.3</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">,</span> <span class="n">transformer_funcs</span><span class="p">[</span><span class="n">f</span><span class="p">],</span> <span class="n">size</span><span class="o">=</span><span class="mi">16</span><span class="p">,</span> <span class="n">ha</span><span class="o">=</span><span class="s2">"center"</span><span class="p">,</span> <span class="n">transform</span><span class="o">=</span><span class="n">ax</span><span class="o">.</span><span class="n">transAxes</span><span class="p">)</span>
                <span class="c1"># Create a discrete color map based on unique labels</span>
                <span class="n">num_colors</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">labels</span><span class="p">))</span>
                <span class="n">cmap</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">get_cmap</span><span class="p">(</span><span class="s1">'viridis_r'</span><span class="p">,</span> <span class="n">num_colors</span><span class="p">)</span> <span class="c1"># 10 discrete colors</span>
                <span class="n">norm</span> <span class="o">=</span> <span class="n">mpl</span><span class="o">.</span><span class="n">colors</span><span class="o">.</span><span class="n">BoundaryNorm</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="o">-</span><span class="mf">0.5</span><span class="p">,</span><span class="n">num_colors</span><span class="p">),</span> <span class="n">cmap</span><span class="o">.</span><span class="n">N</span><span class="p">)</span>
                <span class="n">ax_</span> <span class="o">=</span> <span class="n">ax</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">feats_transformed</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">],</span> <span class="n">feats_transformed</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">],</span> <span class="n">c</span><span class="o">=</span><span class="n">labels</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="n">cmap</span><span class="p">,</span> <span class="n">norm</span><span class="o">=</span><span class="n">norm</span><span class="p">)</span>

        <span class="n">fig</span><span class="o">.</span><span class="n">subplots_adjust</span><span class="p">(</span><span class="n">right</span><span class="o">=</span><span class="mf">0.9</span><span class="p">)</span>
        <span class="n">cbar_ax</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">add_axes</span><span class="p">([</span><span class="mf">1.01</span><span class="p">,</span> <span class="mf">0.18</span><span class="p">,</span> <span class="mf">0.01</span><span class="p">,</span> <span class="mf">0.53</span><span class="p">])</span>
        <span class="n">fig</span><span class="o">.</span><span class="n">colorbar</span><span class="p">(</span><span class="n">ax_</span><span class="p">,</span> <span class="n">cax</span><span class="o">=</span><span class="n">cbar_ax</span><span class="p">,</span> <span class="n">ticks</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">9</span><span class="p">,</span><span class="mi">10</span><span class="p">))</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
</details>
</div>
</section>
<section id="data-retrieval">
<h2>Data retrieval<a class="headerlink" href="#data-retrieval" title="Permalink to this heading">#</a></h2>
<div class="cell tag_hide-input docutils container">
<details class="hide above-input">
<summary aria-label="Toggle hidden content">
<span class="collapsed">Show code cell source</span>
<span class="expanded">Hide code cell source</span>
</summary>
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># @title Data retrieval</span>

<span class="kn">import</span><span class="w"> </span><span class="nn">os</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">requests</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">hashlib</span>

<span class="c1"># Variables for file and download URL</span>
<span class="n">fnames</span> <span class="o">=</span> <span class="p">[</span><span class="s2">"standard_model.pth"</span><span class="p">,</span> <span class="s2">"adversarial_model.pth"</span><span class="p">,</span> <span class="s2">"recurrent_model.pth"</span><span class="p">]</span> <span class="c1"># The names of the files to be downloaded</span>
<span class="n">urls</span> <span class="o">=</span> <span class="p">[</span><span class="s2">"https://osf.io/s5rt6/download"</span><span class="p">,</span> <span class="s2">"https://osf.io/qv5eb/download"</span><span class="p">,</span> <span class="s2">"https://osf.io/6hnwk/download"</span><span class="p">]</span> <span class="c1"># URLs from where the files will be downloaded</span>
<span class="n">expected_md5s</span> <span class="o">=</span> <span class="p">[</span><span class="s2">"2e63c2cd77bc9f1fa67673d956ec910d"</span><span class="p">,</span> <span class="s2">"25fb34497377921b54368317f68a7aa7"</span><span class="p">,</span> <span class="s2">"ee5cea3baa264cb78300102fa6ed66e8"</span><span class="p">]</span> <span class="c1"># MD5 hashes for verifying files integrity</span>

<span class="k">for</span> <span class="n">fname</span><span class="p">,</span> <span class="n">url</span><span class="p">,</span> <span class="n">expected_md5</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">fnames</span><span class="p">,</span> <span class="n">urls</span><span class="p">,</span> <span class="n">expected_md5s</span><span class="p">):</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">fname</span><span class="p">):</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="c1"># Attempt to download the file</span>
            <span class="n">r</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">url</span><span class="p">)</span> <span class="c1"># Make a GET request to the specified URL</span>
        <span class="k">except</span> <span class="n">requests</span><span class="o">.</span><span class="n">ConnectionError</span><span class="p">:</span>
            <span class="c1"># Handle connection errors during the download</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">"!!! Failed to download data !!!"</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># No connection errors, proceed to check the response</span>
            <span class="k">if</span> <span class="n">r</span><span class="o">.</span><span class="n">status_code</span> <span class="o">!=</span> <span class="n">requests</span><span class="o">.</span><span class="n">codes</span><span class="o">.</span><span class="n">ok</span><span class="p">:</span>
                <span class="c1"># Check if the HTTP response status code indicates a successful download</span>
                <span class="nb">print</span><span class="p">(</span><span class="s2">"!!! Failed to download data !!!"</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">hashlib</span><span class="o">.</span><span class="n">md5</span><span class="p">(</span><span class="n">r</span><span class="o">.</span><span class="n">content</span><span class="p">)</span><span class="o">.</span><span class="n">hexdigest</span><span class="p">()</span> <span class="o">!=</span> <span class="n">expected_md5</span><span class="p">:</span>
                <span class="c1"># Verify the integrity of the downloaded file using MD5 checksum</span>
                <span class="nb">print</span><span class="p">(</span><span class="s2">"!!! Data download appears corrupted !!!"</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># If download is successful and data is not corrupted, save the file</span>
                <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">fname</span><span class="p">,</span> <span class="s2">"wb"</span><span class="p">)</span> <span class="k">as</span> <span class="n">fid</span><span class="p">:</span>
                    <span class="n">fid</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">r</span><span class="o">.</span><span class="n">content</span><span class="p">)</span> <span class="c1"># Write the downloaded content to a file</span>
</pre></div>
</div>
</div>
</details>
</div>
</section>
<section id="figure-settings">
<h2>Figure settings<a class="headerlink" href="#figure-settings" title="Permalink to this heading">#</a></h2>
<div class="cell tag_hide-input docutils container">
<details class="hide above-input">
<summary aria-label="Toggle hidden content">
<span class="collapsed">Show code cell source</span>
<span class="expanded">Hide code cell source</span>
</summary>
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># @title Figure settings</span>

<span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="s1">'matplotlib.font_manager'</span><span class="p">)</span><span class="o">.</span><span class="n">disabled</span> <span class="o">=</span> <span class="kc">True</span>

<span class="o">%</span><span class="k">matplotlib</span> inline
<span class="o">%</span><span class="k">config</span> InlineBackend.figure_format = 'retina' # perfrom high definition rendering for images and plots
<span class="n">plt</span><span class="o">.</span><span class="n">style</span><span class="o">.</span><span class="n">use</span><span class="p">(</span><span class="s2">"https://raw.githubusercontent.com/NeuromatchAcademy/course-content/main/nma.mplstyle"</span><span class="p">)</span>
</pre></div>
</div>
</div>
</details>
</div>
</section>
<section id="set-device-gpu-or-cpu">
<h2>Set device (GPU or CPU)<a class="headerlink" href="#set-device-gpu-or-cpu" title="Permalink to this heading">#</a></h2>
<div class="cell tag_hide-input docutils container">
<details class="hide above-input">
<summary aria-label="Toggle hidden content">
<span class="collapsed">Show code cell source</span>
<span class="expanded">Hide code cell source</span>
</summary>
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># @title Set device (GPU or CPU)</span>

<span class="c1"># inform the user if the notebook uses GPU or CPU.</span>

<span class="k">def</span><span class="w"> </span><span class="nf">set_device</span><span class="p">():</span>
<span class="w">    </span><span class="sd">"""</span>
<span class="sd">    Determines and sets the computational device for PyTorch operations based on the availability of a CUDA-capable GPU.</span>

<span class="sd">    Outputs:</span>
<span class="sd">    - device (str): The device that PyTorch will use for computations ('cuda' or 'cpu'). This string can be directly used</span>
<span class="sd">    in PyTorch operations to specify the device.</span>
<span class="sd">    """</span>

    <span class="n">device</span> <span class="o">=</span> <span class="s2">"cuda"</span> <span class="k">if</span> <span class="n">torch</span><span class="o">.</span><span class="n">cuda</span><span class="o">.</span><span class="n">is_available</span><span class="p">()</span> <span class="k">else</span> <span class="s2">"cpu"</span>
    <span class="k">if</span> <span class="n">device</span> <span class="o">!=</span> <span class="s2">"cuda"</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">"GPU is not enabled in this notebook. </span><span class="se">\n</span><span class="s2">"</span>
              <span class="s2">"If you want to enable it, in the menu under `Runtime` -&gt; </span><span class="se">\n</span><span class="s2">"</span>
              <span class="s2">"`Hardware accelerator.` and select `GPU` from the dropdown menu"</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">"GPU is enabled in this notebook. </span><span class="se">\n</span><span class="s2">"</span>
              <span class="s2">"If you want to disable it, in the menu under `Runtime` -&gt; </span><span class="se">\n</span><span class="s2">"</span>
              <span class="s2">"`Hardware accelerator.` and select `None` from the dropdown menu"</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">device</span>

<span class="n">device</span> <span class="o">=</span> <span class="n">set_device</span><span class="p">()</span>
</pre></div>
</div>
</div>
</details>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>GPU is not enabled in this notebook. 
If you want to enable it, in the menu under `Runtime` -&gt; 
`Hardware accelerator.` and select `GPU` from the dropdown menu
</pre></div>
</div>
</div>
</div>
</section>
<section id="load-slides">
<h2>Load Slides<a class="headerlink" href="#load-slides" title="Permalink to this heading">#</a></h2>
<div class="cell tag_remove-input docutils container">
<div class="cell_output docutils container">
<script type="application/vnd.jupyter.widget-view+json">{"version_major": 2, "version_minor": 0, "model_id": "a0c3ed71d94e4ed4848fa9179cebd00d"}</script></div>
</div>
</section>
</section>
<hr class="docutils"/>
<section class="tex2jax_ignore mathjax_ignore" id="intro">
<h1>Intro<a class="headerlink" href="#intro" title="Permalink to this heading">#</a></h1>
<p>Welcome to Tutorial 5 of Day 3 (W1D3) of the NeuroAI course. In this tutorial we are going to look at an exciting method that measures similarity from a slightly different perspective, a temporal one. The prior methods we have looked at were centeed around geometry and spatial representations, where we looked at metrics such as the Euclidean and Mahalanobis distance metrics. However, one thing we often want to study in neuroscience and in AI separately - is the temporal domain. Even more so in our own field of NeuroAI, we often deal with time series of neuronal / biological recordings. One thing you should already have a broad level of awareness of is that end structures can end up looking the same even though the paths taken to arrive at those end structures were very different.</p>
<p>In NeuroAI, weâ€™re often confronted with systems that seem to have some sort of overlap and we want to study whether this implies there is a shared computation pairs up with the shared task (we looked at this in detail yesterday in our <em>Comparing Tasks</em> day). Today, we will begin by watching a short intro video by Mitchell Ostrow, who will describe his method to compare representations over temporal sequences (the method is called Dynamic Similarity Analysis). Then we are going to introduce three simple dynamical systems and we will explore them from the perspective of Dynamic Similarity Analysis and also describe the conceptual relationship to Representational Similarity Analysis. You will have a short coding exercise on the topic of temporal similarity analysis on three different types of trajectories.</p>
<p>At the end of the tutorial, we will finally look at a further aspect of temporal sequences using RNNs. This is an adaptation of the ideas introduced in Tutorial 2 but now based around recurrent representations from RNNs. We hope you enjoy this tutorial today and that it gets you thinking not just what similarity values mean, but which ones are appropriate (here, from a spatial or temporal perspective). We aim to continually expand the tools necessary in the NeuroAI researcherâ€™s toolkit. Complementary tools, when applicable, can often tell a far richer story than just using a single method.</p>
<section id="video-1-dynamical-similarity-analysis">
<h2>Video 1: Dynamical Similarity Analysis<a class="headerlink" href="#video-1-dynamical-similarity-analysis" title="Permalink to this heading">#</a></h2>
<div class="cell tag_remove-input docutils container">
<div class="cell_output docutils container">
<script type="application/vnd.jupyter.widget-view+json">{"version_major": 2, "version_minor": 0, "model_id": "975374bddb7f4a19a862437f1aa5afda"}</script></div>
</div>
</section>
<section id="submit-your-feedback">
<h2>Submit your feedback<a class="headerlink" href="#submit-your-feedback" title="Permalink to this heading">#</a></h2>
<div class="cell tag_hide-input docutils container">
<details class="hide above-input">
<summary aria-label="Toggle hidden content">
<span class="collapsed">Show code cell source</span>
<span class="expanded">Hide code cell source</span>
</summary>
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># @title Submit your feedback</span>
<span class="n">content_review</span><span class="p">(</span><span class="sa">f</span><span class="s2">"</span><span class="si">{</span><span class="n">feedback_prefix</span><span class="si">}</span><span class="s2">_DSA_video"</span><span class="p">)</span>
</pre></div>
</div>
</div>
</details>
<div class="cell_output docutils container">
<script type="application/vnd.jupyter.widget-view+json">{"version_major": 2, "version_minor": 0, "model_id": "57d3755db9df407b968acdcae7fdd67d"}</script></div>
</div>
</section>
<section id="section-1-visualization-of-three-temporal-sequences">
<h2>Section 1: Visualization of Three Temporal Sequences<a class="headerlink" href="#section-1-visualization-of-three-temporal-sequences" title="Permalink to this heading">#</a></h2>
<p>We are going to be working with the analysis of three temporal sequences today:</p>
<ul class="simple">
<li><p>The circular time series (<code class="docutils literal notranslate"><span class="pre">Circle</span></code>)</p></li>
<li><p>The oval time series (<code class="docutils literal notranslate"><span class="pre">Oval</span></code>)</p></li>
<li><p>The random walk (<code class="docutils literal notranslate"><span class="pre">R-Walk</span></code>)</p></li>
</ul>
<p>The random walk is going to be broadly <em>oval shaped</em>. Now, what do you think, from a geometric perspective, might result from a spatial analysis of these three different <em>representations</em>? You will probably assume because the random walk has an oval shape and there is also an oval time series (thatâ€™s not a random walk) that these would result in a higher spatial similarity. Youâ€™d be right to assume this. However, what weâ€™re going to do with the <code class="docutils literal notranslate"><span class="pre">Circle</span></code> and <code class="docutils literal notranslate"><span class="pre">Oval</span></code> time series is to include an oscillator at a specific frequency, shared amongst these two time series. In effect, this means that although when plotted in totality the shapes are different, during the dynamic (temporal) evolution of these time series, a very similar shared pattern is emerging. We want methods that are sensitive to these changes to give higher scores for time series sharing similar temporal patterns (e.g. both containing oscillating patterns at similar frequences) rather than just a random walk that resembles (geometrically) one of the other shapes (<code class="docutils literal notranslate"><span class="pre">R-Walk</span></code>). Before we continue, weâ€™ll just define this random walk in a little more detail. A random walk at a specific location / timepoint takes a random step of fixed length in a specific direction, but this can be broadly controlled to resemble geometric shapes. Weâ€™ve taken a random walk and then reframed it to be similar in shape to <code class="docutils literal notranslate"><span class="pre">Oval</span></code>.</p>
<p>Letâ€™s now visualize these three temporal sequences, to make the previous paragraph a little clearer.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Circle</span>
<span class="n">r</span> <span class="o">=</span> <span class="mf">.1</span><span class="p">;</span> <span class="c1"># rotation</span>
<span class="n">A</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([[</span><span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">r</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">r</span><span class="p">)],</span> <span class="p">[</span><span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">r</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">r</span><span class="p">)]])</span>
<span class="n">B</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">]])</span>

<span class="n">trajectory</span> <span class="o">=</span> <span class="n">generate_2d_random_process</span><span class="p">(</span><span class="n">A</span><span class="p">,</span> <span class="n">B</span><span class="p">)</span>
<span class="n">trajectory_circle</span> <span class="o">=</span> <span class="n">trajectory</span>

<span class="c1"># Oval</span>
<span class="n">r</span> <span class="o">=</span> <span class="mf">.1</span><span class="p">;</span> <span class="c1"># rotation</span>
<span class="n">s</span> <span class="o">=</span> <span class="mi">4</span><span class="p">;</span>  <span class="c1"># scaling</span>
<span class="n">S</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="n">s</span><span class="p">]])</span>
<span class="n">Si</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="o">/</span><span class="n">s</span><span class="p">]])</span>
<span class="n">V</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span> <span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">]])</span><span class="o">/</span><span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
<span class="n">Vi</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([[</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">]])</span><span class="o">/</span><span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
<span class="n">R</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([[</span><span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">r</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">r</span><span class="p">)],</span> <span class="p">[</span><span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">r</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">r</span><span class="p">)]])</span>
<span class="n">A</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">multi_dot</span><span class="p">([</span><span class="n">V</span><span class="p">,</span><span class="n">Si</span><span class="p">,</span><span class="n">R</span><span class="p">,</span><span class="n">S</span><span class="p">,</span><span class="n">Vi</span><span class="p">])</span>
<span class="n">B</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">]])</span>

<span class="n">trajectory</span> <span class="o">=</span> <span class="n">generate_2d_random_process</span><span class="p">(</span><span class="n">A</span><span class="p">,</span> <span class="n">B</span><span class="p">)</span>
<span class="n">trajectory_oval</span> <span class="o">=</span> <span class="n">trajectory</span>

<span class="c1"># R-Walk (random walk)</span>
<span class="n">r</span> <span class="o">=</span> <span class="mf">.1</span><span class="p">;</span> <span class="c1"># rotation</span>
<span class="n">A</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([[</span><span class="mf">.9</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mf">.9</span><span class="p">]])</span>
<span class="n">c</span> <span class="o">=</span> <span class="o">-</span><span class="mf">.95</span><span class="p">;</span> <span class="c1"># correlation coefficient</span>
<span class="n">B</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([[</span><span class="mi">1</span><span class="p">,</span> <span class="n">c</span><span class="p">],</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mi">1</span><span class="o">-</span><span class="n">c</span><span class="o">*</span><span class="n">c</span><span class="p">)]])</span>

<span class="n">trajectory</span> <span class="o">=</span> <span class="n">generate_2d_random_process</span><span class="p">(</span><span class="n">A</span><span class="p">,</span> <span class="n">B</span><span class="p">)</span>
<span class="n">trajectory_walk</span> <span class="o">=</span> <span class="n">trajectory</span>
</pre></div>
</div>
</div>
</div>
<p>Can you see how the spatial / geometric similarity of <code class="docutils literal notranslate"><span class="pre">R-Walk</span></code> and <code class="docutils literal notranslate"><span class="pre">Oval</span></code> are more similar, but the oscillations during the temporal sequence are shared between <code class="docutils literal notranslate"><span class="pre">Circle</span></code> and <code class="docutils literal notranslate"><span class="pre">Oval</span></code>? Letâ€™s run Dynamic Similarity Analysis on these temporal sequences and see what scores are returned.</p>
<p>We calcularted <code class="docutils literal notranslate"><span class="pre">trajectory_oval</span></code> and <code class="docutils literal notranslate"><span class="pre">trajectory_circle</span></code> above, so letâ€™s plug these into the <code class="docutils literal notranslate"><span class="pre">DSA</span></code> function imported earlier (in the helper function cell) and see what the similarity score is.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Define the DSA computation class</span>
<span class="n">dsa</span> <span class="o">=</span> <span class="n">DSA</span><span class="p">(</span><span class="n">X</span><span class="o">=</span><span class="n">trajectory_oval</span><span class="p">,</span> <span class="n">Y</span><span class="o">=</span><span class="n">trajectory_circle</span><span class="p">,</span> <span class="n">n_delays</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

<span class="c1"># Call the fit method and save the result</span>
<span class="n">similarities_oval_circle</span> <span class="o">=</span> <span class="n">dsa</span><span class="o">.</span><span class="n">fit_score</span><span class="p">()</span>

<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"DSA similarity between Oval and Circle: </span><span class="si">{</span><span class="n">similarities_oval_circle</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>DSA similarity between Oval and Circle: 0.0012
</pre></div>
</div>
</div>
</div>
</section>
<section id="multi-way-comparison">
<h2>Multi-way Comparison<a class="headerlink" href="#multi-way-comparison" title="Permalink to this heading">#</a></h2>
<p>Weâ€™re now going to run DSA on our three trajectories and fit the model, returning the scores which we can investigate by plotting a confusion matrix with a heatmap to show the DSA scores.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">n_delays</span> <span class="o">=</span> <span class="mi">1</span>
<span class="n">delay_interval</span> <span class="o">=</span> <span class="mi">1</span>

<span class="n">models</span> <span class="o">=</span> <span class="p">[</span><span class="n">trajectory_circle</span><span class="p">,</span> <span class="n">trajectory_oval</span><span class="p">,</span> <span class="n">trajectory_walk</span><span class="p">]</span>
<span class="n">dsa</span> <span class="o">=</span> <span class="n">DSA</span><span class="p">(</span><span class="n">models</span><span class="p">,</span> <span class="n">n_delays</span><span class="o">=</span><span class="n">n_delays</span><span class="p">,</span> <span class="n">delay_interval</span><span class="o">=</span><span class="n">delay_interval</span><span class="p">)</span>
<span class="n">similarities</span> <span class="o">=</span> <span class="n">dsa</span><span class="o">.</span><span class="n">fit_score</span><span class="p">()</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">labels</span> <span class="o">=</span> <span class="p">[</span><span class="s1">'Circle'</span><span class="p">,</span> <span class="s1">'Oval'</span><span class="p">,</span> <span class="s1">'Walk'</span><span class="p">]</span>
<span class="n">data</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">rand</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">labels</span><span class="p">),</span> <span class="nb">len</span><span class="p">(</span><span class="n">labels</span><span class="p">))</span>
<span class="n">ax</span> <span class="o">=</span> <span class="n">sns</span><span class="o">.</span><span class="n">heatmap</span><span class="p">(</span><span class="n">similarities</span><span class="p">,</span> <span class="n">xticklabels</span><span class="o">=</span><span class="n">labels</span><span class="p">,</span> <span class="n">yticklabels</span><span class="o">=</span><span class="n">labels</span><span class="p">)</span>
<span class="n">cbar</span> <span class="o">=</span> <span class="n">ax</span><span class="o">.</span><span class="n">collections</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">colorbar</span>
<span class="n">cbar</span><span class="o">.</span><span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">'DSA Score'</span><span class="p">);</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s2">"Dynamic Similarity Analysis Score among Trajectories"</span><span class="p">);</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../../../_images/df6a3fab8fcffb0b45493b49bc0a4f685af18cf8a2a0f531a8eeda7a81d72dd2.png" src="../../../_images/df6a3fab8fcffb0b45493b49bc0a4f685af18cf8a2a0f531a8eeda7a81d72dd2.png">
</img></div>
</div>
<p>This heatmap across the three model comparisons shows that the DSA scores between (<code class="docutils literal notranslate"><span class="pre">Walk</span></code> and <code class="docutils literal notranslate"><span class="pre">Circle</span></code>) and (<code class="docutils literal notranslate"><span class="pre">Walk</span></code> and <code class="docutils literal notranslate"><span class="pre">Oval</span></code>) to be (relatively) high, while the comparison between (<code class="docutils literal notranslate"><span class="pre">Circle</span></code> and <code class="docutils literal notranslate"><span class="pre">Oval</span></code>) is very low. Please note that this confusion matrix is symmetrical, meaning that the analysis between <code class="docutils literal notranslate"><span class="pre">trajectory_A</span></code> and <code class="docutils literal notranslate"><span class="pre">trajectory_B</span></code> returns the same dynamic similarity score as <code class="docutils literal notranslate"><span class="pre">trajectory_B</span></code> and <code class="docutils literal notranslate"><span class="pre">trajectory_A</span></code>. This is a common feature we have also seen in comparison metrics in standard RSA. One thing to note in the calculation of DSA is that comparisons among identical trajectories is <code class="docutils literal notranslate"><span class="pre">0</span></code>. This is unlike in RSA where we expect the correlation among the same stimuli to be <code class="docutils literal notranslate"><span class="pre">1.0</span></code>. This is why we see black squares along the diagonal.</p>
<p>Letâ€™s put our thinking caps on for a moment: This isnâ€™t really the result we would have expected, right? What do you think might be going on here? Have a look back at the <em>hyperparameters</em> and try to make an educated guess!</p>
</section>
<section id="dsa-hyperparameters-n-delays-and-delay-interval">
<h2>DSA Hyperparameters (<code class="docutils literal notranslate"><span class="pre">n_delays</span></code> and <code class="docutils literal notranslate"><span class="pre">delay_interval</span></code>)<a class="headerlink" href="#dsa-hyperparameters-n-delays-and-delay-interval" title="Permalink to this heading">#</a></h2>
<p>Weâ€™ll now give you a hint as to why the setting of these hyperparameters is important when considering dynamic similarity analysis. The oscillators we have placed in the trajectories of <code class="docutils literal notranslate"><span class="pre">Circle</span></code> and <code class="docutils literal notranslate"><span class="pre">Oval</span></code> are not immediately apparent if you study only the previous time step for each element. Itâ€™s only when considering the recurring pattern across a few different temporal delays and at what delay interval you want those to be, that we would expect to be able to detect recurring oscillations that provide us with the information we need to conclude that <code class="docutils literal notranslate"><span class="pre">Oval</span></code> and <code class="docutils literal notranslate"><span class="pre">Circle</span></code> are actually <em>dynamically</em> similar.</p>
<p>You should change the values below to be more sensible hyperparameter settings and re-run the model and plot the new confusion matrix. Try using <code class="docutils literal notranslate"><span class="pre">n_delays</span></code> equal to <code class="docutils literal notranslate"><span class="pre">20</span></code> and <code class="docutils literal notranslate"><span class="pre">delay_interval</span></code> equal to <code class="docutils literal notranslate"><span class="pre">10</span></code>. Donâ€™t forget to define <code class="docutils literal notranslate"><span class="pre">models</span></code> (see above example if you get stuck).</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1">#################################################</span>
<span class="c1">## TODO for students: fill in the missing parts ##</span>
<span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span><span class="s2">"Student exercise"</span><span class="p">)</span>
<span class="c1">#################################################</span>

<span class="n">n_delays</span> <span class="o">=</span> <span class="o">...</span>
<span class="n">delay_interval</span> <span class="o">=</span> <span class="o">...</span>

<span class="n">models</span> <span class="o">=</span> <span class="o">...</span>
<span class="n">dsa</span> <span class="o">=</span> <span class="n">DSA</span><span class="p">(</span><span class="o">...</span><span class="p">)</span>
<span class="n">similarities</span> <span class="o">=</span> <span class="o">...</span>

<span class="n">labels</span> <span class="o">=</span> <span class="p">[</span><span class="s1">'Circle'</span><span class="p">,</span> <span class="s1">'Oval'</span><span class="p">,</span> <span class="s1">'Walk'</span><span class="p">]</span>
<span class="n">ax</span> <span class="o">=</span> <span class="n">sns</span><span class="o">.</span><span class="n">heatmap</span><span class="p">(</span><span class="n">similarities</span><span class="p">,</span> <span class="n">xticklabels</span><span class="o">=</span><span class="n">labels</span><span class="p">,</span> <span class="n">yticklabels</span><span class="o">=</span><span class="n">labels</span><span class="p">)</span>
<span class="n">cbar</span> <span class="o">=</span> <span class="n">ax</span><span class="o">.</span><span class="n">collections</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">colorbar</span>
<span class="n">cbar</span><span class="o">.</span><span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">'DSA Score'</span><span class="p">);</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s2">"Dynamic Similarity Analysis Score among Trajectories"</span><span class="p">);</span>
</pre></div>
</div>
</div>

</div>
<p><a class="reference external" href="https://github.com/neuromatch/NeuroAI_Course/tree/main/tutorials/W1D3_ComparingArtificialAndBiologicalNetworks/solutions/W1D3_Tutorial5_Solution_0467919d.py"><em>Click for solution</em></a></p>
<p><em>Example output:</em></p>
<a class="reference internal image-reference" href="https://raw.githubusercontent.com/neuromatch/NeuroAI_Course/main/tutorials/W1D3_ComparingArtificialAndBiologicalNetworks/static/W1D3_Tutorial5_Solution_0467919d_0.png"><img align="center" alt="Solution hint" class="align-center" src="https://raw.githubusercontent.com/neuromatch/NeuroAI_Course/main/tutorials/W1D3_ComparingArtificialAndBiologicalNetworks/static/W1D3_Tutorial5_Solution_0467919d_0.png" style="width: 784.0px; height: 575.0px;"/></a>
<p>What do you see now? We now see a much more sensible result. The DSA scores have now correctly identified that <code class="docutils literal notranslate"><span class="pre">Oval</span></code> and <code class="docutils literal notranslate"><span class="pre">Circle</span></code> are very dynamically similar! They have the highest color score according to the colorbar on the side. As is always good practice in science, letâ€™s have a look inside the <code class="docutils literal notranslate"><span class="pre">similarities</span></code> variable to look at the exact values and confirm what we see in the figure above.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">similarities</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>array([[0.        , 0.00133721, 0.08549269],
       [0.00133721, 0.        , 0.08439462],
       [0.08549269, 0.08439462, 0.        ]])
</pre></div>
</div>
</div>
</div>
</section>
<section id="comparison-with-rsa">
<h2>Comparison with RSA<a class="headerlink" href="#comparison-with-rsa" title="Permalink to this heading">#</a></h2>
<p>At the start of this exercise, we saw three different trajectories and pointed out that the random walk and oval shapes were most similar from a geometric perspective, both ellipse-like but not similar in their dynamic similarity. To better show the difference between DSA and RSA, we encourage you to run another comparison where we consider each time step to be a pair in the X,Y space and we will look at the the similarity between of <code class="docutils literal notranslate"><span class="pre">Oval</span></code> with both <code class="docutils literal notranslate"><span class="pre">Circle</span></code> and <code class="docutils literal notranslate"><span class="pre">Walk</span></code>. If our understanding is correct, then RSA should indicate a higher geometric similarity between (<code class="docutils literal notranslate"><span class="pre">Oval</span></code> and <code class="docutils literal notranslate"><span class="pre">Walk</span></code>) than with (<code class="docutils literal notranslate"><span class="pre">Oval</span></code> and <code class="docutils literal notranslate"><span class="pre">Circle</span></code>).</p>
</section>
</section>
<hr class="docutils"/>
<section class="tex2jax_ignore mathjax_ignore" id="bonus-representational-geometry-of-recurrent-models">
<h1>(Bonus) Representational Geometry of Recurrent Models<a class="headerlink" href="#bonus-representational-geometry-of-recurrent-models" title="Permalink to this heading">#</a></h1>
<p>Transformations of representations can occur across space and time, e.g., layers of a neural network and steps of recurrent computation. Weâ€™ve looked at the temporal dimension today and earlier today in the other tutorials we looked mainly at spatial representations.</p>
<p>Just as the layers in a feedforward DNN can change the representational geometry to perform a task, steps in a recurrent network can reuse the same layer to reach the same computational depth.</p>
<p>In this section, we look at a very simple recurrent network with only 2650 trainable parameters.</p>
<p>Here is a diagram of this network:</p>
<p><img alt="Recurrent convolutional neural network" src="https://github.com/neuromatch/NeuroAI_Course/blob/main/tutorials/W1D3_ComparingArtificialAndBiologicalNetworks/static/rcnn_tutorial.png?raw=true"/></p>
<section id="grab-a-recurrent-model">
<h2>Grab a recurrent model<a class="headerlink" href="#grab-a-recurrent-model" title="Permalink to this heading">#</a></h2>
<div class="cell tag_hide-input docutils container">
<details class="hide above-input">
<summary aria-label="Toggle hidden content">
<span class="collapsed">Show code cell source</span>
<span class="expanded">Hide code cell source</span>
</summary>
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># @title Grab a recurrent model</span>

<span class="n">args</span> <span class="o">=</span> <span class="n">build_args</span><span class="p">()</span>
<span class="n">train_loader</span><span class="p">,</span> <span class="n">test_loader</span> <span class="o">=</span> <span class="n">fetch_dataloaders</span><span class="p">(</span><span class="n">args</span><span class="p">)</span>
<span class="n">path</span> <span class="o">=</span> <span class="s2">"recurrent_model.pth"</span>
<span class="n">model_recurrent</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">map_location</span><span class="o">=</span><span class="n">args</span><span class="o">.</span><span class="n">device</span><span class="p">,</span> <span class="n">weights_only</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
</pre></div>
</div>
</div>
</details>
</div>
<p><br/>We can first look at the computational steps in this network. As we see below, the <code class="docutils literal notranslate"><span class="pre">conv2</span></code> operation is repeated for 5 times.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">train_nodes</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">get_graph_node_names</span><span class="p">(</span><span class="n">model_recurrent</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">'The computational steps in the network are: </span><span class="se">\n</span><span class="s1">'</span><span class="p">,</span> <span class="n">train_nodes</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>The computational steps in the network are: 
 ['input', 'conv1', 'conv2', 'add', 'relu', 'conv2_1', 'add_1', 'relu_1', 'conv2_2', 'add_2', 'relu_2', 'conv2_3', 'add_3', 'relu_3', 'conv2_4', 'add_4', 'relu_4', 'readout.dropout', 'readout.avgpool', 'readout.flatten', 'readout.linear', 'softmax']
</pre></div>
</div>
</div>
</div>
<p>Plotting the RDMs after each application of the <code class="docutils literal notranslate"><span class="pre">conv2</span></code> operation shows the same progressive emergence of the blockwise structure around the diagonal, mediating the correct classification in this task.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">imgs</span><span class="p">,</span> <span class="n">labels</span> <span class="o">=</span> <span class="n">sample_images</span><span class="p">(</span><span class="n">test_loader</span><span class="p">,</span> <span class="n">n</span><span class="o">=</span><span class="mi">20</span><span class="p">)</span>
<span class="n">return_layers</span> <span class="o">=</span> <span class="p">[</span><span class="s1">'conv2'</span><span class="p">,</span> <span class="s1">'conv2_1'</span><span class="p">,</span> <span class="s1">'conv2_2'</span><span class="p">,</span> <span class="s1">'conv2_3'</span><span class="p">,</span> <span class="s1">'conv2_4'</span><span class="p">]</span>
<span class="n">model_features</span> <span class="o">=</span> <span class="n">extract_features</span><span class="p">(</span><span class="n">model_recurrent</span><span class="p">,</span> <span class="n">imgs</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">device</span><span class="p">),</span> <span class="n">return_layers</span><span class="p">)</span>

<span class="n">rdms</span><span class="p">,</span> <span class="n">rdms_dict</span> <span class="o">=</span> <span class="n">calc_rdms</span><span class="p">(</span><span class="n">model_features</span><span class="p">)</span>
<span class="n">plot_rdms</span><span class="p">(</span><span class="n">rdms_dict</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../../../_images/3dfdd1374f46cc036bea98d4100ecd2654616d4e60f7265adb13097d7f78f16b.png" src="../../../_images/3dfdd1374f46cc036bea98d4100ecd2654616d4e60f7265adb13097d7f78f16b.png"/>
</div>
</div>
<p>We can also look at how the different dimensionality reduction techniques capture the dynamics of changing geometry.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">return_layers</span> <span class="o">=</span> <span class="p">[</span><span class="s1">'conv2'</span><span class="p">,</span> <span class="s1">'conv2_1'</span><span class="p">,</span> <span class="s1">'conv2_2'</span><span class="p">,</span> <span class="s1">'conv2_3'</span><span class="p">,</span> <span class="s1">'conv2_4'</span><span class="p">]</span>

<span class="n">imgs</span><span class="p">,</span> <span class="n">labels</span> <span class="o">=</span> <span class="n">sample_images</span><span class="p">(</span><span class="n">test_loader</span><span class="p">,</span> <span class="n">n</span><span class="o">=</span><span class="mi">50</span><span class="p">)</span> <span class="c1">#grab 500 samples from the test set</span>
<span class="n">model_features</span> <span class="o">=</span> <span class="n">extract_features</span><span class="p">(</span><span class="n">model_recurrent</span><span class="p">,</span> <span class="n">imgs</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">device</span><span class="p">),</span> <span class="n">return_layers</span><span class="p">)</span>

<span class="n">plot_dim_reduction</span><span class="p">(</span><span class="n">model_features</span><span class="p">,</span> <span class="n">labels</span><span class="p">,</span> <span class="n">transformer_funcs</span> <span class="o">=</span><span class="p">[</span><span class="s1">'PCA'</span><span class="p">,</span> <span class="s1">'MDS'</span><span class="p">,</span> <span class="s1">'t-SNE'</span><span class="p">])</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../../../_images/1fe44334811566f34f2f3a2197ba178a7f9b7177155ecb97c49e43546a202f46.png" src="../../../_images/1fe44334811566f34f2f3a2197ba178a7f9b7177155ecb97c49e43546a202f46.png"/>
</div>
</div>
</section>
<section id="representational-geometry-paths-for-recurrent-models">
<h2>Representational geometry paths for recurrent models<a class="headerlink" href="#representational-geometry-paths-for-recurrent-models" title="Permalink to this heading">#</a></h2>
<p>We can look at the modelâ€™s recurrent computational steps as a path in the representational geometry space.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">imgs</span><span class="p">,</span> <span class="n">labels</span> <span class="o">=</span> <span class="n">sample_images</span><span class="p">(</span><span class="n">test_loader</span><span class="p">,</span> <span class="n">n</span><span class="o">=</span><span class="mi">50</span><span class="p">)</span> <span class="c1">#grab 500 samples from the test set</span>
<span class="n">model_features_recurrent</span> <span class="o">=</span> <span class="n">extract_features</span><span class="p">(</span><span class="n">model_recurrent</span><span class="p">,</span> <span class="n">imgs</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">device</span><span class="p">),</span> <span class="n">return_layers</span><span class="o">=</span><span class="s1">'all'</span><span class="p">)</span>

<span class="c1">#rdms, rdms_dict = calc_rdms(model_features)</span>
<span class="n">features</span> <span class="o">=</span> <span class="p">{</span><span class="s1">'recurrent model'</span><span class="p">:</span> <span class="n">model_features_recurrent</span><span class="p">}</span>
<span class="n">model_colors</span> <span class="o">=</span> <span class="p">{</span><span class="s1">'recurrent model'</span><span class="p">:</span> <span class="s1">'y'</span><span class="p">}</span>

<span class="n">rep_path</span><span class="p">(</span><span class="n">features</span><span class="p">,</span> <span class="n">model_colors</span><span class="p">,</span> <span class="n">labels</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../../../_images/b1c49f586368006a1fa1ae385bad5e9abbd827129c4964b581165e80b15a87b7.png" src="../../../_images/b1c49f586368006a1fa1ae385bad5e9abbd827129c4964b581165e80b15a87b7.png"/>
</div>
</div>
<p>We can also look at the paths taken by the feedforward and the recurrent models and compare them.</p>
<p>If you recall back to Tutorial 2, we compared a standard feedward modelâ€™s representations. We can extend our analysis of the analysis of the recurrent modelâ€™s representations by making a side-by-side comparison. We can also look at the paths taken by the feedforward and the recurrent models and compare them. What we see above in the case of the recurrent model is the fast-shifting path through the geometric space from inputs to labels. This illustration serves to show that models take many different paths and can have very diverse underlying mechanisms but still arrive at a superficially similar output at the end of training.</p>
<section id="id1">
<h3>Submit your feedback<a class="headerlink" href="#id1" title="Permalink to this heading">#</a></h3>
<div class="cell tag_hide-input docutils container">
<details class="hide above-input">
<summary aria-label="Toggle hidden content">
<span class="collapsed">Show code cell source</span>
<span class="expanded">Hide code cell source</span>
</summary>
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># @title Submit your feedback</span>
<span class="n">content_review</span><span class="p">(</span><span class="sa">f</span><span class="s2">"</span><span class="si">{</span><span class="n">feedback_prefix</span><span class="si">}</span><span class="s2">_recurrent_models"</span><span class="p">)</span>
</pre></div>
</div>
</div>
</details>
<div class="cell_output docutils container">
<script type="application/vnd.jupyter.widget-view+json">{"version_major": 2, "version_minor": 0, "model_id": "58d4f9d50c1f4fd89e731bc95fe9c5bc"}</script></div>
</div>
</section>
</section>
</section>
<section class="tex2jax_ignore mathjax_ignore" id="the-big-picture">
<h1>The Big Picture<a class="headerlink" href="#the-big-picture" title="Permalink to this heading">#</a></h1>
<p>Today, youâ€™ve looked at what it means to measure representations from different systems. These systems can be of the same type (multiple brain systems, multiple artificial models) as well as with representations between these systems. In NeuroAI, weâ€™re especially interested in such comparisons, comparing representational systems in deep learning networks, for instance, to brain recordings recorded while those biological systems experienced / perceived the same set of stimuli. Comparisons can be geometric / spatial or they can be temporal. Today, we looked at Dynamic Similarity Analysis, a method used to be able to capture the dependencies among trajectories, not just capturing the similarity of the full temporal sequence upon completion of the temporal sequence. Itâ€™s often important to take into account multiple dimensions of representational similarity. A combination of tools is definitely required in the NeuroAI researcherâ€™s toolkit. We hope you have many chances to use these tools in your future work as NeuroAI researchers.</p>
</section>
<script type="text/x-thebe-config">
    {
        requestKernel: true,
        binderOptions: {
            repo: "binder-examples/jupyter-stacks-datascience",
            ref: "master",
        },
        codeMirrorConfig: {
            theme: "abcdef",
            mode: "python"
        },
        kernelOptions: {
            name: "python3",
            path: "./tutorials/W1D3_ComparingArtificialAndBiologicalNetworks/student"
        },
        predefinedOutput: true
    }
    </script>
<script>kernelName = 'python3'</script>
</article>
<footer class="bd-footer-article">
<!-- Previous / next buttons -->
<div class="prev-next-area">
<a class="left-prev" href="W1D3_Tutorial4.html" id="prev-link" title="previous page">
<i class="fa-solid fa-angle-left"></i>
<div class="prev-next-info">
<p class="prev-next-subtitle">previous</p>
<p class="prev-next-title">(Bonus) Tutorial 4: Representational geometry &amp; noise</p>
</div>
</a>
<a class="right-next" href="W1D3_Outro.html" id="next-link" title="next page">
<div class="prev-next-info">
<p class="prev-next-subtitle">next</p>
<p class="prev-next-title">Daily survey</p>
</div>
<i class="fa-solid fa-angle-right"></i>
</a>
</div>
</footer>
</div>
<div class="bd-sidebar-secondary bd-toc">
<div class="toc-item">
<div class="tocsection onthispage">
<i class="fa-solid fa-list"></i> On this page
</div>
<nav class="page-toc" id="bd-toc-nav">
<ul class="visible nav section-nav flex-column">
<li class="toc-h1 nav-item toc-entry">
<a class="reference internal nav-link" href="#">
   Tutorial 5: Dynamical Similarity Analysis (DSA)
  </a>
<ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry">
<a class="reference internal nav-link" href="#install-and-import-feedback-gadget">
     Install and import feedback gadget
    </a>
</li>
<li class="toc-h2 nav-item toc-entry">
<a class="reference internal nav-link" href="#helper-functions">
     Helper functions
    </a>
</li>
<li class="toc-h2 nav-item toc-entry">
<a class="reference internal nav-link" href="#helper-functions-bonus-section">
     Helper functions (Bonus Section)
    </a>
</li>
<li class="toc-h2 nav-item toc-entry">
<a class="reference internal nav-link" href="#plotting-functions-bonus">
     Plotting functions (Bonus)
    </a>
</li>
<li class="toc-h2 nav-item toc-entry">
<a class="reference internal nav-link" href="#data-retrieval">
     Data retrieval
    </a>
</li>
<li class="toc-h2 nav-item toc-entry">
<a class="reference internal nav-link" href="#figure-settings">
     Figure settings
    </a>
</li>
<li class="toc-h2 nav-item toc-entry">
<a class="reference internal nav-link" href="#set-device-gpu-or-cpu">
     Set device (GPU or CPU)
    </a>
</li>
<li class="toc-h2 nav-item toc-entry">
<a class="reference internal nav-link" href="#load-slides">
     Load Slides
    </a>
</li>
</ul>
</li>
<li class="toc-h1 nav-item toc-entry">
<a class="reference internal nav-link" href="#intro">
   Intro
  </a>
<ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry">
<a class="reference internal nav-link" href="#video-1-dynamical-similarity-analysis">
     Video 1: Dynamical Similarity Analysis
    </a>
</li>
<li class="toc-h2 nav-item toc-entry">
<a class="reference internal nav-link" href="#submit-your-feedback">
     Submit your feedback
    </a>
</li>
<li class="toc-h2 nav-item toc-entry">
<a class="reference internal nav-link" href="#section-1-visualization-of-three-temporal-sequences">
     Section 1: Visualization of Three Temporal Sequences
    </a>
</li>
<li class="toc-h2 nav-item toc-entry">
<a class="reference internal nav-link" href="#multi-way-comparison">
     Multi-way Comparison
    </a>
</li>
<li class="toc-h2 nav-item toc-entry">
<a class="reference internal nav-link" href="#dsa-hyperparameters-n-delays-and-delay-interval">
     DSA Hyperparameters (
     <code class="docutils literal notranslate">
<span class="pre">
       n_delays
      </span>
</code>
     and
     <code class="docutils literal notranslate">
<span class="pre">
       delay_interval
      </span>
</code>
     )
    </a>
</li>
<li class="toc-h2 nav-item toc-entry">
<a class="reference internal nav-link" href="#comparison-with-rsa">
     Comparison with RSA
    </a>
</li>
</ul>
</li>
<li class="toc-h1 nav-item toc-entry">
<a class="reference internal nav-link" href="#bonus-representational-geometry-of-recurrent-models">
   (Bonus) Representational Geometry of Recurrent Models
  </a>
<ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry">
<a class="reference internal nav-link" href="#grab-a-recurrent-model">
     Grab a recurrent model
    </a>
</li>
<li class="toc-h2 nav-item toc-entry">
<a class="reference internal nav-link" href="#representational-geometry-paths-for-recurrent-models">
     Representational geometry paths for recurrent models
    </a>
<ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry">
<a class="reference internal nav-link" href="#id1">
       Submit your feedback
      </a>
</li>
</ul>
</li>
</ul>
</li>
<li class="toc-h1 nav-item toc-entry">
<a class="reference internal nav-link" href="#the-big-picture">
   The Big Picture
  </a>
</li>
</ul>
</nav>
</div>
</div>
</div>
<footer class="bd-footer-content">
<div class="bd-footer-content__inner">
<div class="bd-footer-content__inner container">
<div class="footer-item">
<p class="component-author">
By Neuromatch
</p>
</div>
<div class="footer-item">
</div>
<div class="footer-item">
<p class="last-updated">
Last updated on None.<br/>
</p>
</div>
<div class="footer-item">
<div class="extra_footer">
<div>
<a href="http://creativecommons.org/licenses/by/4.0/"><img src="https://i.creativecommons.org/l/by/4.0/88x31.png"/></a>
<a href="https://opensource.org/licenses/BSD-3-Clause"><img src="https://camo.githubusercontent.com/9b9ea65d95c9ef878afa1987df65731d47681336/68747470733a2f2f696d672e736869656c64732e696f2f707970692f6c2f736561626f726e2e737667"/></a>
The contents of this repository are shared under the <a href="http://creativecommons.org/licenses/by/4.0/">Creative Commons Attribution 4.0 International License</a>.
Software elements are additionally licensed under the <a href="https://opensource.org/licenses/BSD-3-Clause">BSD (3-Clause) License</a>.
</div>
</div>
</div>
</div>
</div>
</footer>
</main>
</div>
</div>
<!-- Scripts loaded after <body> so the DOM is not blocked -->
<script src="../../../_static/scripts/bootstrap.js?digest=796348d33e8b1d947c94"></script>
<script src="../../../_static/scripts/pydata-sphinx-theme.js?digest=796348d33e8b1d947c94"></script>
</body>
</html>